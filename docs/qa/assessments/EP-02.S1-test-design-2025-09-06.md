# 测试设计：Story EP-02.S1 新增入住记录（Tenancy Create）

日期：2025-09-06  
设计者：Quinn（Test Architect）

## 测试策略概览
- 目标：覆盖故事 EP-02-S1 的全部验收标准（AC1–AC6），在合适层级（Unit/Integration/E2E）进行高效验证，避免重复测试。
- 总计场景：16  
  - Unit：2（12.5%）  
  - Integration：7（43.75%）  
  - E2E：7（43.75%）  
- 优先级分布：P0=4，P1=10，P2=2

## 按验收标准的测试场景

### AC1 成功创建
- 描述：满足 `patientId | id_card` 其一 + `checkInDate` 必填；成功返回 `{ _id }`，前端提示并返回列表。

| ID | Level | Priority | 测试 | 依据与理由 |
|---|---|---|---|---|
| EP-02.S1-UNIT-001 | unit | P0 | 参数基本合法性：存在 patientId 或 id_card，存在 checkInDate | 纯字段校验，快速反馈 |
| EP-02.S1-INT-001 | integration | P0 | 创建最小必需集：`{ patientId, checkInDate }` 持久化且写入 `createdAt` | 涉及 DB | 
| EP-02.S1-INT-002 | integration | P0 | 幂等：同一 `clientToken` 重复提交返回相同 `_id` | 幂等策略关键 | 
| EP-02.S1-E2E-001 | e2e | P1 | 表单提交成功→Toast→返回上一页→列表刷新并按 `checkInDate desc` 排序 | 核心用户路径 |

### AC2 日期关系
- 描述：`checkOutDate < checkInDate` 返回 `E_VALIDATE`；等于或大于通过。

| ID | Level | Priority | 测试 | 依据与理由 |
|---|---|---|---|---|
| EP-02.S1-UNIT-002 | unit | P0 | `checkOutDate < checkInDate` 校验失败 | 纯逻辑校验 |
| EP-02.S1-INT-003 | integration | P1 | `checkOutDate == checkInDate` 通过并持久化 | 边界值 |
| EP-02.S1-E2E-002 | e2e | P1 | 前端内联错误文案 + Toast | 体验与错误映射 |

### AC3 冲突提醒（软提示，不阻断）
- 描述：同日同床位可能已存在记录时，提交前提示确认，允许继续。

| ID | Level | Priority | 测试 | 依据与理由 |
|---|---|---|---|---|
| EP-02.S1-INT-004 | integration | P1 | `tenancies.list(filter:{ room, bed, checkInDate })` 能返回已存在记录 | 预检过滤正确性 |
| EP-02.S1-E2E-003 | e2e | P1 | 提交前命中冲突→弹窗→取消时不中止 | 软提示-取消分支 |
| EP-02.S1-E2E-004 | e2e | P1 | 提交前命中冲突→弹窗→确认后仍可创建成功 | 软提示-继续分支 |

### AC4 身份关联（未达成，测试先设计）
- 描述：仅提供 `id_card` 且匹配到患者时，自动回填 `patientId`；未匹配也允许创建并保留 `id_card`。

| ID | Level | Priority | 测试 | 依据与理由 |
|---|---|---|---|---|
| EP-02.S1-INT-005 | integration | P1 | 仅 `id_card` 且命中 Patients→创建记录已回填 `patientId` | 交互 DB，回填逻辑 |
| EP-02.S1-INT-006 | integration | P2 | 仅 `id_card` 未命中→允许创建且记录 `id_card` 供后续回填 | 容错路径 |

说明：当前实现未落地该逻辑，测试用例标记待启用（pending）。

### AC5 在住状态（未达成，测试先设计）
- 描述：创建成功且 `checkOutDate` 为空，返回档案详情时显示“在住”（以最近未退住记录判断）。

| ID | Level | Priority | 测试 | 依据与理由 |
|---|---|---|---|---|
| EP-02.S1-INT-007 | integration | P1 | 对指定 `patientId` 查询最近未退住记录可获取 | 数据可获取性 |
| EP-02.S1-E2E-005 | e2e | P1 | 患者详情页显示“在住”徽标/文案 | 端到端体验 |

说明：当前页面未实现显示，测试用例标记待启用（pending）。

### AC6 体验与 A11y
- 描述：加载/提交态、错误提示、触控和对比度达到规范；性能端到端达标。

| ID | Level | Priority | 测试 | 依据与理由 |
|---|---|---|---|---|
| EP-02.S1-E2E-006 | e2e | P2 | 提交按钮 Loading，重复点击无副作用 | 体验保障 |
| EP-02.S1-E2E-007 | e2e | P1 | 端到端 P95 ≤ 800ms（后端 ≤ 500ms），采样 30 次 | 性能门槛 |

## 风险覆盖
- R-并发冲突：仅前端软提示，后端无强约束。相关用例：EP-02.S1-INT-004、EP-02.S1-E2E-003、EP-02.S1-E2E-004。建议在监控中观察并发重复率，必要时升级强校验或唯一占位。
- R-关联缺失：AC4 未实现，存在孤立记录风险。建议尽快落地回填逻辑并启用 EP-02.S1-INT-005/006。

## 建议执行顺序
1. P0 单元（EP-02.S1-UNIT-001/002）
2. P0 集成（EP-02.S1-INT-001/002）
3. P1 E2E 核心路径（EP-02.S1-E2E-001/002/003/004）
4. P1 集成（EP-02.S1-INT-003/004/007）
5. P2 与未落地关联用例（待启用）

## 质量校验清单
- [x] 每个 AC 至少 1 个测试
- [x] 测试层级合理（尽量左移）
- [x] 无明显重复覆盖
- [x] 优先级贴合业务风险
- [x] 测试 ID 命名规范
- [x] 场景原子、可独立执行
