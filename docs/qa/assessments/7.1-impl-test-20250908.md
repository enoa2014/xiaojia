# Implementation Test Report: Story 7.1 Tokens 与工具类全局化（P0）

- Story: docs/stories/7.1.tokens-and-utilities-globalization.md
- Date: 2025-09-08
- Mode: 实测+静态扫描（命令见文末）

## 执行摘要
- 结论：CONCERNS（部分通过）。
- 通过：AC-1（扩充 tokens.wxss）、AC-2（全局引入 + 工具类基线）。
- 未通过/部分：AC-3（目标页面硬编码仍大量存在，tenancies/form 基本无硬编码），AC-4（Tokens 文档未补“工具类映射”章节）。

## 验收对照
- AC-1 Tokens 扩充：
  - 发现：miniprogram/styles/tokens.wxss 覆盖品牌/语义/灰阶/角色、间距、圆角、阴影、动效、z-index、透明度等（见文件片段）。
  - 判定：PASS。
- AC-2 全局引入与工具类：
  - 发现：miniprogram/app.wxss 顶部 `@import "styles/tokens.wxss";`，并提供 `.text-* / .bg-* / .shadow-* / .rounded-* / .p-* / .px-* / .py-* / .m-* / .mx-* / .my-*` 等工具类。
  - 判定：PASS。
- AC-3 首批替换：
  - 目标：activities/form.*、tenancies/form.*、stats/index.*。
  - 发现：
    - activities/form.wxss：保留大量渐变与十六进制色；仅个别使用 var()；未按工具类/令牌化统一。
    - tenancies/form.wxss：未检出明显十六进制硬编码（良好）。
    - stats/index.wxss：大量十六进制硬编码与渐变（需替换）。
  - 判定：PARTIAL（tenancies/form 达标，其余未达标）。
- AC-4 文档更新（工具类映射）：
  - 发现：docs/uiux/design-system/tokens.md 未追加“工具类映射”章节。
  - 判定：FAIL。

## 证据摘要
- tokens 覆盖（文件头部）：miniprogram/styles/tokens.wxss（品牌/语义/灰阶/角色/间距/圆角/阴影/动效/z-index/透明度等）。
- app 全局引入与工具类：miniprogram/app.wxss（@import + 多组 utilities）。
- 硬编码扫描（命令输出样例）：
  - activities/form.wxss：多处 `linear-gradient(135deg, #...)`。
  - stats/index.wxss：多处 `#3B82F6/#1D4ED8/...`。
  - tenancies/form.wxss：未发现十六进制硬编码。

## 风险与影响
- 风险：页面间视觉不一致持续存在；主题切换联动不足；后续替换工作量集中在 activities/form 与 stats/index。
- 影响：UI 统一性与可维护性目标未完全实现；需要一轮替换提交。

## 修复建议（P0内可完成）
1) activities/form.wxss：
   - 将导航头与主要高亮颜色改为 `.bg-primary-600/.text-on-primary/.shadow-sm` 或对应 var()；渐变用 `--gradient-primary` 或按 tokens 色板定义。
2) stats/index.wxss：
   - KPI 卡/徽章/趋势文本等采用 `.text-success/.text-danger/.text-secondary`、`.bg-gray-50` 等工具类。
   - 渐变类统一使用 tokens 主/辅色，避免裸十六进制。
3) 文档：
   - 在 docs/uiux/design-system/tokens.md 增补“工具类映射”表（text/bg/shadow/rounded/padding/margin）。

## 执行命令（复现）
```sh
# 查看 tokens 与 app.wxss 设置
sed -n '1,120p' miniprogram/styles/tokens.wxss
sed -n '1,160p' miniprogram/app.wxss

# 扫描工具类是否存在
rg -n "\\.(text-primary|text-secondary|bg-primary|bg-subtle|shadow-sm|shadow-md|rounded-md|p-6|px-6|py-6)\\b" miniprogram/app.wxss

# 扫描目标页面十六进制硬编码（需替换）
rg -n "#([0-9a-fA-F]{3,6})" miniprogram/pages/activities/form.wxss
rg -n "#([0-9a-fA-F]{3,6})" miniprogram/pages/tenancies/form.wxss
rg -n "#([0-9a-fA-F]{3,6})" miniprogram/pages/stats/index.wxss
```

## 结论
- Gate 建议：CONCERNS（实施后需复检）。
- 需要补交：activities/form 与 stats/index 的替换提交 + tokens 文档映射表。

