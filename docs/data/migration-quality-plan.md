# 数据迁移与质量保障计划（M&Q Plan）

本计划用于指导“入住登记表（prepare/b.xlsx）→ 云数据库（Patients/Tenancies）”的首轮数据迁移，确保结果可核对、可回滚、可追溯。与《docs/data/init-from-b-reg.md》配套实施：前者定义执行细节与规则，本计划定义流程管控与质量门禁。

## 1. 目标与范围
- 目标：一次性导入历史入住数据，建立患者与入住台账数据基础，误差可控且可追溯。
- 范围：patients/tenancies 两域初始数据；不含退住补录与历史校正（后续迭代）。

## 2. 数据源与映射
- 源：`prepare/b.xlsx`（COS 路径与本地同源）。
- 映射：详见《docs/data/init-from-b-reg.md》的“源数据与字段映射”。
- 重要派生：`id_card_tail`（末4位）、`Tenancies.extra.admitPersons`（原样保留）。

## 3. 清洗与标准化规则
- 日期：支持 Excel 数字与文本日期，统一转 ISO `YYYY-MM-DD`；无法解析→`null` 并计数。
- 文本：去首尾空格；中文/英文逗号、顿号等分隔符统一；超长字段截断（备注≤500）。
- 手机号/身份证：从合并字段解析；手机号 `^1[3-9]\d{9}$`；身份证 18 位+校验位。
- 枚举：性别/民族暂保留原值，后续标准化。

## 4. 去重与关联策略
- 患者唯一：`id_card` 全局唯一（索引约束）。
- 无证档案：允许创建但不自动合并；后续按“`name + birthDate + motherPhone` 完全一致”作为人工合并候选。
- 入住关联：优先使用 `id_card` 关联 `patientId`；缺失时暂存 `patientKey`，导入后批量回填。

## 5. 执行流程（建议）
1) 预检（Preflight）
- 检查 b.xlsx 表头与样例行；估算有效行数 N、唯一身份证数 U。
- 校验数据库集合存在与必要索引（Patients.id_card 唯一）。
2) 演练（Dry-run）
- 使用相同函数在“演练库/命名空间”或新集合后缀 `_dry` 导入，生成试算统计（rows/U/null 日期数）。
3) 正式导入（Batch 标记）
- 生成 `batchId = <yyyymmdd-HHMM>-b.xlsx`；所有写入记录增加 `batchId` 字段便于追踪与回滚。
- 调用 `import-xlsx.fromCos(fileID)`，记录返回统计与 requestId。
4) 事后校验（Post-check）
- 统计核对（见第6节）；生成导入报告并归档到 `AuditLogs`。

## 6. 质检与核对
A. 自动化校验
- 计数：`Tenancies.count(batchId) ≈ rows`；`Patients.count(batchId) ≈ 唯一身份证数U`（无证档案除外）。
- 约束：`Patients.id_card` 唯一；`Tenancies.checkOutDate >= checkInDate`（非空时）。
- 异常汇总：
  - 日期解析失败条数；
  - 无 `id_card` 的患者与无法回填 `patientId` 的入住记录清单；
  - 可能冲突（同日同床位）条目数（若启用检测）。
B. 抽样复核（Sampling QA）
- 抽样规模：min(30, N 的 5%)，若 N≥2000，分层抽样（按月份/医院分层）。
- 口径：姓名/证件尾4位/入住日期/母亲信息各字段随机比对原表，允许≤1 处非关键轻微差异（如空格）且需可解释。
- 接受标准（AQL）：
  - 关键字段（姓名/身份证/入住日期）错误率 ≤ 1%；
  - 其他字段错误率 ≤ 3%；超标需复盘并选择回滚或二次清洗。
C. 对账
- 与历史台账总数/区间统计比对（若有）：差异>5% 需复盘说明。

## 7. 回滚与恢复
- 快照：导入前导出 `Patients/Tenancies` 关键字段快照或记录当前总数。
- 批次回滚：按 `batchId` 物理删除新增记录；如已发生二次写入，采用“逻辑删除 `deletedAt`”策略并在接口层过滤。
- 重跑：更新清洗规则或源表后，以新 `batchId` 重新导入；保留旧批次用于审计。

## 8. 风险与应对
- 源表字段漂移：预检对比表头并中止；补齐映射后再跑。
- 日期/证件异常：记录异常行并进入人工处理清单，不阻塞整体导入。
- 重复导入：依赖 `Patients.id_card` 唯一与 `batchId` 识别重复；必要时先回滚旧批次。

## 9. 角色与责任
- Owner：后端；Reviewer：架构/PO/QA；协作：数据提供方（台账）
- 产出：导入报告（统计/抽样/异常清单/结论）、回滚脚本（如执行）

## 10. 时间线与门禁
- 演练→复核→正式导入→复核→验收；任一门禁失败（AQL/计数/对账）停止上线并复盘。

## 11. 附：质检清单（示例）
- [ ] 表头与样例复核通过
- [ ] 必要索引存在且生效
- [ ] 导入统计与预估一致（±5%）
- [ ] 日期解析失败率 ≤ 2%
- [ ] 无证档案占比 ≤ 10%（可接受范围内）
- [ ] 关键字段抽样错误率 ≤ 1%
- [ ] 导入报告归档到 AuditLogs
- [ ] 回滚预案演练一次（演练库）
