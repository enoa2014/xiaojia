# Story 7.15: 审批/审计页面路由与守卫（P2）

## Status
Completed

## Story
作为管理员/审计人员，我希望在小程序中集中查看权限申请、审批流程与审计日志，且仅在具备相应角色时可访问；作为开发者，我希望通过统一路由与守卫减少越权风险。

## Acceptance Criteria
1. 新增 `pages/approvals/index` 与（可选）`pages/audits/index` 路由入口，Tab 位置或二级导航与 IA 一致。
2. 访问守卫：非管理员访问显示 `E_PERM` 统一提示与引导；管理员可加载列表与详情。
3. 统一空/错/加载状态组件；日志敏感信息脱敏显示。

## Tasks / Subtasks
- [x] 新页面与路由（AC: 1）
- [x] 守卫与权限提示（AC: 2）
- [x] 状态组件接入与脱敏（AC: 3）

## Dev Notes
- IA 设计（Source: docs/uiux/ia_design.md#权限管理-管理员专用）
- RBAC/ABAC（Source: docs/architecture/05-security-rbac.md、docs/data/field-masking-matrix.md）
- 错误码与文案（Source: docs/api/error-codes.md）

### Testing
- 普通用户进入 → 权限不足提示与引导正确。
- 管理员进入 → 列表/详情可见，日志敏感字段脱敏。

## Change Log
| Date       | Version | Description                                  | Author |
|------------|---------|----------------------------------------------|--------|
| 2025-09-08 | 0.1     | 初始草案                                     | BMAD   |
| 2025-09-08 | 0.2     | 通过 Story Draft Checklist，状态改为 Approved | BMAD   |
| 2025-09-09 | 1.0     | 实施完成 + QA通过（PO确认 Completed）         | PO     |

## Dev Agent Record

### Completion Notes
- ✅ **权限审批页面**: 创建完整的权限审批管理页面 (`/pages/approvals/index`)
  - 分离待审批和已处理请求的标签页切换
  - 支持批准/拒绝操作，包含二次确认
  - 权限检查：仅管理员可访问，其他角色显示权限不足提示
  - 统一状态组件：loading-skeleton、error-view、empty-state
- ✅ **审计日志页面**: 完全重构审计查询页面为功能完整的审计日志中心
  - 多维度筛选：操作类型、时间范围、操作人筛选
  - 敏感信息脱敏：目标信息、操作人ID等关键数据脱敏显示
  - 实时搜索：操作人筛选支持防抖搜索
  - 权限控制：仅管理员可访问审计日志
- ✅ **统一设计规范**: 完全符合UI设计系统tokens和components规范
  - 使用design tokens定义的颜色、字体、间距、圆角等
  - 集成统一状态组件和错误处理
  - 响应式设计适配移动端界面

### File List
- `miniprogram/pages/approvals/index.js/.json/.wxml/.wxss` - 权限审批页面
- `miniprogram/pages/audits/index.js/.json/.wxml/.wxss` - 审计日志页面（重构）
- `miniprogram/app.json` - 新增页面路由注册

### Technical Implementation
- **权限守卫**: 统一的用户权限检查逻辑，基于用户角色的访问控制
- **状态管理**: 统一的加载、错误、空数据状态处理模式
- **数据脱敏**: 审计日志中敏感信息的安全显示处理
- **UI规范**: 严格遵循design system的tokens和components规范
- **用户体验**: 支持下拉刷新、上拉加载、筛选搜索等交互

## QA Results
- Result: Passed
- Test Plan:
  - docs/qa/test-plan-empty-error.md（状态组件一致性）
  - docs/qa/test-plan-loading-skeleton.md（≤300ms 触发与淡出）
  - docs/qa/gates/EP-06.S3-rbac-enforcement.yml（RBAC 验证参考）
- QA Report: docs/qa/results/approvals-and-audits-qa-report-2025-09-09.md
- Notes:
  - 路由：`pages/approvals/index` 与 `pages/audits/index` 均已注册，入口从统计/管理区域可达
  - 守卫：两页均按 `admin` 访问；拒绝时统一空/错/权限提示（E_PERM 文案）
  - 状态：加载骨架/错误视图/空态统一；审计目标字段已脱敏（ID 尾 4 位）
  - 改进建议（非阻断）：
    - A11y：审批按钮/筛选器/日志项增加 aria-label；列表容器补 `role=region` 与 `aria-label`
    - 审批理由：拒绝操作建议支持填写原因并写入审计
    - 可追溯性：审批与审计记录通过 `requestId` 相关联（前端已打点，建议在后端 Gate 校验）
