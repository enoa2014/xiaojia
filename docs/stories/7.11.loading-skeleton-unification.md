# Story 7.11: Loading Skeleton 统一（≤300ms）（P1）

## Status
Completed

## Story
作为终端用户，我希望在弱网下各列表/详情页能迅速出现骨架屏，避免白屏与抖动；作为开发者，我希望统一 Skeleton 的样式与触发时序，降低心智负担。

## Acceptance Criteria
1. 新增 `miniprogram/components/loading-skeleton/`，提供列表型/详情型两种骨架模板。
2. 触发时序：请求发起 ≤300ms 出现骨架；数据返回后平滑过渡，不影响主题切换与滚动位置。
3. 至少接入两类页面：`patients/index`（列表）、`patients/detail`（详情）或等价页面。

## Tasks / Subtasks
- [x] 组件脚手架与两类模板（AC: 1）
- [x] 接入与时序控制（AC: 2,3）

## Dev Notes
- 性能与可用性（Source: docs/process/coding-standards.md#5-性能与可用性）
- Skeleton 规范（Source: docs/uiux/design-system/components.md#Toast-EmptyState-ErrorState-Skeleton）

### Testing
- 弱网模拟：300ms 内出现骨架；返回后无闪烁与跳变。
- 主题切换/切页返回后，骨架不残留。

## Change Log
| Date       | Version | Description                                  | Author |
|------------|---------|----------------------------------------------|--------|
| 2025-09-08 | 0.1     | 初始草案                                     | BMAD   |
| 2025-09-08 | 0.2     | 通过 Story Draft Checklist，状态改为 Approved | BMAD   |

## Dev Agent Record

### Agent Model Used
- claude-sonnet-4-20250514

### File List
- `/miniprogram/components/loading-skeleton/index.js` - 骨架屏组件逻辑（列表/详情/自定义类型）
- `/miniprogram/components/loading-skeleton/index.wxml` - 骨架屏模板结构
- `/miniprogram/components/loading-skeleton/index.wxss` - 骨架屏样式（shimmer/pulse动画+主题适配）
- `/miniprogram/components/loading-skeleton/index.json` - 组件配置
- `/miniprogram/pages/patients/index.js` - 列表页面骨架屏接入及300ms时序控制
- `/miniprogram/pages/patients/index.json` - 列表页面组件引用
- `/miniprogram/pages/patients/index.wxml` - 列表页面骨架屏元素
- `/miniprogram/pages/patients/detail.js` - 详情页面骨架屏接入及时序控制
- `/miniprogram/pages/patients/detail.json` - 详情页面组件引用
- `/miniprogram/pages/patients/detail.wxml` - 详情页面骨架屏元素

### Completion Notes
- ✅ 创建了统一的 loading-skeleton 组件，支持列表型、详情型和自定义类型
- ✅ 实现了 ≤300ms 触发时序控制：请求发起后300ms才显示骨架屏
- ✅ 支持平滑过渡：数据加载完成后骨架屏淡出，避免闪烁
- ✅ 完整的主题切换支持：深色/浅色模式自动适配
- ✅ 接入了患者列表页面（列表型）和患者详情页面（详情型）
- ✅ 添加了完善的清理机制：页面卸载时清理定时器

### Debug Log References
- 骨架屏组件使用 shimmer 和 pulse 两种动画效果
- 时序控制通过 setTimeout 实现，确保快速响应时不显示骨架屏
- 使用组件的 fadeOut 方法实现平滑过渡效果
- 在页面 onUnload 和数据加载 finally 块中添加定时器清理

### Change Log
| 文件 | 变更类型 | 描述 |
|------|---------|------|
| loading-skeleton/* | 新增组件 | 统一骨架屏组件，支持多种类型和动画 |
| patients/index.* | 功能增强 | 接入列表型骨架屏，300ms延迟显示 |
| patients/detail.* | 功能增强 | 接入详情型骨架屏，平滑过渡效果 |

## QA Results

- Result: Passed
- Test Plan: docs/qa/test-plan-loading-skeleton.md
- QA Report: docs/qa/results/loading-skeleton-qa-report-2025-09-09.md
- Notes:
  - 组件增加 A11y（role=status, aria-live=polite, aria-busy）
  - 患者列表/详情按 300ms 时序显示骨架并淡出，无闪烁；切页和主题切换无残留
