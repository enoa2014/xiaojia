# Story 7.17: 构建期令牌注入方案（P2）

## Status
Completed

## Story
作为前端开发者，我希望在构建期将设计 Tokens 注入到 WXSS 工具类与组件样式，缓解 WXSS 对 CSS 变量/媒体查询的限制，从而提升 Tokens 的落地一致性与维护效率。

## Acceptance Criteria
1. 设计并验证一条最小可用的构建流程（脚本或预处理），能将 `docs/uiux/design-system/tokens.md` 的配置注入到 `miniprogram/styles/tokens.wxss` 与工具类输出。
2. 本地构建命令可复现（如 `pnpm run build:tokens` 或集成到现有 build 流程），并在 README/文档中说明使用方法与注意事项。
3. 不改变运行时逻辑，不引入破坏性变更；失败时有兜底（保留上次成功产物）。

## Tasks / Subtasks
- [x] 调研与脚本原型（AC: 1）
- [x] 集成到构建流程（AC: 2）
- [x] 失败兜底与文档（AC: 3）

## Dev Notes
- 构建与脚本（Source: docs/architecture/18-package-scripts.md、package.json scripts）
- Tokens 定义（Source: docs/uiux/design-system/tokens.md）

### Testing
- 在不同 Tokens 取值下重新构建，验证工具类与页面渲染一致；失败情况下能回退。

## Change Log
| Date       | Version | Description                                  | Author |
|------------|---------|----------------------------------------------|--------|
| 2025-09-08 | 0.1     | 初始草案                                     | BMAD   |
| 2025-09-08 | 0.2     | 通过 Story Draft Checklist，状态改为 Approved | BMAD   |
| 2025-09-09 | 1.0     | 实施完成 + QA通过（PO确认 Completed）         | PO     |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
无需调试记录，开发过程顺利

### Completion Notes List
- ✅ 成功创建 `scripts/build-tokens.js` 脚本，可解析 tokens.md 中的设计令牌
- ✅ 脚本支持多种令牌类型：颜色、尺寸、阴影、动画、透明度等
- ✅ 集成到 package.json 构建流程，新增 `pnpm run build:tokens` 命令
- ✅ 实现失败兜底机制：验证令牌数量、检查关键令牌、自动恢复备份
- ✅ 更新 README.md 文档，说明使用方法和注意事项
- ✅ 验证完整流程：正常构建、失败恢复均工作正常

### File List
- scripts/build-tokens.js (new)
- package.json (modified - 添加 build:tokens 脚本)
- README.md (modified - 添加令牌构建说明)
- miniprogram/styles/tokens.wxss (modified - 脚本生成)

### Change Log
- 新增构建期令牌注入脚本
- 支持从 tokens.md 自动解析和注入设计令牌
- 实现完整的错误处理和恢复机制
- 集成到现有构建流程中

## QA Results

- Result: Passed
- Test Plan:
  - 手动执行脚本：`pnpm run build:tokens`（正常/故障场景）
  - 校验产物：`miniprogram/styles/tokens.wxss`（关键令牌/向后兼容保留段）
  - 故障兜底：临时破坏 tokens.md 触发回退，确认 `.backup` 恢复生效
- QA Report: docs/qa/results/build-time-token-injection-qa-report-2025-09-09.md
- Notes:
  - package.json 已提供 `build:tokens` 脚本；README 已补使用方法与注意事项
  - 脚本解析覆盖颜色/尺寸/阴影/动效/透明度等；验证关键令牌并在失败时恢复备份
  - 产物 `tokens.wxss` 包含向后兼容令牌与背景变量，便于渐进迁移
