# Story 7.7: 列表页 Empty/Error 组件统一接入（P0）

## Status
Completed

## Story
作为终端用户，我希望在列表无数据或出错时看到一致的空态/错误提示与明确的后续行动（CTA）；作为开发者，我希望以可复用组件统一文案与重试逻辑。

## Acceptance Criteria
1. 新增 `miniprogram/components/empty-state/` 与 `miniprogram/components/error-view/` 组件，分别用于“空态”和“错误”展示，含插画/文案/CTA。
2. 在列表型页面接入：`patients/index`、`services/index`、`activities/index`、`stats/index`（如适用）。
3. 错误文案通过 `mapError`（Source: docs/architecture/15-frontend-api-upload.md）映射错误码，提供“重试”或“反馈”。
4. 文档记录标准文案与使用示例。

## Tasks / Subtasks
- [ ] 空/错组件脚手架（AC: 1）
- [ ] 列表页接入（AC: 2,3）
- [ ] 文案与规范记录（AC: 4）

## Dev Notes
- 错误码映射（Source: docs/api/error-codes.md、docs/architecture/15-frontend-api-upload.md）
- A11y 与可用性（Source: docs/uiux/design-system/components.md#Toast-EmptyState-ErrorState-Skeleton、accessibility.md）

### Testing
- 模拟空数据：显示插画+友好文案+CTA。
- 模拟错误：从 `E_PERM/E_VALIDATE/E_INTERNAL` 映射正确文案，重试有效。

## Change Log
| Date       | Version | Description                                  | Author |
|------------|---------|----------------------------------------------|--------|
| 2025-09-08 | 0.1     | 初始草案                                     | BMAD   |
| 2025-09-08 | 0.2     | 通过 Story Draft Checklist，状态改为 Approved | BMAD   |

## Dev Agent Record

### 完成状态
✅ 所有任务已完成

### 实现详情

**空/错组件脚手架 (AC: 1)**
- ✅ 创建 `miniprogram/components/empty-state/` 组件：支持图标、标题、描述、主/次操作按钮、多种变体
- ✅ 创建 `miniprogram/components/error-view/` 组件：内置错误码映射、重试逻辑、反馈功能、详情展示
- ✅ 基于设计系统tokens实现样式，支持 `default`, `compact`, `search`, `error` 等变体
- ✅ 无障碍访问：合理的触摸区域、语义化元素、键盘导航支持

**列表页接入 (AC: 2,3)**
- ✅ `patients/index`: 替换自定义空状态为EmptyState组件
- ✅ `services/index`: 替换空状态和错误状态为统一组件，集成重试和反馈功能
- ✅ `activities/index`: 统一空状态和错误展示，支持搜索条件清除
- ✅ `stats/index`: 紧凑模式的空状态和错误处理
- ✅ 错误码映射：集成 `E_AUTH`, `E_PERM`, `E_VALIDATE`, `E_NOT_FOUND`, `E_CONFLICT`, `E_RATE_LIMIT`, `E_DEPENDENCY`, `E_INTERNAL` 的自动文案匹配

**文案与规范记录 (AC: 4)**
- ✅ 创建演示页面：`pages/empty-error-demo/` 展示所有用法和变体
- ✅ 标准错误码映射文档集成在ErrorView组件中
- ✅ 使用示例和最佳实践说明
- ✅ 支持自定义文案覆盖默认映射

### 错误码映射实现
组件内置完整的错误码映射，支持以下错误类型：
- **E_AUTH**: 需要登录 - 重新登录按钮
- **E_PERM**: 权限不足 - 申请权限 + 联系管理员
- **E_VALIDATE**: 参数错误 - 重新操作提示  
- **E_NOT_FOUND**: 内容不存在 - 刷新页面
- **E_CONFLICT**: 操作冲突 - 重新加载
- **E_RATE_LIMIT**: 请求过频 - 稍后重试
- **E_DEPENDENCY**: 网络异常 - 重试按钮
- **E_INTERNAL**: 服务异常 - 重试 + 反馈问题

### File List
- `miniprogram/components/empty-state/index.wxml` - 空状态组件模板
- `miniprogram/components/empty-state/index.wxss` - 空状态组件样式
- `miniprogram/components/empty-state/index.js` - 空状态组件逻辑
- `miniprogram/components/empty-state/index.json` - 空状态组件配置
- `miniprogram/components/error-view/index.wxml` - 错误状态组件模板
- `miniprogram/components/error-view/index.wxss` - 错误状态组件样式
- `miniprogram/components/error-view/index.js` - 错误状态组件逻辑（含映射）
- `miniprogram/components/error-view/index.json` - 错误状态组件配置
- `miniprogram/pages/patients/index.json` - 患者页面组件引入
- `miniprogram/pages/patients/index.wxml` - 患者页面空状态替换
- `miniprogram/pages/services/index.json` - 服务页面组件引入
- `miniprogram/pages/services/index.wxml` - 服务页面空/错状态替换
- `miniprogram/pages/activities/index.json` - 活动页面组件引入
- `miniprogram/pages/activities/index.wxml` - 活动页面空/错状态替换
- `miniprogram/pages/stats/index.json` - 统计页面组件引入
- `miniprogram/pages/stats/index.wxml` - 统计页面空/错状态替换
- `miniprogram/pages/empty-error-demo/index.wxml` - 演示页面模板
- `miniprogram/pages/empty-error-demo/index.wxss` - 演示页面样式
- `miniprogram/pages/empty-error-demo/index.js` - 演示页面逻辑
- `miniprogram/pages/empty-error-demo/index.json` - 演示页面配置
- `miniprogram/app.json` - 注册演示页面

### Change Log
| Date       | Version | Description                                  | Author |
|------------|---------|----------------------------------------------|--------|
| 2025-09-08 | 0.1     | 初始草案                                     | BMAD   |
| 2025-09-08 | 0.2     | 通过 Story Draft Checklist，状态改为 Approved | BMAD   |
| 2025-09-09 | 1.0     | Empty/Error组件完整实现并统一接入所有列表页面    | James  |

### Status
Completed

## QA Results

- Result: Passed
- Test Plan: docs/qa/test-plan-empty-error.md
- QA Report: docs/qa/results/empty-error-qa-report-2025-09-09.md
- QA Followup: docs/qa/results/empty-error-qa-followup-2025-09-09.md
- Notes:
  - 增强：为容器与禁用按钮补充 role/aria，提升可访问性
  - Demo 覆盖空/错的典型变体与交互
  - 优化：统一首页、患者详情页剩余历史空状态样式为EmptyState组件
