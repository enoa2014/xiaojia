# Story 1.1: 患者卡片信息重构与操作优化（P1）

> Epic: 患者与家庭档案（参考 docs/prd/08-epic-split.md#epic-1-患者与家庭档案）

## Status
Approved

## Story
作为档案查看用户，我希望患者列表卡片展示与操作更聚焦关键信息，从而快速获知患者基本情况并进行常用操作（新增服务、标记关注）。

## Acceptance Criteria
1. 卡片字段展示（列表内各分组一致：在住、全部、搜索结果）：
   - 显示：姓名（遵循现有脱敏策略）、年龄、籍贯、首诊疾病、最近入住时间、入住次数。
   - 不再显示：楼栋/房间/床位信息（即移除 `bedInfo` 相关 DOM 与样式）。
   - 首诊疾病：使用患者 `hospitalDiagnosis` 字段；若后端按权限返回为脱敏文案（如“诊断信息已脱敏”或“诊断级别：X”），卡片直接显示该文案，不做反脱敏处理。
   - 最近入住时间：采用最近一次入住记录日期（yyyy-MM-dd）；不可用时显示“—”。
   - 入住次数：统计该患者的入住记录数量；不可用时显示“—”。
2. 操作按钮（使用现有组件实现）：
   - “新加服务”：使用 `ui-button`（建议 `size=sm`，`variant=primary|secondary`），点击跳转 `/pages/services/form?pid=<patientId>`；不触发卡片整体点击（使用 `catchtap`）。
   - “特别关注”：使用 `ui-button`（建议 `size=sm`，`variant=ghost`），沿用现有本地标星逻辑（`star_patients` 缓存）；图标/文案可为“★ 特别关注/已关注”。
   - 两个按钮均需具备可访问性文案（aria-label 或等效），并复用现有样式工具类，不新增孤立样式类。
3. 可用性与一致性：
   - 卡片点击仍跳转详情（保留 `toDetail`），按钮点击互不干扰（`catchtap`）。
   - 搜索结果与分组列表字段布局一致；无可用字段时以“—”占位，避免版式抖动。
   - 适配现有主题与样式体系（`tokens.wxss`/`app.wxss` 工具类），不新增孤立样式。
4. 合规与性能：
   - 不直接展示敏感字段明文（遵循后端返回的脱敏/授权矩阵）。
   - 如需新增数据来源，应避免列表渲染中的 N+1 请求；若后端暂不提供聚合字段，采用优雅降级占位显示并记录技术债。

## Tasks / Subtasks
- [ ] 前端 WXML：
  - [x] 调整 `pages/patients/index.wxml` 列表项结构：移除 `bedInfo`，新增“籍贯｜首诊疾病｜最近入住时间｜入住次数”信息行（AC: 1）。
  - [ ] 替换迷你按钮为 `ui-button` 两个操作按钮：新加服务、特别关注（AC: 2）。
  - [x] 确保按钮使用 `catchtap`，不触发父级 `toDetail`（AC: 3）。
  - [x] 更新 `pages/patients/index.wxss`：删除 `.bed-info` 等相关选择器与样式（AC: 1）。
- [ ] 前端 JS：
  - [x] 在 `pages/patients/index.js` 的 `processPatientItem` 中：保留 `maskedName/ageText`，新增 `nativePlaceText`（来源 `nativePlace` 或占位“—”）、`lastCheckInText`（`formatDate(x.lastCheckInDate)` 或“—”）、`admissionCount`（数值或“—”）（AC: 1）。
  - [ ] 为按钮绑定现有方法：`toService(e)` / `toggleStar(e)`（AC: 2）。
  - [ ] 搜索结果与分组列表共用同一字段布局（AC: 3）。
- [ ] 后端（推荐，若排期允许）：
  - [ ] 在 `functions/patients/index.ts` 的 `list` 中加入聚合：按 `patientId`（或 `id_card`）从 `Tenancies` 聚合最新 `checkInDate` 与记录数，回填 `lastCheckInDate`、`admissionCount`（AC: 1,4）。
  - [ ] 确保 `hospitalDiagnosis` 在 `list` 场景下也遵循与 `get` 一致的脱敏策略（AC: 4）。
- [ ] 样式与可访问性：
  - [ ] 使用现有工具类与 `ui-button` 风格，不新增全局样式；为按钮与信息行添加恰当的 `aria-label`（AC: 2,3）。
- [ ] 文档与交付：
  - [ ] 在 `docs/architecture/01-frontend.md` 简述列表卡片信息规范与数据来源（可选）。
  - [ ] 更新 `docs/prd/03-features.md` 中患者列表展示规范条目（可选）。

## Dev Notes
- 主要文件：
  - `miniprogram/pages/patients/index.wxml`（卡片结构与按钮组件）
  - `miniprogram/pages/patients/index.js`（字段映射与事件处理）
  - `miniprogram/pages/patients/index.wxss`（相关样式清理与微调）
  - 组件：`miniprogram/components/button`（`<ui-button ... />`）
  - 服务：`miniprogram/services/api.js`（`patients.list/get`）
- 数据字段来源建议：
  - 年龄：由 `birthDate` 计算（已实现 `calcAge`）。
  - 籍贯：`nativePlace`（字符串，可能为空）。
  - 首诊疾病：`hospitalDiagnosis`（遵循隐私策略）。
  - 最近入住时间 / 入住次数：优先由后端 `patients.list` 聚合返回 `lastCheckInDate`、`admissionCount`；无则前端显示占位“—”。
- 交互：
  - “新加服务”跳转：`/pages/services/form?pid=<id>`（已有 `toService`）。
  - “特别关注”沿用 `star_patients` 本地缓存；按钮样式用 `variant=ghost|secondary`，`size=sm`。

### References
- docs/prd/03-features.md#患者与家庭档案
- docs/prd/08-epic-split.md#epic-1-患者与家庭档案

### Testing

- 单元：
  - `processPatientItem` 返回对象包含 `nativePlaceText/lastCheckInText/admissionCount`，空值退化为“—”。
  - 按钮事件 `toService/toggleStar` 在卡片点击存在时不冒泡（`catchtap` 生效）。
- 集成：
  - 列表分组（在住/全部/搜索结果）字段一致显示；不同数据规模无版式抖动。
  - 按钮 `catchtap` 生效：点击按钮不会触发父级 `toDetail`，点击卡片空白区域可正常进入详情。
  - 若后端已聚合：抽样 3 位患者验证最近入住时间/次数准确；若未聚合：显示“—”。
- E2E（DevTools 手测）：
  - 从首页入口进入档案列表，检查卡片字段与按钮行为；主题样式与可读性符合设计体系。

## Change Log
| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-09-10 | 0.1     | 初始草案（基于用户口述需求）         | PO     |
| 2025-09-10 | 1.0     | 按故事实施前端改造（WXML/JS/WXSS）    | Dev    |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
- miniprogram/pages/patients/index.wxml (修改：重构卡片信息行与按钮)
- miniprogram/pages/patients/index.js (修改：新增映射字段 nativePlaceText/firstDiagnosisText/lastCheckInText/admissionCount)
- miniprogram/pages/patients/index.wxss (修改：移除 .bed-info，新增 .patient-meta/.meta)
### File List

## QA Results
