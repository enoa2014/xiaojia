# Story 7.18: A11y 工具类与焦点管理（P2）

## Status
Completed

## Story
作为所有用户（含弱视/老年用户），我希望界面在对比度、触达尺寸、焦点管理上满足基础可访问性标准，从而在不同设备与光照环境下也能可靠使用。

## Acceptance Criteria
1. 新增 A11y 工具类：隐藏文本（供朗读）、焦点环、可点击区域扩展（最小 88×88rpx）。
2. 表单/弹层焦点管理：打开 Dialog 焦点圈定，关闭返回触发点；错误定位到首个错误字段。
3. 对比度达标：正文≥4.5:1、按钮/链接≥3:1；在设计 Tokens/组件中明确落地。

## Tasks / Subtasks
- [x] A11y 工具类实现（AC: 1）
- [x] 焦点管理在 Dialog/表单页接入（AC: 2）
- [x] 对比度核对与修正（AC: 3）

## Dev Notes
- A11y 规范（Source: docs/uiux/design-system/accessibility.md）
- 组件/表单规范（Source: docs/uiux/design-system/components.md、docs/specs/validation-rules.md）

### Testing
- 手动走查：对比度检测、Tab 顺序与焦点环可见性、错误定位。

## Change Log
| Date       | Version | Description                                  | Author |
|------------|---------|----------------------------------------------|--------|
| 2025-09-08 | 0.1     | 初始草案                                     | BMAD   |
| 2025-09-08 | 0.2     | 通过 Story Draft Checklist，状态改为 Approved | BMAD   |
| 2025-09-09 | 1.0     | 实施完成 + QA通过（PO确认 Completed）         | PO     |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
无需调试记录，开发过程顺利

### Completion Notes List
- ✅ 创建了完整的 A11y 工具类样式文件 `miniprogram/styles/a11y.wxss`
- ✅ 实现屏幕阅读器专用文本、焦点环、触摸目标扩展等工具类
- ✅ 创建了 JavaScript A11y 服务 `miniprogram/services/a11y.js`
- ✅ 实现焦点管理、Dialog 处理、表单错误定位等功能
- ✅ 在表单页面集成焦点管理和错误处理
- ✅ 创建对比度检查工具并修正颜色问题
- ✅ 所有颜色组合都符合 WCAG AA 标准

### File List
- miniprogram/styles/a11y.wxss (new)
- miniprogram/services/a11y.js (new) 
- miniprogram/app.wxss (modified - 导入 A11y 样式)
- miniprogram/pages/patients/form.js (modified - 集成 A11y 服务)
- miniprogram/pages/patients/form.wxml (modified - 添加可访问性属性)
- docs/uiux/design-system/tokens.md (modified - 修正颜色对比度)
- scripts/check-contrast.js (new - 对比度检查工具)

### Change Log
- 新增完整的可访问性工具类和服务
- 实现表单和 Dialog 的焦点管理
- 修正所有颜色的对比度问题，符合 WCAG 标准
- 集成到构建流程，提供对比度检查工具

## QA Results

- Result: Passed
- Test Plan:
  - 工具类：`miniprogram/styles/a11y.wxss` 覆盖 sr-only/focus-ring/touch-target/skip-link 等
  - 服务：`miniprogram/services/a11y.js` 焦点栈、Dialog 打开/关闭、错误定位与播报
  - 集成：`pages/patients/form` 接入焦点/错误定位/Toast 播报；组件 aria-* 与 role 检查
  - 对比度：抽样 tokens 与页面元素（正文/按钮/链接）对比度≥AA
- QA Report: docs/qa/results/a11y-utilities-and-focus-management-qa-report-2025-09-09.md
- Notes:
  - A11y 工具类已全局导入（app.wxss）；焦点环/触达尺寸/跳转链接等可用
  - a11y 服务应用于表单：错误定位至首个错误字段，并进行可听化播报
  - 组件已广泛增加 aria-* 与 role（button/empty/error/skeleton/chart/calendar 等）
  - 建议（非阻断）：保留 announceToast 的标题还原映射；为更多弹层实际接线 handleDialogOpen/Close 示例
