# 错误码与前端处理

统一应用层错误码，便于前端一致处理与日志追踪。

| 代码 | 说明 | 前端处理 |
|-----|------|----------|
| E_AUTH | 未登录/会话过期 | 跳转登录/重新授权，保留返回路径 |
| E_PERM | 权限不足 | Toast 提示 + 引导申请权限（如进入权限申请页）|
| E_VALIDATE | 参数/业务校验失败 | 表单内联提示 + 高亮错误字段 |
| E_NOT_FOUND | 目标不存在 | Toast/空态，占位展示 |
| E_CONFLICT | 唯一冲突/状态冲突 | 显示冲突详情（如身份证已存在/床位冲突），提供解决指引 |
| E_RATE_LIMIT | 频控限制 | 退避重试/冷却提示 |
| E_DEPENDENCY | 外部依赖异常 | 重试与降级策略 |
| E_INTERNAL | 未知错误 | 友好提示 + 上报 requestId |

响应示例：
```
{ "code": "E_VALIDATE", "message": "身份证格式错误", "requestId": "..." }
```

日志与追踪：
- 云函数内记录 requestId、用户、入口、参数摘要、错误栈（敏感脱敏后）
- 前端对非 0 code 上报埋点 event：`api_error`，属性含 name/code/path/duration

## 重试与退避建议（客户端）

| 代码 | 是否重试 | 退避策略 | 备注 |
|------|----------|----------|------|
| E_AUTH/E_PERM | 否 | - | 引导登录或权限申请 |
| E_VALIDATE/E_CONFLICT | 否 | - | 修正输入或走冲突解决流程 |
| E_NOT_FOUND | 否 | - | 可提示刷新后重试 |
| E_RATE_LIMIT | 是 | 指数退避：0.5s×2≤10s，抖动20–30%，最多3次 | 显示冷却提示 |
| E_DEPENDENCY | 是 | 同上 | 失败则降级/稍后再试 |
| E_INTERNAL | 是 | 同上 | 超过重试上限提示联系支持并附 requestId |

## 回退策略（降级）
- 列表类：失败时显示空态、缓存上次成功数据、提供“重试”与“反馈”。
- 创建类：失败保留本地草稿（服务记录/报名/表单），可稍后继续提交。
- 导出类：失败展示任务状态与重试入口，或允许用户留下邮箱以异步通知（视环境决策）。

## 关联文档
- 接口合同与参数校验：`docs/api/contracts.md`
- 字段级可见性与审批：`docs/data/field-masking-matrix.md`
