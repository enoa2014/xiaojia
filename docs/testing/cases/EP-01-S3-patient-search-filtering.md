# QA 用例 · EP-01-S3 患者档案搜索/筛选

目标：验证按姓名前缀、证件尾4位、时间范围的分页搜索功能，确保索引性能和结果准确性。

## 前置条件
- 已部署函数：`patients`（含 `list` action，支持过滤/分页/排序）
- 已建立索引：`name+id_card_tail` 组合索引、`createdAt` 倒序索引
- 已准备测试数据集（至少50条患者记录，包含边界情况）
- 小程序端已联调 `pages/patients/index`（列表页）

## 测试数据集
```javascript
const testPatients = [
  { name: '张三', id_card: '110105199001011234', id_card_tail: '1234', createdAt: 1693900000000 },
  { name: '张四', id_card: '110105199002025678', id_card_tail: '5678', createdAt: 1693900100000 },
  { name: '李小明', id_card: '220105199003031111', id_card_tail: '1111', createdAt: 1693900200000 },
  { name: '王大伟', id_card: '330105199004041234', id_card_tail: '1234', createdAt: 1693900300000 },
  { name: '赵小红', id_card: '440105199005055555', id_card_tail: '5555', createdAt: 1693900400000 },
  // ... 更多测试数据
]
```

## 用例

### 1) 基础列表查询（无过滤条件）
**操作**：`patients.list({ page: 1, pageSize: 10 })`
**期望**：
- 返回格式：`{ ok: true, data: { items: Patient[], meta: { total: number, hasMore: boolean } } }`
- 按 `createdAt desc` 默认排序
- `items` 数组长度 ≤ 10
- `meta.total` 为总记录数
- `meta.hasMore` 正确反映是否有更多数据

### 2) 姓名前缀搜索
**操作**：`patients.list({ filter: { name: '张' } })`
**期望**：
- 返回所有姓名以"张"开头的患者
- 不区分大小写匹配
- 结果按 `createdAt desc` 排序

**边界测试**：
- 单字符：`{ name: '李' }` → 返回李小明
- 多字符：`{ name: '张三' }` → 只返回张三（精确前缀）
- 空字符串：`{ name: '' }` → 返回所有记录
- 不存在：`{ name: '不存在' }` → 返回空数组

### 3) 身份证尾4位搜索
**操作**：`patients.list({ filter: { id_card_tail: '1234' } })`
**期望**：
- 返回所有 `id_card_tail` 为 '1234' 的患者（张三、王大伟）
- 精确匹配，区分大小写

**边界测试**：
- 2位：`{ id_card_tail: '34' }` → 应该无匹配（要求2-4位，但精确匹配）
- 4位：`{ id_card_tail: '1234' }` → 返回匹配记录
- 不存在：`{ id_card_tail: '9999' }` → 返回空数组

### 4) 时间范围过滤
**操作**：`patients.list({ filter: { createdFrom: 1693900100000, createdTo: 1693900300000 } })`
**期望**：
- 返回创建时间在指定范围内的患者（张四、李小明、王大伟）
- 包含边界值（>=createdFrom, <=createdTo）

**边界测试**：
- 只有起始时间：`{ createdFrom: 1693900200000 }` → 返回该时间之后的记录
- 只有结束时间：`{ createdTo: 1693900200000 }` → 返回该时间之前的记录
- 无效范围：`{ createdFrom: 1693900300000, createdTo: 1693900100000 }` → 返回空数组

### 5) 组合过滤
**操作**：`patients.list({ filter: { name: '张', id_card_tail: '1234' } })`
**期望**：
- 返回同时满足姓名前缀和身份证尾号条件的患者（张三）
- AND逻辑组合

### 6) 分页功能
**操作**：
- 第1页：`patients.list({ page: 1, pageSize: 2 })`
- 第2页：`patients.list({ page: 2, pageSize: 2 })`

**期望**：
- 第1页：返回前2条记录，`hasMore: true`
- 第2页：返回第3-4条记录
- 分页边界：最后一页 `hasMore: false`
- 超出页数：返回空数组，`hasMore: false`

### 7) 排序功能
**操作**：`patients.list({ sort: { name: 1 } })`
**期望**：
- 按姓名正序排列（李小明、王大伟、张三、张四、赵小红）
- 单字段排序限制（仅第一个排序字段生效）

**操作**：`patients.list({ sort: { createdAt: -1 } })`
**期望**：
- 按创建时间倒序（默认行为）

### 8) 参数校验
**无效页码**：
- `{ page: 0 }` → 自动修正为 page: 1
- `{ page: -1 }` → 自动修正为 page: 1

**无效页大小**：
- `{ pageSize: 0 }` → 自动修正为默认值 10
- `{ pageSize: 200 }` → 自动钳制为 100

**无效过滤参数**：
- `{ filter: { name: null } }` → 忽略该过滤条件
- `{ filter: { unknownField: 'value' } }` → 忽略未知字段

### 9) 性能测试
**大数据集**：准备1000+记录
**操作**：各种过滤组合查询
**期望**：
- 响应时间 <500ms
- 内存使用合理
- 索引有效利用（通过数据库查询计划验证）

### 10) 前端集成
**操作**：在小程序列表页执行搜索操作
**期望前端**：
- 搜索框实时过滤（防抖处理）
- 分页加载（上拉刷新）
- 空态和错误态正确显示
- 筛选条件持久化

## 验证步骤

### 后端验证
1. 通过云函数测试面板调用各种参数组合的 `patients.list`
2. 验证返回数据格式和内容正确性
3. 检查数据库索引使用情况
4. 压力测试性能表现

### 前端验证  
1. 在列表页测试各种搜索和筛选功能
2. 验证分页加载和数据渲染
3. 测试网络异常和空数据情况

### 数据库验证
```javascript
// 验证索引是否生效
db.collection('Patients').where({}).explain()

// 查看查询计划，确认使用了预期索引
```

## 预期结果检查清单

- [ ] 基础列表查询返回正确的数据结构和元信息
- [ ] 姓名前缀搜索支持中文不区分大小写
- [ ] 身份证尾号精确匹配功能正确
- [ ] 时间范围过滤包含边界值处理
- [ ] 组合过滤条件AND逻辑正确
- [ ] 分页功能边界情况处理正确
- [ ] 排序功能按预期工作（仅单字段）
- [ ] 参数校验自动修正无效值
- [ ] 查询性能满足要求（<500ms）
- [ ] 前端UI与后端数据正确集成

## 边界情况和异常测试

- [ ] 空数据库查询返回空结果
- [ ] 超大页码请求处理
- [ ] 特殊字符在搜索条件中的处理
- [ ] 并发查询的一致性
- [ ] 数据库连接异常的错误处理

## 执行记录
- 执行人：
- 执行时间：
- 测试环境：cloud1-3grb87gwaba26b64
- 测试数据量：
- 结果：[ ] PASS [ ] FAIL
- 性能指标：平均响应时间 ___ms
- 问题记录：