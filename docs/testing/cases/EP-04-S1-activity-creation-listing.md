# QA 用例 · EP-04-S1 活动发布与列表

目标：验证社工/管理员创建活动的完整流程，包括字段校验、状态管理、列表筛选和权限控制。

## 前置条件
- 已部署函数：`activities`（含 `create` 和 `list` actions）
- 已配置角色：社工、管理员（有创建权限），志愿者（无创建权限）
- 已建立 `Activities` 集合和相关索引
- 小程序端已联调活动相关页面

## 用例

### 1) 成功创建活动
**操作**：
```javascript
activities.create({
  activity: {
    title: '亲子康复训练活动',
    date: '2025-09-15', 
    location: '小家康复中心',
    capacity: 20,
    status: 'open',
    description: '面向患儿及家长的康复训练指导活动，包含物理治疗和心理支持'
  },
  clientToken: 'activity_token_001'
})
```
**期望**：
- 返回：`{ ok: true, data: { _id: 'activity_id' } }`
- 数据库记录包含：`createdAt`（时间戳）、`createdBy`（当前用户）
- 前端：Toast显示"活动创建成功"，跳转到活动列表

### 2) 标题字段校验
**有效标题**：
- 正常长度：`亲子康复训练活动`（2-40字符）
- 最短：`活动`（2字符）
- 最长：`2025年度小家康复中心面向患儿及家庭的综合康复训练与心理支持活动`（40字符）

**无效标题**：
- 过短：`活`（1字符）→ `E_VALIDATE: 活动标题至少需要2个字符`
- 过长：`${'活动标题'.repeat(20)}`（>40字符）→ `E_VALIDATE: 活动标题不能超过40个字符`
- 空值：`null`/`undefined` → `E_VALIDATE: title 为必填字段`

### 3) 日期字段校验
**有效日期**：
- 标准格式：`2025-09-15`
- 年初：`2025-01-01`
- 年末：`2025-12-31`

**无效日期**：
- 非标准格式：`2025-9-15` → `E_VALIDATE: 日期格式必须为YYYY-MM-DD`
- 无效日期：`2025-02-30` → `E_VALIDATE: 无效日期`
- 过去日期：`2020-01-01` → 根据业务规则决定是否允许
- 空值：`null` → `E_VALIDATE: date 为必填字段`

### 4) 地点字段校验
**有效地点**：
- 正常地点：`小家康复中心`
- 详细地址：`北京市朝阳区xxx路xxx号小家康复中心2楼活动室`
- 最长80字符的地点描述

**无效地点**：
- 过长：`${'地'.repeat(81)}`（>80字符）→ `E_VALIDATE: 地点描述不能超过80个字符`
- 空值：允许为空（可选字段）

### 5) 容量字段校验
**有效容量**：
- 无限制：`0`（表示无容量限制）
- 正整数：`20`、`50`、`100`
- 大容量：`999`

**无效容量**：
- 负数：`-1` → `E_VALIDATE: 容量不能为负数`
- 小数：`20.5` → `E_VALIDATE: 容量必须为整数`
- 非数字：`'twenty'` → `E_VALIDATE: 容量必须为数字`

### 6) 状态字段校验
**有效状态**：
- `open`（开放报名）
- `ongoing`（进行中）
- `done`（已结束）
- `closed`（已关闭）

**无效状态**：
- 无效值：`invalid` → `E_VALIDATE: 状态必须是有效的活动状态`
- 空值：`null` → `E_VALIDATE: status 为必填字段`

### 7) 描述字段校验
**有效描述**：
- 详细描述：包含活动内容、时间、注意事项等
- 空值：允许为空（可选字段）
- 长描述：验证最大长度限制

**无效描述**：
- 超长描述：根据设定的最大长度校验

### 8) 权限控制验证
**有权限角色**（社工、管理员）：
- 成功创建活动

**无权限角色**（志愿者）：
- **期望**：`{ ok: false, error: { code: 'E_PERM', msg: '权限不足，只有社工和管理员可以创建活动' } }`
- 数据库无记录创建

### 9) 活动列表查询（无过滤）
**操作**：`activities.list({ page: 1, pageSize: 10 })`
**期望**：
- 返回格式：`{ ok: true, data: { items: Activity[], meta: { total: number, hasMore: boolean } } }`
- 按 `date desc` 默认排序（最新活动在前）
- 分页信息正确

### 10) 状态过滤查询
**按状态筛选**：
```javascript
activities.list({ 
  filter: { status: 'open' },
  page: 1, 
  pageSize: 20 
})
```
**期望**：
- 只返回状态为 `open` 的活动
- 其他字段保持完整

**多状态测试**：分别测试 `ongoing`、`done`、`closed` 状态

### 11) 时间范围过滤
**指定时间范围**：
```javascript
activities.list({
  filter: {
    from: '2025-09-01',
    to: '2025-09-30'
  }
})
```
**期望**：
- 返回日期在9月份的所有活动
- 包含边界日期

**边界测试**：
- 只有开始时间：`from: '2025-09-15'`
- 只有结束时间：`to: '2025-09-15'`
- 无效范围：开始时间晚于结束时间

### 12) 组合过滤查询
**状态+时间过滤**：
```javascript
activities.list({
  filter: {
    status: 'open',
    from: '2025-09-01',
    to: '2025-12-31'
  }
})
```
**期望**：
- 返回指定时间范围内且状态为 `open` 的活动
- AND逻辑组合正确

### 13) 排序功能
**按日期排序**：
- 默认：按 `date desc`（最新在前）
- 指定：`sort: { date: 1 }`（最早在前）

**按创建时间排序**：
- `sort: { createdAt: -1 }`（最新创建在前）

### 14) 分页功能
**正常分页**：
- 第1页：`{ page: 1, pageSize: 5 }`
- 第2页：`{ page: 2, pageSize: 5 }`
- 验证 `hasMore` 标志正确

**边界情况**：
- 页码为0：自动修正为1
- 页大小超限：自动钳制到最大值
- 超出总页数：返回空数组

### 15) 客户端Token幂等性
**重复创建测试**：
```javascript
const activityData = { title: '测试活动', date: '2025-09-20', ... }
const token = 'test_token_123'

// 第一次创建
const result1 = await activities.create({ activity: activityData, clientToken: token })
// 重复创建  
const result2 = await activities.create({ activity: activityData, clientToken: token })
```
**期望**：
- `result1` 和 `result2` 返回相同的 `_id`
- 数据库中只有一条记录

### 16) 前端集成测试
**创建表单**：
- 所有字段验证与后端一致
- 日期选择器提供友好交互
- 容量输入支持数字键盘
- 状态下拉选择

**列表页面**：
- 活动卡片显示关键信息
- 状态徽标颜色区分
- 筛选面板功能完整
- 分页或无限滚动

**详情页面**：
- 完整活动信息展示
- 报名状态和人数显示
- 管理操作入口（对有权限用户）

## 验证步骤

### 后端验证
1. 云函数测试面板测试创建和查询功能
2. 验证各种参数校验的准确性
3. 测试权限控制的有效性
4. 验证幂等性机制
5. 性能测试（大量活动数据）

### 前端验证
1. 测试创建表单的用户体验
2. 验证列表页的展示和筛选功能
3. 测试权限控制在UI层的体现
4. 验证网络异常情况的处理

### 数据验证
1. 检查数据库记录的完整性
2. 验证索引的有效利用
3. 确认数据格式的一致性

## 测试数据

### 活动测试数据
```javascript
const testActivities = [
  {
    title: '周末亲子活动',
    date: '2025-09-21',
    location: '小家活动中心',
    capacity: 30,
    status: 'open',
    description: '家庭互动游戏和康复指导'
  },
  {
    title: '康复训练课程',
    date: '2025-09-18',
    location: '康复训练室', 
    capacity: 15,
    status: 'ongoing',
    description: '专业康复师指导的训练课程'
  },
  {
    title: '心理支持小组',
    date: '2025-09-10',
    location: '心理咨询室',
    capacity: 8,
    status: 'done',
    description: '家长心理健康支持活动'
  }
]
```

## 预期结果检查清单

### 创建功能
- [ ] 有权限用户可以成功创建活动
- [ ] 无权限用户被正确阻止
- [ ] 所有字段校验规则生效
- [ ] 幂等性防止重复创建

### 列表功能
- [ ] 基础列表查询返回正确格式
- [ ] 状态过滤功能正确
- [ ] 时间范围过滤功能正确
- [ ] 组合过滤逻辑正确
- [ ] 排序功能符合预期
- [ ] 分页功能处理边界情况

### 数据完整性
- [ ] 自动字段（createdAt, createdBy）正确设置
- [ ] 数据库记录格式符合schema定义
- [ ] 索引有效提升查询性能

### 用户体验
- [ ] 前端表单验证友好
- [ ] 列表展示信息充分
- [ ] 筛选和搜索功能易用
- [ ] 错误处理和反馈清晰

## 执行记录
- 执行人：
- 执行时间：
- 测试环境：cloud1-3grb87gwaba26b64
- 结果：[ ] PASS [ ] FAIL
- 活动创建数量：
- 权限测试：[ ] PASS [ ] FAIL
- 筛选测试：[ ] PASS [ ] FAIL
- 性能测试：平均响应时间 ___ms
- 问题记录：