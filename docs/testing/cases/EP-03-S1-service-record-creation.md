# QA 用例 · EP-03-S1 志愿者提交服务记录

目标：验证志愿者提交服务记录的完整流程，包括字段校验、幂等性、图片上传和错误处理。

## 前置条件
- 已部署函数：`services`（含 `create` action）
- 已创建测试患者：`patientId` 可用于关联
- 已配置志愿者用户角色和权限
- 已准备测试图片文件（各种格式和大小）
- 小程序端已联调 `pages/services/form`

## 用例

### 1) 成功创建服务记录（基础字段）
**操作**：
```javascript
services.create({
  service: {
    patientId: 'test_patient_id',
    type: 'visit',
    date: '2025-09-06',
    desc: '上门探访，了解患者近期身体状况和心理状态'
  },
  clientToken: 'unique_token_001'
})
```
**期望**：
- 返回：`{ ok: true, data: { _id: 'service_id' } }`
- 数据库记录包含：`createdBy`（当前用户）、`createdAt`（时间戳）、`status: 'review'`
- 前端：Toast显示"提交成功，等待审核"，返回列表页

### 2) 服务类型校验
**有效类型测试**：
- `visit`（探访）
- `psych`（心理支持）  
- `goods`（物资提供）
- `referral`（转介服务）
- `followup`（后续跟进）

**无效类型测试**：
- `invalid_type` → `E_VALIDATE: type 必须是有效的服务类型`
- `null`/`undefined` → `E_VALIDATE: type 为必填字段`

### 3) 日期格式校验
**有效日期**：
- `2025-09-06`（标准ISO格式）
- `2025-01-01`（年初）
- `2025-12-31`（年末）

**无效日期**：
- `2025-9-6`（非标准格式）→ `E_VALIDATE: 日期格式错误`
- `2025-02-30`（不存在的日期）→ `E_VALIDATE: 无效日期`
- `not_a_date` → `E_VALIDATE: 日期格式错误`

### 4) 描述字段校验
**有效描述**：
- 正常文字：`上门探访，患者状态良好`
- 包含特殊符号：`探访时间：14:30-16:00，情况记录如下...`
- 最大长度（500字符）

**无效描述**：
- 空字符串：可选字段，应该允许
- 超长文本（>500字符）→ `E_VALIDATE: 描述不能超过500字符`

### 5) 必填字段校验
**缺失必填字段**：
- 缺少 `patientId` → `E_VALIDATE: patientId 为必填字段`
- 缺少 `type` → `E_VALIDATE: type 为必填字段`
- 缺少 `date` → `E_VALIDATE: date 为必填字段`

### 6) 患者关联校验
**有效患者ID**：使用存在的患者ID
**无效患者ID**：
- 不存在的ID → 应该在业务逻辑层处理（可能允许创建，后续验证）
- 非字符串类型 → `E_VALIDATE: patientId 必须是字符串`

### 7) 幂等性测试
**相同clientToken重复提交**：
```javascript
// 第一次提交
const result1 = await services.create({ service: { ... }, clientToken: 'token_123' })

// 重复提交（相同clientToken）
const result2 = await services.create({ service: { ... }, clientToken: 'token_123' })
```
**期望**：
- `result1` 和 `result2` 返回相同的 `_id`
- 数据库中只有一条记录
- 不应该产生重复数据

**不同clientToken**：应该创建新记录

### 8) 图片上传测试（占位功能）
**有效图片**：
- JPG、PNG格式图片
- 小于5MB的图片
- 数量限制9张以内

**无效图片**：
- 超大文件（>5MB）→ 根据实现返回相应错误
- 超出数量限制（>9张）→ 相应错误提示
- 不支持的格式 → 相应错误提示

**注意**：当前可能为占位实现，重点测试字段是否正确保存

### 9) 权限控制
**有权限用户**（志愿者、社工、管理员）：允许创建
**无权限用户**：
- 如果实现了权限控制 → `E_PERM: 权限不足`
- 如果未实现 → 应该在后续Sprint中补充

### 10) 网络异常和重试
**网络中断测试**：
- 提交过程中断网 → 前端显示网络错误，提供重试
- 弱网环境 → 显示加载状态，超时后提供重试

**服务异常**：
- 数据库连接失败 → `E_INTERNAL`，前端提供重试选项
- 函数执行超时 → 相应错误处理

### 11) 前端表单集成
**表单验证**：
- 本地校验与后端校验一致
- 必填字段高亮提示
- 实时格式验证（日期选择器）

**提交流程**：
- 点击提交 → 显示加载状态 → 成功/失败反馈
- 成功：清空表单，返回列表或详情页
- 失败：保留表单数据，显示错误信息

**草稿保存**：
- 表单数据本地暂存
- 网络失败后数据不丢失

## 验证步骤

### 后端验证
1. 云函数测试面板测试各种参数组合
2. 验证数据库记录的完整性和正确性
3. 检查幂等性机制的有效性
4. 验证错误码和错误信息的准确性

### 前端验证
1. 在服务记录表单页测试完整提交流程
2. 验证各种校验错误的显示效果
3. 测试网络异常情况下的用户体验
4. 验证表单数据的持久化

### 集成验证
1. 端到端流程测试：登录→选择患者→填写服务记录→提交→查看状态
2. 不同角色的权限验证
3. 数据一致性验证

## 测试数据

### 有效测试数据
```javascript
const validServiceRecords = [
  {
    patientId: 'patient_001',
    type: 'visit',
    date: '2025-09-06',
    desc: '定期探访，患者精神状态良好，食欲正常'
  },
  {
    patientId: 'patient_002', 
    type: 'psych',
    date: '2025-09-05',
    desc: '心理疏导，帮助患者缓解焦虑情绪'
  },
  {
    patientId: 'patient_003',
    type: 'goods', 
    date: '2025-09-04',
    desc: '提供生活用品：米面油各2袋，水果一箱'
  }
]
```

### 边界测试数据
```javascript
const borderlineData = [
  {
    patientId: 'patient_001',
    type: 'visit',
    date: '2025-09-06',
    desc: ''.padEnd(500, '测') // 500字符描述
  },
  {
    patientId: 'patient_001',
    type: 'visit', 
    date: '2025-09-06',
    desc: ''.padEnd(501, '测') // 501字符描述（应该失败）
  }
]
```

## 预期结果检查清单

### 功能正确性
- [ ] 有效数据成功创建服务记录
- [ ] 服务类型枚举校验正确
- [ ] 日期格式校验严格
- [ ] 描述字段长度限制有效
- [ ] 必填字段校验完整

### 业务逻辑
- [ ] 服务记录默认状态为'review'
- [ ] 自动记录创建者和创建时间
- [ ] 患者关联正确建立

### 技术实现
- [ ] 幂等性机制有效防止重复提交
- [ ] 错误码和错误信息准确
- [ ] 图片字段预留（即使暂未实现上传）

### 用户体验
- [ ] 前端表单验证友好
- [ ] 提交成功后正确跳转
- [ ] 网络异常时体验良好
- [ ] 草稿保存机制可用

## 执行记录
- 执行人：
- 执行时间：
- 测试环境：cloud1-3grb87gwaba26b64
- 结果：[ ] PASS [ ] FAIL
- 测试记录数量：
- 幂等性验证：[ ] PASS [ ] FAIL
- 问题记录：