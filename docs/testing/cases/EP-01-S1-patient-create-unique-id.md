# QA 用例 · EP-01-S1 患者建档（身份证唯一去重与冲突提示）

目标：验证身份证合法性/唯一性、出生日期校验、冲突引导与前后端一致性。

## 前置
- 已在云开发控制台为 `Patients` 建立唯一索引：`id_card`（unique）
- 已部署函数：`patients`（含 `create` / `list` / `get`）
- 小程序端已联调 `pages/patients/form`

## 用例
1) 成功创建
   - 输入：`name=张三`，`id_card=110105199001011234`（校验位正确），`phone=13900000000`（可选），`birthDate=1990-01-01`
   - 期望：提交成功，Toast“创建成功”，返回 `_id`；列表可见

2) 身份证校验位错误
   - 输入：`id_card=110105199001011233`（校验位错误）
   - 期望（前端）：内联提示“身份证格式或校验位错误”，禁止提交
   - 若绕过前端（构造请求）：后端返回 `{ ok:false, error:{ code:'E_VALIDATE', msg:'身份证格式或校验位错误' } }`；前端 Toast 显示该具体 msg

3) 出生日期晚于今日
   - 输入：`birthDate=2999-01-01`
   - 期望：后端返回 `E_VALIDATE: 出生日期需早于或等于今日`；前端 Toast 显示具体 msg

4) 唯一冲突
   - 前置：已存在 `id_card=110105199001011234`
   - 输入：再次用相同 `id_card`
   - 期望：后端返回 `E_CONFLICT`；前端弹窗提示并提供“去搜索”，跳转 `patients/search?keyword=尾4&mode=tail`

5) 弱网重试/草稿
   - 操作：提交过程中断网，或模拟 `E_INTERNAL`/`E_DEPENDENCY`
   - 期望：Toast 友好提示；可再次提交；（如接入草稿）草稿未丢失

## 验证步骤
- 后端：
  - 通过云函数测试面板/命令行调用 `patients.create` 验证 2)/3)/4)
  - 查看 `Patients` 集合数据与唯一索引是否生效
- 前端：
  - 在 `pages/patients/form` 逐条执行 1)~4) 操作
  - 观察内联错误、Toast 文案、冲突跳转是否符合验收标准

## 记录
- 通过/失败：逐条打勾并记录截图/日志
- 问题单：缺陷编号、重现路径、日志（含 requestId）

