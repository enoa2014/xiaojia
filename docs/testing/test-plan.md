# 测试计划（MVP）

## 范围与目标
- 验证 Sprint 1 已完成的 8 个用户故事功能完整性、安全性与性能
- 覆盖关键角色路径：管理员/社工/志愿者
- 确保数据脱敏、权限控制、审计日志等安全机制有效

## 策略与层次

### 单元测试
- 云函数参数校验逻辑（Zod Schema）
- 业务规则验证（身份证校验位、日期范围等）
- 权限控制逻辑（RBAC + 字段级脱敏）
- 错误码映射和错误处理

### 集成测试
- 云函数与数据库交互（CRUD + 索引性能）
- 权限申请与患者详情查询的联动
- 服务记录审核流程的状态流转
- 活动报名的容量控制与候补机制

### 端到端测试
- 完整业务流程：患者建档→服务记录→权限申请→审批→查看明文
- 角色切换场景：不同角色的功能权限验证
- 异常处理：网络异常、权限不足、数据冲突的用户体验

### 安全测试
- 敏感数据脱敏有效性
- 权限绕过尝试（直接API调用）
- 审计日志完整性和准确性
- TTL权限过期自动回收

### 性能测试
- 列表查询性能（>100条数据）
- 并发操作一致性（报名容量控制）
- 数据库索引利用率验证

## 环境与数据

### 测试环境
- **环境ID**：`cloud1-3grb87gwaba26b64`
- **数据隔离**：使用测试前缀避免污染生产数据
- **用户角色**：配置完整的角色测试账户

### 测试数据集
- **患者数据**：≥50条，包含各种边界情况（特殊字符、边界日期等）
- **服务记录**：各种类型和状态的服务记录
- **活动数据**：不同容量和状态的活动
- **权限申请**：各种状态和字段组合的权限申请

## 通过门槛

### 功能完整性
- **关键用户路径通过率**：100%（无阻断性缺陷）
- **边界用例通过率**：≥95%
- **错误处理覆盖率**：100%（所有错误码场景验证）

### 安全要求
- **权限控制**：无权限绕过漏洞
- **数据脱敏**：敏感字段默认脱敏率 100%
- **审计完整性**：敏感操作审计记录率 100%

### 性能指标
- **API响应时间**：P95 ≤ 500ms
- **列表查询**：≤ 1.5s（含网络传输）
- **并发操作**：数据一致性保证 100%

## Sprint 1 完整测试用例清单

### EP-01 患者档案管理
- **EP-01-S1**：[患者建档（身份证唯一去重）](./cases/EP-01-S1-patient-create-unique-id.md) ✅
- **EP-01-S2**：[患者查看（脱敏/审批窗口明文）](./cases/EP-01-S2-patient-view-masking.md) ✅
- **EP-01-S3**：[患者搜索筛选](./cases/EP-01-S3-patient-search-filtering.md) ✅

### EP-03 服务记录管理  
- **EP-03-S1**：[志愿者提交服务记录](./cases/EP-03-S1-service-record-creation.md) ✅
- **EP-03-S2**：[社工审核服务记录](./cases/EP-03-S2-service-review-workflow.md) ✅

### EP-04 活动与报名管理
- **EP-04-S1**：[活动发布与列表](./cases/EP-04-S1-activity-creation-listing.md) ✅
- **EP-04-S2**：[报名/取消/签到流程](./cases/EP-04-S2-registration-workflow.md) ✅

### EP-06 权限与安全
- **EP-06-S1**：[字段级权限申请与审批](./cases/EP-06-S1-permission-request-approval.md) ✅

## 关键测试场景矩阵

| 功能模块 | 成功路径 | 错误处理 | 权限控制 | 性能验证 | 安全审计 |
|---------|---------|---------|---------|---------|---------|
| 患者建档 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 患者查看 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 患者搜索 | ✓ | ✓ | ✓ | ✓ | - |
| 服务记录 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 服务审核 | ✓ | ✓ | ✓ | - | ✓ |
| 活动管理 | ✓ | ✓ | ✓ | ✓ | - |
| 活动报名 | ✓ | ✓ | ✓ | ✓ | - |
| 权限申请 | ✓ | ✓ | ✓ | - | ✓ |

## 测试执行流程

### 阶段1：单元/集成测试（2天）
1. 云函数参数校验和业务逻辑验证
2. 数据库交互和索引性能验证
3. 权限控制机制验证

### 阶段2：端到端测试（2天）  
1. 完整业务流程验证
2. 角色权限场景验证
3. 异常情况用户体验验证

### 阶段3：安全/性能测试（1天）
1. 权限绕过尝试和数据脱敏验证
2. 并发操作和性能压力测试
3. 审计日志完整性验证

### 阶段4：回归验证（1天）
1. 缺陷修复后的回归测试
2. 完整测试报告生成
3. 发布准备度评估

## 工具与集成

### 测试工具栈
- **云函数测试**：微信开发者工具 + CloudBase CLI
- **API测试**：Postman/Thunder 集合（参考 docs/api/mocks/）
- **端到端测试**：微信开发者工具自动化脚本
- **性能测试**：CloudBase 控制台监控 + 自定义计时

### 数据管理
- **种子数据**：使用 init-db + 测试数据脚本初始化
- **数据重置**：每轮测试前清理和重建测试数据
- **数据验证**：测试后验证数据完整性和一致性

### 日志追踪
- **请求追踪**：requestId 全链路追踪
- **错误监控**：函数错误日志和错误码统计
- **性能监控**：响应时间和资源使用监控

## 埋点校验（Analytics）

目标：确保关键用户路径产生预期埋点事件，属性完整可用，便于后续分析与告警。

- Tenancy Create（EP-02-S1）
  - 事件：`tenancy_create_submit`、`tenancy_create_result`
  - 校验：每次提交各触发一次；`submit` 含 `hasPatientId/hasIdCard/hasRoom/hasBed`；`result` 含 `requestId`、`duration>0`、`code ∈ {'OK'|错误码}`。
- Tenancy Checkout（EP-02-S2）
  - 事件：`tenancy_checkout_submit`、`tenancy_checkout_result`
  - 校验：同上；`tenancyId` 传递正确。
- Service Create（EP-03-S1）
  - 事件：`service_submit_click`、`service_submit_result`
  - 校验：`submit` 含 `type`、`imagesCount`；`result` 含 `requestId`、`duration`、`code`。
- Activities Create/List（EP-04-S1）
  - 事件：`activity_create_submit`、`activity_create_result`；`activities_list_view`
  - 校验：`create.*` 含 `status/capacity` 与结果属性；`list_view` 含 `statusTab`、`count`、`duration`。
- Permission Request（EP-06-S1）
  - 事件：`perm_request_submit`、`perm_request_result`
  - 校验：`submit` 含 `fields`、`expiresDays`、`length`；`result` 含 `requestId`、`duration`、`code`。

执行方法：
- 微信开发者工具“性能/自定义上报”或控制台日志（降级）观察；或在 `wx.reportAnalytics` 配置后台查看事件采样。
- 失败重试仅产生一次 `result` 事件；幂等成功同样只记录一次 `result:OK`。

## 风险缓解

### 高风险场景
1. **权限绕过**：重点验证直接API调用的权限控制
2. **数据泄露**：确保脱敏机制在各种场景下有效
3. **并发冲突**：验证报名容量控制的并发安全性

### 测试环境风险
1. **数据污染**：严格使用测试数据，避免影响生产
2. **环境一致性**：确保测试环境配置与生产环境一致
3. **性能差异**：测试环境性能指标需要适当调整

## 交付标准

### 必须达成
- [ ] 所有测试用例执行完毕，通过率达标
- [ ] 安全测试无高危漏洞
- [ ] 性能指标满足要求
- [ ] 完整的测试报告和缺陷清单

### 建议达成  
- [ ] 自动化测试脚本覆盖核心流程
- [ ] 性能基准数据建立
- [ ] 测试数据集可复用

## 后续改进

### 测试自动化
- 核心API的自动化测试脚本
- 数据驱动的参数化测试
- 持续集成中的自动化回归

### 测试数据
- 更大规模的性能测试数据集
- 更多边界情况的测试用例
- 生产数据脱敏后的测试验证
