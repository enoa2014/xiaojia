<view class="page">
  <!-- 顶部导航（对齐首页样式） -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">📅 活动中心</view>
    <view class="nav-actions">
      <!-- 导航操作按钮可在此添加，如搜索、筛选等 -->
    </view>
  </view>

  <!-- 活动类型快捷入口 -->
  <view class="activity-types-section">
    <view class="section-header">
      <text class="section-title">活动类型</text>
      <text class="section-subtitle">选择感兴趣的活动类型</text>
    </view>
    
    <view class="types-grid">
      <action-card
        wx:for="{{activityTypes}}"
        wx:key="key"
        title="{{item.name}}"
        desc="{{item.count}}个活动"
        icon="{{item.icon}}"
        custom-data="{{item}}"
        bindtap="filterByType"
        data-type="{{item.key}}"
        class="activity-type-card">
      </action-card>
    </view>
  </view>

  <!-- 筛选和搜索区域 -->
  <view class="filter-section">
    <view class="search-container">
      <view class="search-bar {{searchKeyword ? 'active' : ''}}">
        <text class="search-icon">🔍</text>
        <input class="search-input" 
               placeholder="搜索活动名称或关键词"
               value="{{searchKeyword}}"
               bindinput="onSearchInput"
               bindconfirm="performSearch" />
        <ui-button 
          wx:if="{{searchKeyword}}"
          ext-class="clear-btn"
          variant="ghost"
          size="sm"
          icon="✕"
          aria-label="清除搜索"
          catchtap="clearSearch">
        </ui-button>
      </view>
      <ui-button 
        ext-class="filter-btn"
        variant="secondary"
        size="sm"
        icon="🏷️"
        aria-label="筛选"
        bindtap="showFilterOptions">
      </ui-button>
      <ui-button 
        ext-class="view-mode-btn"
        variant="secondary"
        size="sm"
        icon="{{viewMode === 'list' ? '📅' : '📋'}}"
        aria-label="切换视图"
        bindtap="toggleViewMode">
      </ui-button>
    </view>
    
    <view class="filter-tabs">
      <view class="tabs-container">
        <scroll-view class="tabs-scroll" scroll-x="true">
          <view class="tabs-list">
            <view class="tab {{item.key===activeFilter?'active':''}}"
                  wx:for="{{filterTabs}}"
                  wx:key="key"
                  data-key="{{item.key}}"
                  bindtap="switchFilter">
              <text class="tab-text">{{item.label}}</text>
              <text class="tab-count" wx:if="{{item.count}}">{{item.count}}</text>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>

  <!-- 日历视图 -->
  <view class="calendar-section" wx:if="{{viewMode === 'calendar'}}">
    <!-- 骨架屏 -->
    <loading-skeleton
      wx:if="{{showSkeleton}}"
      id="loading-skeleton"
      show="{{showSkeleton}}"
      type="calendar"
      count="1">
    </loading-skeleton>
    
    <!-- 错误状态 -->
    <error-view
      wx:elif="{{error && !loading}}"
      show="{{true}}"
      error="{{error}}"
      retry-text="重新加载"
      feedback-text="反馈问题"
      bindretry="retryLoad"
      bindfeedback="onErrorFeedback">
    </error-view>
    
    <!-- 空状态 -->
    <empty-state
      wx:elif="{{!loading && calendarActivities.length === 0}}"
      show="{{true}}"
      icon="📅"
      title="暂无{{activeFilterLabel}}活动"
      description="{{searchKeyword ? '尝试调整搜索条件' : '选择其他日期查看活动'}}"
      action-text="{{searchKeyword ? '清除搜索条件' : '回到今天'}}"
      action-icon="🔄"
      bindaction="onCalendarEmptyAction">
    </empty-state>
    
    <!-- 日历组件 -->
    <calendar-view
      wx:else
      view-mode="{{calendarViewMode}}"
      current-date="{{selectedDate}}"
      activities="{{calendarActivities}}"
      status-filter="{{filterOptions.status}}"
      show-today="{{true}}"
      bindviewModeChange="onCalendarViewModeChange"
      binddateChange="onCalendarDateChange"
      binddateSelect="onCalendarDateSelect"
      bindactivityTap="onCalendarActivityTap"
      bindregisterTap="onCalendarRegisterTap"
      bindcheckInTap="onCalendarCheckInTap">
    </calendar-view>
  </view>

  <!-- 活动列表 -->
  <view class="activities-list" wx:if="{{viewMode === 'list'}}">
    <!-- 加载状态（统一组件：loading-skeleton） -->
    <loading-skeleton
      wx:if="{{loading}}"
      id="loading-skeleton-list"
      show="{{loading}}"
      type="list"
      count="5"
      animation="shimmer">
    </loading-skeleton>

    <!-- 空状态 -->
    <empty-state
      wx:if="{{!loading && list.length === 0}}"
      show="{{true}}"
      icon="📅"
      title="暂无{{activeFilterLabel}}活动"
      description="{{searchKeyword ? '尝试调整搜索条件' : '等待更多精彩活动发布'}}"
      action-text="{{searchKeyword ? '清除搜索条件' : ''}}"
      action-icon="🔄"
      bindaction="onEmptyAction">
    </empty-state>

    <!-- 错误状态 -->
    <error-view
      wx:if="{{error && !loading}}"
      show="{{true}}"
      error="{{error}}"
      retry-text="重新加载"
      feedback-text="反馈问题"
      bindretry="retryLoad"
      bindfeedback="onErrorFeedback">
    </error-view>

    <!-- 活动卡片列表 -->
    <view class="activity-cards" wx:if="{{!loading && !error && list.length > 0}}">
      <view class="activity-card" 
            wx:for="{{list}}" 
            wx:key="_id"
            bindtap="toDetail" 
            data-id="{{item._id}}">
        
        <!-- 活动头部信息 -->
        <view class="card-header">
          <view class="activity-type" style="background-color: {{item.typeColor}};">
            <text class="type-icon">{{item.typeIcon}}</text>
          </view>
          <view class="header-content">
            <text class="activity-title">{{item.title}}</text>
            <view class="activity-meta">
              <text class="meta-item">{{item.organizerName}}</text>
              <text class="meta-divider">·</text>
              <text class="meta-item">{{item.createdTimeText}}</text>
            </view>
          </view>
          <view class="card-status status-{{item.status}}">
            <text class="status-text">{{item.statusText}}</text>
          </view>
        </view>

        <!-- 活动详细信息 -->
        <view class="card-body">
          <text class="activity-description">{{item.description}}</text>
          
          <view class="activity-details">
            <view class="detail-item" wx:if="{{item.startTime}}">
              <text class="detail-icon">🕒</text>
              <text class="detail-text">{{item.startTimeText}}</text>
            </view>
            
            <view class="detail-item" wx:if="{{item.location}}">
              <text class="detail-icon">📍</text>
              <text class="detail-text">{{item.location}}</text>
            </view>
            
            <view class="detail-item" wx:if="{{item.capacity}}">
              <text class="detail-icon">👥</text>
              <text class="detail-text">容量 {{item.registeredCount || 0}}/{{item.capacity}}</text>
            </view>
            
            <view class="detail-item" wx:if="{{item.fee !== null && item.fee !== undefined}}">
              <text class="detail-icon">💰</text>
              <text class="detail-text">{{item.fee === 0 ? '免费' : '¥' + item.fee}}</text>
            </view>
          </view>
        </view>

        <!-- 活动操作区域 -->
        <view class="card-footer">
          <view class="activity-tags">
            <text class="activity-tag" wx:for="{{item.tags}}" wx:key="*this">{{item}}</text>
          </view>
          
          <view class="card-actions">
            <!-- 报名按钮（统一 ui-button） -->
            <ui-button 
              wx:if="{{item.canRegister}}"
              ext-class="action-btn register-btn"
              variant="primary"
              size="md"
              icon="✋"
              text="报名"
              catchtap="registerActivity"
              data-id="{{item._id}}"
              touchEnhanced="{{true}}">
            </ui-button>
            
            <!-- 已报名状态 -->
            <view class="action-status registered" wx:elif="{{item.isRegistered}}">
              <text class="status-icon">✅</text>
              <text class="status-text">已报名</text>
            </view>
            
            <!-- 查看详情按钮（统一 ui-button） -->
            <ui-button 
              ext-class="action-btn detail-btn"
              variant="secondary"
              size="md"
              text="查看详情"
              iconRight="〉"
              catchtap="toDetail"
              data-id="{{item._id}}"
              touchEnhanced="{{true}}">
            </ui-button>
          </view>
        </view>

        <!-- 数据脱敏遮罩（针对特定角色） -->
        <view class="privacy-mask" wx:if="{{item.needPrivacyMask}}">
          <text class="mask-text">部分信息已隐藏</text>
        </view>
      </view>
    </view>

    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{!loading && hasMore && list.length > 0}}">
      <ui-button 
        ext-class="load-more-btn"
        variant="secondary"
        size="md"
        text="{{loadingMore ? '加载中...' : '加载更多'}}"
        loading="{{loadingMore}}"
        bindtap="loadMore"
        fullWidth="{{true}}"
        touchEnhanced="{{true}}">
      </ui-button>
    </view>
  </view>

  <!-- 浮动操作按钮 -->
  <view class="floating-fab" wx:if="{{canCreateActivity}}" bindtap="toCreate">
    <text class="fab-icon">➕</text>
  </view>
</view>



<!-- 筛选选项弹窗 -->
<view class="filter-modal {{showFilterModal ? 'show' : ''}}" catchtap="hideFilterModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">筛选条件</text>
      <ui-button 
        ext-class="modal-close"
        variant="ghost"
        size="sm"
        icon="✕"
        aria-label="关闭"
        bindtap="hideFilterModal">
      </ui-button>
    </view>
    
    <view class="modal-body">
      <view class="filter-group">
        <text class="group-title">活动类型</text>
        <view class="filter-options">
          <view class="filter-option {{filterOptions.type === item.key ? 'active' : ''}}"
                wx:for="{{activityTypes}}"
                wx:key="key"
                data-type="{{item.key}}"
                bindtap="selectFilterType">
            <text class="option-icon">{{item.icon}}</text>
            <text class="option-text">{{item.name}}</text>
          </view>
        </view>
      </view>
      
      <view class="filter-group">
        <text class="group-title">活动时间</text>
        <view class="filter-options">
          <view class="filter-option {{filterOptions.time === item.key ? 'active' : ''}}"
                wx:for="{{timeFilters}}"
                wx:key="key"
                data-time="{{item.key}}"
                bindtap="selectFilterTime">
            <text class="option-text">{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <view class="filter-group">
        <text class="group-title">活动状态</text>
        <view class="filter-options">
          <view class="filter-option {{filterOptions.status === item.key ? 'active' : ''}}"
                wx:for="{{statusFilters}}"
                wx:key="key"
                data-status="{{item.key}}"
                bindtap="selectFilterStatus">
            <text class="option-text">{{item.label}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="modal-actions">
      <ui-button 
        ext-class="modal-btn"
        variant="secondary"
        size="md"
        text="重置"
        fullWidth
        bindtap="resetFilters">
      </ui-button>
      <ui-button 
        ext-class="modal-btn"
        variant="primary"
        size="md"
        text="应用筛选"
        fullWidth
        bindtap="applyFilters">
      </ui-button>
    </view>
  </view>
</view>
