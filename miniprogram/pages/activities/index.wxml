<view class="page">
  <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆå¯¹é½é¦–é¡µæ ·å¼ï¼‰ -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">ğŸ“… æ´»åŠ¨ä¸­å¿ƒ</view>
    <view class="nav-actions">
      <!-- å¯¼èˆªæ“ä½œæŒ‰é’®å¯åœ¨æ­¤æ·»åŠ ï¼Œå¦‚æœç´¢ã€ç­›é€‰ç­‰ -->
    </view>
  </view>

  <!-- æ´»åŠ¨ç±»å‹å¿«æ·å…¥å£ -->
  <view class="activity-types-section">
    <view class="section-header">
      <text class="section-title">æ´»åŠ¨ç±»å‹</text>
      <text class="section-subtitle">é€‰æ‹©æ„Ÿå…´è¶£çš„æ´»åŠ¨ç±»å‹</text>
    </view>
    
    <view class="types-grid">
      <action-card
        wx:for="{{activityTypes}}"
        wx:key="key"
        title="{{item.name}}"
        desc="{{item.count}}ä¸ªæ´»åŠ¨"
        icon="{{item.icon}}"
        custom-data="{{item}}"
        bindtap="filterByType"
        data-type="{{item.key}}"
        class="activity-type-card">
      </action-card>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæœç´¢åŒºåŸŸ -->
  <view class="filter-section">
    <view class="search-container">
      <view class="search-bar {{searchKeyword ? 'active' : ''}}">
        <text class="search-icon">ğŸ”</text>
        <input class="search-input" 
               placeholder="æœç´¢æ´»åŠ¨åç§°æˆ–å…³é”®è¯"
               value="{{searchKeyword}}"
               bindinput="onSearchInput"
               bindconfirm="performSearch" />
        <ui-button 
          wx:if="{{searchKeyword}}"
          ext-class="clear-btn"
          variant="ghost"
          size="sm"
          icon="âœ•"
          aria-label="æ¸…é™¤æœç´¢"
          catchtap="clearSearch">
        </ui-button>
      </view>
      <ui-button 
        ext-class="filter-btn"
        variant="secondary"
        size="sm"
        icon="ğŸ·ï¸"
        aria-label="ç­›é€‰"
        bindtap="showFilterOptions">
      </ui-button>
      <ui-button 
        ext-class="view-mode-btn"
        variant="secondary"
        size="sm"
        icon="{{viewMode === 'list' ? 'ğŸ“…' : 'ğŸ“‹'}}"
        aria-label="åˆ‡æ¢è§†å›¾"
        bindtap="toggleViewMode">
      </ui-button>
    </view>
    
    <view class="filter-tabs">
      <view class="tabs-container">
        <scroll-view class="tabs-scroll" scroll-x="true">
          <view class="tabs-list">
            <view class="tab {{item.key===activeFilter?'active':''}}"
                  wx:for="{{filterTabs}}"
                  wx:key="key"
                  data-key="{{item.key}}"
                  bindtap="switchFilter">
              <text class="tab-text">{{item.label}}</text>
              <text class="tab-count" wx:if="{{item.count}}">{{item.count}}</text>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>

  <!-- æ—¥å†è§†å›¾ -->
  <view class="calendar-section" wx:if="{{viewMode === 'calendar'}}">
    <!-- éª¨æ¶å± -->
    <loading-skeleton
      wx:if="{{showSkeleton}}"
      id="loading-skeleton"
      show="{{showSkeleton}}"
      type="calendar"
      count="1">
    </loading-skeleton>
    
    <!-- é”™è¯¯çŠ¶æ€ -->
    <error-view
      wx:elif="{{error && !loading}}"
      show="{{true}}"
      error="{{error}}"
      retry-text="é‡æ–°åŠ è½½"
      feedback-text="åé¦ˆé—®é¢˜"
      bindretry="retryLoad"
      bindfeedback="onErrorFeedback">
    </error-view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <empty-state
      wx:elif="{{!loading && calendarActivities.length === 0}}"
      show="{{true}}"
      icon="ğŸ“…"
      title="æš‚æ— {{activeFilterLabel}}æ´»åŠ¨"
      description="{{searchKeyword ? 'å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶' : 'é€‰æ‹©å…¶ä»–æ—¥æœŸæŸ¥çœ‹æ´»åŠ¨'}}"
      action-text="{{searchKeyword ? 'æ¸…é™¤æœç´¢æ¡ä»¶' : 'å›åˆ°ä»Šå¤©'}}"
      action-icon="ğŸ”„"
      bindaction="onCalendarEmptyAction">
    </empty-state>
    
    <!-- æ—¥å†ç»„ä»¶ -->
    <calendar-view
      wx:else
      view-mode="{{calendarViewMode}}"
      current-date="{{selectedDate}}"
      activities="{{calendarActivities}}"
      status-filter="{{filterOptions.status}}"
      show-today="{{true}}"
      bindviewModeChange="onCalendarViewModeChange"
      binddateChange="onCalendarDateChange"
      binddateSelect="onCalendarDateSelect"
      bindactivityTap="onCalendarActivityTap"
      bindregisterTap="onCalendarRegisterTap"
      bindcheckInTap="onCalendarCheckInTap">
    </calendar-view>
  </view>

  <!-- æ´»åŠ¨åˆ—è¡¨ -->
  <view class="activities-list" wx:if="{{viewMode === 'list'}}">
    <!-- åŠ è½½çŠ¶æ€ï¼ˆç»Ÿä¸€ç»„ä»¶ï¼šloading-skeletonï¼‰ -->
    <loading-skeleton
      wx:if="{{loading}}"
      id="loading-skeleton-list"
      show="{{loading}}"
      type="list"
      count="5"
      animation="shimmer">
    </loading-skeleton>

    <!-- ç©ºçŠ¶æ€ -->
    <empty-state
      wx:if="{{!loading && list.length === 0}}"
      show="{{true}}"
      icon="ğŸ“…"
      title="æš‚æ— {{activeFilterLabel}}æ´»åŠ¨"
      description="{{searchKeyword ? 'å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶' : 'ç­‰å¾…æ›´å¤šç²¾å½©æ´»åŠ¨å‘å¸ƒ'}}"
      action-text="{{searchKeyword ? 'æ¸…é™¤æœç´¢æ¡ä»¶' : ''}}"
      action-icon="ğŸ”„"
      bindaction="onEmptyAction">
    </empty-state>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <error-view
      wx:if="{{error && !loading}}"
      show="{{true}}"
      error="{{error}}"
      retry-text="é‡æ–°åŠ è½½"
      feedback-text="åé¦ˆé—®é¢˜"
      bindretry="retryLoad"
      bindfeedback="onErrorFeedback">
    </error-view>

    <!-- æ´»åŠ¨å¡ç‰‡åˆ—è¡¨ -->
    <view class="activity-cards" wx:if="{{!loading && !error && list.length > 0}}">
      <view class="activity-card" 
            wx:for="{{list}}" 
            wx:key="_id"
            bindtap="toDetail" 
            data-id="{{item._id}}">
        
        <!-- æ´»åŠ¨å¤´éƒ¨ä¿¡æ¯ -->
        <view class="card-header">
          <view class="activity-type" style="background-color: {{item.typeColor}};">
            <text class="type-icon">{{item.typeIcon}}</text>
          </view>
          <view class="header-content">
            <text class="activity-title">{{item.title}}</text>
            <view class="activity-meta">
              <text class="meta-item">{{item.organizerName}}</text>
              <text class="meta-divider">Â·</text>
              <text class="meta-item">{{item.createdTimeText}}</text>
            </view>
          </view>
          <view class="card-status status-{{item.status}}">
            <text class="status-text">{{item.statusText}}</text>
          </view>
        </view>

        <!-- æ´»åŠ¨è¯¦ç»†ä¿¡æ¯ -->
        <view class="card-body">
          <text class="activity-description">{{item.description}}</text>
          
          <view class="activity-details">
            <view class="detail-item" wx:if="{{item.startTime}}">
              <text class="detail-icon">ğŸ•’</text>
              <text class="detail-text">{{item.startTimeText}}</text>
            </view>
            
            <view class="detail-item" wx:if="{{item.location}}">
              <text class="detail-icon">ğŸ“</text>
              <text class="detail-text">{{item.location}}</text>
            </view>
            
            <view class="detail-item" wx:if="{{item.capacity}}">
              <text class="detail-icon">ğŸ‘¥</text>
              <text class="detail-text">å®¹é‡ {{item.registeredCount || 0}}/{{item.capacity}}</text>
            </view>
            
            <view class="detail-item" wx:if="{{item.fee !== null && item.fee !== undefined}}">
              <text class="detail-icon">ğŸ’°</text>
              <text class="detail-text">{{item.fee === 0 ? 'å…è´¹' : 'Â¥' + item.fee}}</text>
            </view>
          </view>
        </view>

        <!-- æ´»åŠ¨æ“ä½œåŒºåŸŸ -->
        <view class="card-footer">
          <view class="activity-tags">
            <text class="activity-tag" wx:for="{{item.tags}}" wx:key="*this">{{item}}</text>
          </view>
          
          <view class="card-actions">
            <!-- æŠ¥åæŒ‰é’®ï¼ˆç»Ÿä¸€ ui-buttonï¼‰ -->
            <ui-button 
              wx:if="{{item.canRegister}}"
              ext-class="action-btn register-btn"
              variant="primary"
              size="md"
              icon="âœ‹"
              text="æŠ¥å"
              catchtap="registerActivity"
              data-id="{{item._id}}"
              touchEnhanced="{{true}}">
            </ui-button>
            
            <!-- å·²æŠ¥åçŠ¶æ€ -->
            <view class="action-status registered" wx:elif="{{item.isRegistered}}">
              <text class="status-icon">âœ…</text>
              <text class="status-text">å·²æŠ¥å</text>
            </view>
            
            <!-- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ï¼ˆç»Ÿä¸€ ui-buttonï¼‰ -->
            <ui-button 
              ext-class="action-btn detail-btn"
              variant="secondary"
              size="md"
              text="æŸ¥çœ‹è¯¦æƒ…"
              iconRight="ã€‰"
              catchtap="toDetail"
              data-id="{{item._id}}"
              touchEnhanced="{{true}}">
            </ui-button>
          </view>
        </view>

        <!-- æ•°æ®è„±æ•é®ç½©ï¼ˆé’ˆå¯¹ç‰¹å®šè§’è‰²ï¼‰ -->
        <view class="privacy-mask" wx:if="{{item.needPrivacyMask}}">
          <text class="mask-text">éƒ¨åˆ†ä¿¡æ¯å·²éšè—</text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{!loading && hasMore && list.length > 0}}">
      <ui-button 
        ext-class="load-more-btn"
        variant="secondary"
        size="md"
        text="{{loadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}"
        loading="{{loadingMore}}"
        bindtap="loadMore"
        fullWidth="{{true}}"
        touchEnhanced="{{true}}">
      </ui-button>
    </view>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="floating-fab" wx:if="{{canCreateActivity}}" bindtap="toCreate">
    <text class="fab-icon">â•</text>
  </view>
</view>



<!-- ç­›é€‰é€‰é¡¹å¼¹çª— -->
<view class="filter-modal {{showFilterModal ? 'show' : ''}}" catchtap="hideFilterModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç­›é€‰æ¡ä»¶</text>
      <ui-button 
        ext-class="modal-close"
        variant="ghost"
        size="sm"
        icon="âœ•"
        aria-label="å…³é—­"
        bindtap="hideFilterModal">
      </ui-button>
    </view>
    
    <view class="modal-body">
      <view class="filter-group">
        <text class="group-title">æ´»åŠ¨ç±»å‹</text>
        <view class="filter-options">
          <view class="filter-option {{filterOptions.type === item.key ? 'active' : ''}}"
                wx:for="{{activityTypes}}"
                wx:key="key"
                data-type="{{item.key}}"
                bindtap="selectFilterType">
            <text class="option-icon">{{item.icon}}</text>
            <text class="option-text">{{item.name}}</text>
          </view>
        </view>
      </view>
      
      <view class="filter-group">
        <text class="group-title">æ´»åŠ¨æ—¶é—´</text>
        <view class="filter-options">
          <view class="filter-option {{filterOptions.time === item.key ? 'active' : ''}}"
                wx:for="{{timeFilters}}"
                wx:key="key"
                data-time="{{item.key}}"
                bindtap="selectFilterTime">
            <text class="option-text">{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <view class="filter-group">
        <text class="group-title">æ´»åŠ¨çŠ¶æ€</text>
        <view class="filter-options">
          <view class="filter-option {{filterOptions.status === item.key ? 'active' : ''}}"
                wx:for="{{statusFilters}}"
                wx:key="key"
                data-status="{{item.key}}"
                bindtap="selectFilterStatus">
            <text class="option-text">{{item.label}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="modal-actions">
      <ui-button 
        ext-class="modal-btn"
        variant="secondary"
        size="md"
        text="é‡ç½®"
        fullWidth
        bindtap="resetFilters">
      </ui-button>
      <ui-button 
        ext-class="modal-btn"
        variant="primary"
        size="md"
        text="åº”ç”¨ç­›é€‰"
        fullWidth
        bindtap="applyFilters">
      </ui-button>
    </view>
  </view>
</view>
