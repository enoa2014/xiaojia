<view class="service-detail-page" wx:if="{{!loading}}">
  <!-- å¯¼èˆªå¤´éƒ¨åŒº -->
  <view class="nav-header {{theme.headerBg}}">
    <view class="nav-left" bindtap="navigateBack">
      <text class="nav-icon">â†</text>
      <view class="nav-title">ğŸ§° æœåŠ¡è®°å½•è¯¦æƒ…</view>
    </view>
    <view class="nav-actions" wx:if="{{canEdit}}">
      <view class="nav-tool" bindtap="editRecord">
        <text class="nav-icon">âœï¸</text>
      </view>
      <view class="nav-tool" bindtap="showMoreActions">
        <text class="nav-icon">â‹¯</text>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡è®°å½•çŠ¶æ€æ¡ -->
  <view class="status-banner status-{{record.status}}">
    <view class="status-content">
      <text class="status-icon">{{statusConfig[record.status].icon}}</text>
      <view class="status-text">
        <text class="status-title">{{statusConfig[record.status].title}}</text>
        <text class="status-desc">{{statusConfig[record.status].desc}}</text>
      </view>
      <view class="status-time" wx:if="{{record.statusTime}}">
        <text class="time-text">{{record.statusTimeText}}</text>
      </view>
    </view>
    
    <!-- å®¡æ ¸æ“ä½œæŒ‰é’® -->
    <view class="review-actions" wx:if="{{canReview && record.status === 'pending'}}">
      <button class="review-btn approve-btn" bindtap="approveRecord" loading="{{reviewing}}">
        <text class="btn-icon">âœ…</text>
        <text class="btn-text">é€šè¿‡</text>
      </button>
      <button class="review-btn reject-btn" bindtap="rejectRecord" loading="{{reviewing}}">
        <text class="btn-icon">âŒ</text>
        <text class="btn-text">é©³å›</text>
      </button>
    </view>
  </view>

  <!-- åŸºç¡€ä¿¡æ¯å¡ç‰‡ -->
  <view class="info-card basic-info">
    <view class="card-header">
      <text class="card-title">åŸºç¡€ä¿¡æ¯</text>
      <text class="card-id">ID: {{record.id}}</text>
    </view>
    
    <view class="info-grid">
      <view class="info-item">
        <text class="info-label">æœåŠ¡ç±»å‹</text>
        <view class="info-value service-type">
          <text class="type-icon" style="background-color: {{record.typeColor}};">{{record.typeIcon}}</text>
          <text class="type-name">{{record.typeName}}</text>
        </view>
      </view>
      
      <view class="info-item">
        <text class="info-label">æœåŠ¡å¯¹è±¡</text>
        <view class="info-value patient-info">
          <text class="patient-name">{{record.patientName}}</text>
          <text class="patient-meta">{{record.patientAge}}å² Â· {{record.patientCondition}}</text>
        </view>
      </view>
      
      <view class="info-item">
        <text class="info-label">æœåŠ¡æ—¶é—´</text>
        <text class="info-value">{{record.serviceDateTimeText}}</text>
      </view>
      
      <view class="info-item" wx:if="{{record.location}}">
        <text class="info-label">æœåŠ¡åœ°ç‚¹</text>
        <text class="info-value">{{record.location}}</text>
      </view>
      
      <view class="info-item">
        <text class="info-label">æœåŠ¡äººå‘˜</text>
        <view class="info-value volunteer-info">
          <text class="volunteer-name">{{record.volunteerName}}</text>
          <text class="volunteer-role">{{record.volunteerRole}}</text>
        </view>
      </view>
      
      <view class="info-item">
        <text class="info-label">åˆ›å»ºæ—¶é—´</text>
        <text class="info-value">{{record.createdAtText}}</text>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡å†…å®¹å¡ç‰‡ -->
  <view class="info-card service-content">
    <view class="card-header">
      <text class="card-title">æœåŠ¡å†…å®¹</text>
    </view>
    
    <view class="content-body">
      <text class="content-text">{{record.description}}</text>
    </view>
    
    <!-- æœåŠ¡ç›®æ ‡ -->
    <view class="content-section" wx:if="{{record.objectives}}">
      <text class="section-title">æœåŠ¡ç›®æ ‡</text>
      <text class="section-content">{{record.objectives}}</text>
    </view>
    
    <!-- æœåŠ¡æˆæœ -->
    <view class="content-section" wx:if="{{record.outcomes}}">
      <text class="section-title">æœåŠ¡æˆæœ</text>
      <text class="section-content">{{record.outcomes}}</text>
    </view>
    
    <!-- åç»­è®¡åˆ’ -->
    <view class="content-section" wx:if="{{record.followUp}}">
      <text class="section-title">åç»­è®¡åˆ’</text>
      <text class="section-content">{{record.followUp}}</text>
    </view>
  </view>

  <!-- é™„ä»¶å¡ç‰‡ -->
  <view class="info-card attachments-card" wx:if="{{record.attachments && record.attachments.length > 0}}">
    <view class="card-header">
      <text class="card-title">ç›¸å…³é™„ä»¶</text>
      <text class="card-subtitle">{{record.attachments.length}}ä¸ªæ–‡ä»¶</text>
    </view>
    
    <view class="attachments-grid">
      <view class="attachment-item" wx:for="{{record.attachments}}" wx:key="index">
        <!-- å›¾ç‰‡é™„ä»¶ -->
        <view class="attachment-image" wx:if="{{item.type === 'image'}}" bindtap="previewImage" data-index="{{index}}">
          <image class="image-thumbnail" src="{{item.thumbnail || item.url}}" mode="aspectFill" />
          <view class="image-overlay">
            <text class="overlay-icon">ğŸ”</text>
          </view>
        </view>
        
        <!-- æ–‡æ¡£é™„ä»¶ -->
        <view class="attachment-doc" wx:elif="{{item.type === 'document'}}" bindtap="openDocument" data-url="{{item.url}}">
          <text class="doc-icon">ğŸ“„</text>
          <text class="doc-name">{{item.name}}</text>
          <text class="doc-size">{{item.sizeText}}</text>
        </view>
        
        <!-- è¯­éŸ³é™„ä»¶ -->
        <view class="attachment-audio" wx:elif="{{item.type === 'audio'}}" bindtap="playAudio" data-url="{{item.url}}">
          <text class="audio-icon">ğŸ¤</text>
          <text class="audio-name">{{item.name}}</text>
          <text class="audio-duration">{{item.duration}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å®¡æ ¸è®°å½•å¡ç‰‡ -->
  <view class="info-card review-history" wx:if="{{record.reviewHistory && record.reviewHistory.length > 0}}">
    <view class="card-header">
      <text class="card-title">å®¡æ ¸è®°å½•</text>
    </view>
    
    <view class="review-timeline">
      <view class="timeline-item" wx:for="{{record.reviewHistory}}" wx:key="index">
        <view class="timeline-dot timeline-{{item.action}}"></view>
        <view class="timeline-content">
          <view class="timeline-header">
            <text class="timeline-action">{{item.actionText}}</text>
            <text class="timeline-time">{{item.timeText}}</text>
          </view>
          <text class="timeline-reviewer">{{item.reviewerName}} ({{item.reviewerRole}})</text>
          <text class="timeline-reason" wx:if="{{item.reason}}">{{item.reason}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç›¸å…³è®°å½•å¡ç‰‡ -->
  <view class="info-card related-records" wx:if="{{relatedRecords && relatedRecords.length > 0}}">
    <view class="card-header">
      <text class="card-title">ç›¸å…³è®°å½•</text>
      <text class="card-subtitle">åŒä¸€æ‚£è€…çš„å…¶ä»–æœåŠ¡è®°å½•</text>
    </view>
    
    <view class="related-list">
      <view class="related-item" wx:for="{{relatedRecords}}" wx:key="id" bindtap="viewRelatedRecord" data-id="{{item.id}}">
        <view class="related-type" style="background-color: {{item.typeColor}};">{{item.typeIcon}}</view>
        <view class="related-info">
          <text class="related-title">{{item.typeName}}</text>
          <text class="related-time">{{item.dateText}}</text>
          <text class="related-volunteer">{{item.volunteerName}}</text>
        </view>
        <view class="related-status status-{{item.status}}">
          <text class="status-text">{{item.statusText}}</text>
        </view>
        <text class="related-arrow">ã€‰</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œç»Ÿè®¡å¡ç‰‡ -->
  <view class="info-card operation-stats" wx:if="{{canViewStats}}">
    <view class="card-header">
      <text class="card-title">æ“ä½œç»Ÿè®¡</text>
    </view>
    
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{record.viewCount || 0}}</text>
        <text class="stat-label">æŸ¥çœ‹æ¬¡æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{record.editCount || 0}}</text>
        <text class="stat-label">ä¿®æ”¹æ¬¡æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{record.downloadCount || 0}}</text>
        <text class="stat-label">ä¸‹è½½æ¬¡æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{record.shareCount || 0}}</text>
        <text class="stat-label">åˆ†äº«æ¬¡æ•°</text>
      </view>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-container" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="skeleton-header"></view>
    <view class="skeleton-card" wx:for="{{[1,2,3]}}">
      <view class="skeleton-title"></view>
      <view class="skeleton-line"></view>
      <view class="skeleton-line short"></view>
    </view>
  </view>
</view>

<!-- é”™è¯¯çŠ¶æ€ -->
<view class="error-container" wx:if="{{error && !loading}}">
  <view class="error-content">
    <text class="error-icon">ğŸ˜”</text>
    <text class="error-title">åŠ è½½å¤±è´¥</text>
    <text class="error-message">{{error.message || 'æ— æ³•è·å–æœåŠ¡è®°å½•è¯¦æƒ…'}}</text>
    <button class="error-retry" bindtap="retryLoad">é‡æ–°åŠ è½½</button>
  </view>
</view>

<!-- åº•éƒ¨æ“ä½œåŒº -->
<view class="bottom-actions" wx:if="{{!loading && !error}}">
  <view class="action-group" wx:if="{{canEdit && record.status === 'draft'}}">
    <button class="action-btn secondary" bindtap="deleteRecord">
      <text class="btn-icon">ğŸ—‘ï¸</text>
      <text class="btn-text">åˆ é™¤</text>
    </button>
    <button class="action-btn primary" bindtap="editRecord">
      <text class="btn-icon">âœï¸</text>
      <text class="btn-text">ç¼–è¾‘</text>
    </button>
  </view>
  
  <view class="action-group" wx:if="{{canReview && record.status === 'pending'}}">
    <button class="action-btn reject" bindtap="rejectRecord" loading="{{reviewing}}">
      <text class="btn-icon">âŒ</text>
      <text class="btn-text">é©³å›</text>
    </button>
    <button class="action-btn approve" bindtap="approveRecord" loading="{{reviewing}}">
      <text class="btn-icon">âœ…</text>
      <text class="btn-text">é€šè¿‡</text>
    </button>
  </view>
  
  <view class="action-group" wx:if="{{!canEdit && !canReview}}">
    <button class="action-btn secondary" bindtap="shareRecord">
      <text class="btn-icon">ğŸ“¤</text>
      <text class="btn-text">åˆ†äº«</text>
    </button>
    <button class="action-btn primary" bindtap="createSimilar">
      <text class="btn-icon">â•</text>
      <text class="btn-text">åˆ›å»ºç±»ä¼¼è®°å½•</text>
    </button>
  </view>
</view>

<!-- æ›´å¤šæ“ä½œèœå• -->
<view class="action-menu {{showActionMenu ? 'show' : ''}}" catchtap="hideActionMenu">
  <view class="menu-content" catchtap="stopPropagation">
    <view class="menu-header">
      <text class="menu-title">æ›´å¤šæ“ä½œ</text>
      <button class="menu-close" bindtap="hideActionMenu">âœ•</button>
    </view>
    <view class="menu-actions">
      <button class="menu-action" bindtap="exportRecord" wx:if="{{canExport}}">
        <text class="action-icon">ğŸ“„</text>
        <text class="action-text">å¯¼å‡ºè®°å½•</text>
      </button>
      <button class="menu-action" bindtap="printRecord" wx:if="{{canPrint}}">
        <text class="action-icon">ğŸ–¨ï¸</text>
        <text class="action-text">æ‰“å°è®°å½•</text>
      </button>
      <button class="menu-action" bindtap="copyLink">
        <text class="action-icon">ğŸ”—</text>
        <text class="action-text">å¤åˆ¶é“¾æ¥</text>
      </button>
      <button class="menu-action" bindtap="reportIssue">
        <text class="action-icon">ğŸš¨</text>
        <text class="action-text">ä¸¾æŠ¥é—®é¢˜</text>
      </button>
    </view>
  </view>
</view>

<!-- é©³å›åŸå› å¼¹çª— -->
<view class="reject-modal {{showRejectModal ? 'show' : ''}}" catchtap="hideRejectModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é©³å›è®°å½•</text>
      <button class="modal-close" bindtap="hideRejectModal">âœ•</button>
    </view>
    <view class="modal-body">
      <view class="form-field">
        <text class="field-label">é©³å›åŸå›  *</text>
        <textarea class="reject-reason" 
                  placeholder="è¯·è¯´æ˜é©³å›çš„å…·ä½“åŸå› ï¼Œå¸®åŠ©å¿—æ„¿è€…æ”¹è¿›è®°å½•è´¨é‡"
                  value="{{rejectReason}}"
                  bindinput="onRejectReasonInput"
                  maxlength="200">
        </textarea>
        <text class="char-count">{{rejectReason.length}}/200</text>
      </view>
    </view>
    <view class="modal-actions">
      <button class="modal-btn secondary" bindtap="hideRejectModal">å–æ¶ˆ</button>
      <button class="modal-btn primary" bindtap="confirmReject" loading="{{rejecting}}">ç¡®è®¤é©³å›</button>
    </view>
  </view>
</view>

<!-- å›¾ç‰‡é¢„è§ˆé®ç½© -->
<view class="image-preview {{showImagePreview ? 'show' : ''}}" catchtap="hideImagePreview">
  <view class="preview-content">
    <swiper class="preview-swiper" current="{{currentImageIndex}}" bindchange="onImageIndexChange">
      <swiper-item wx:for="{{imageAttachments}}" wx:key="index">
        <image class="preview-image" src="{{item.url}}" mode="aspectFit" />
      </swiper-item>
    </swiper>
    <view class="preview-indicators">
      <text class="indicator-text">{{currentImageIndex + 1}}/{{imageAttachments.length}}</text>
    </view>
    <button class="preview-close" bindtap="hideImagePreview">âœ•</button>
  </view>
</view>