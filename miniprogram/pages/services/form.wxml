<view class="service-form-page" wx:if="{{!loading}}">
  <!-- å¯¼èˆªå¤´éƒ¨åŒº -->
  <view class="nav-header {{theme.headerBg}}">
    <view class="nav-left" bindtap="navigateBack">
      <text class="nav-icon">â†</text>
      <view class="nav-title">ğŸ§° {{isQuickMode ? 'å¿«é€Ÿè®°å½•' : 'æœåŠ¡è®°å½•'}}</view>
    </view>
    <view class="nav-actions">
      <view class="nav-tool" bindtap="showMyStats" wx:if="{{!isQuickMode}}">
        <text class="nav-icon">ğŸ“Š</text>
      </view>
      <view class="nav-tool" bindtap="showHelp">
        <text class="nav-icon">â“</text>
      </view>
    </view>
  </view>

  <!-- ä¸Šä¼ è¿›åº¦æ¡ -->
  <view class="upload-progress" wx:if="{{uploading}}">
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{uploadProgress}}%;"></view>
    </view>
    <view class="progress-text">
      <text class="progress-label">ä¸Šä¼ ä¸­</text>
      <text class="progress-value">{{uploadDone}}/{{uploadTotal}} ({{uploadProgress}}%)</text>
    </view>
  </view>

  <!-- æ¨¡å¼åˆ‡æ¢åŒº -->
  <view class="mode-section" wx:if="{{!isQuickMode}}">
    <view class="mode-header">
      <text class="mode-title">è®°å½•æ¨¡å¼</text>
      <view class="save-actions">
        <ui-button 
          text="ä¿å­˜è‰ç¨¿" 
          variant="secondary" 
          size="sm"
          icon="ğŸ’¾"
          bindtap="saveDraft" />
        <ui-button 
          text="æ¸…é™¤" 
          variant="ghost" 
          size="sm"
          icon="ğŸ—‘ï¸"
          bindtap="clearDraft" />
      </view>
    </view>
    <view class="mode-switcher">
      <view class="mode-option {{quickMode ? 'active' : ''}}" bindtap="switchToQuickMode">
        <text class="mode-icon">âš¡</text>
        <view class="mode-content">
          <text class="mode-name">å¿«é€Ÿè®°å½•</text>
          <text class="mode-desc">1-3åˆ†é’Ÿå®Œæˆ</text>
        </view>
      </view>
      <view class="mode-option {{!quickMode ? 'active' : ''}}" bindtap="switchToDetailMode">
        <text class="mode-icon">ğŸ“</text>
        <view class="mode-content">
          <text class="mode-name">è¯¦ç»†è®°å½•</text>
          <text class="mode-desc">å®Œæ•´ä¿¡æ¯å½•å…¥</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿæ¨¡å¼é¡¶éƒ¨æç¤º -->
  <view class="quick-mode-tip" wx:if="{{quickMode || isQuickMode}}">
    <view class="tip-content">
      <text class="tip-icon">âš¡</text>
      <view class="tip-text">
        <text class="tip-title">å¿«é€Ÿè®°å½•æ¨¡å¼</text>
        <text class="tip-desc">åªéœ€å¡«å†™å¿…è¦ä¿¡æ¯ï¼Œ1-3åˆ†é’Ÿå®Œæˆè®°å½•</text>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡ç±»å‹é€‰æ‹©åŒº -->
  <view class="service-type-section">
    <view class="section-header">
      <text class="section-title">é€‰æ‹©æœåŠ¡ç±»å‹</text>
      <text class="section-required">*</text>
    </view>
    <view class="service-types">
      <view class="service-type {{serviceType === item.key ? 'selected' : ''}}" 
            wx:for="{{serviceTypes}}" wx:key="key"
            data-type="{{item.key}}" bindtap="onServiceTypeSelect">
        <view class="type-icon" style="background-color: {{item.color}};">{{item.icon}}</view>
        <text class="type-name">{{item.name}}</text>
        <view class="type-check" wx:if="{{serviceType === item.key}}">âœ“</view>
      </view>
    </view>
    <text class="field-error" wx:if="{{errors.serviceType}}">{{errors.serviceType}}</text>
  </view>

  <!-- æ‚£è€…é€‰æ‹©åŒº -->
  <view class="patient-section">
    <view class="section-header">
      <text class="section-title">æœåŠ¡å¯¹è±¡</text>
      <text class="section-required">*</text>
    </view>
    <view class="patient-selector" bindtap="selectPatient">
      <view class="selector-content" wx:if="{{selectedPatient}}">
        <view class="patient-avatar">{{selectedPatient.initial}}</view>
        <view class="patient-info">
          <text class="patient-name">{{selectedPatient.displayName}}</text>
          <text class="patient-meta">{{selectedPatient.ageText}} Â· {{selectedPatient.condition}}</text>
        </view>
      </view>
      <view class="selector-placeholder" wx:else>
        <text class="placeholder-icon">ğŸ‘¤</text>
        <text class="placeholder-text">ç‚¹å‡»é€‰æ‹©æœåŠ¡å¯¹è±¡</text>
      </view>
      <text class="selector-arrow">ã€‰</text>
    </view>
    <text class="field-error" wx:if="{{errors.patientId}}">{{errors.patientId}}</text>
  </view>

  <!-- æœåŠ¡æ—¶é—´åŒº -->
  <view class="datetime-section">
    <view class="section-header">
      <text class="section-title">æœåŠ¡æ—¶é—´</text>
      <text class="section-required">*</text>
    </view>
    <view class="datetime-picker">
      <picker mode="date" value="{{serviceDate}}" bindchange="onDateChange">
        <view class="picker-item">
          <text class="picker-icon">ğŸ“…</text>
          <text class="picker-value">{{serviceDateText}}</text>
        </view>
      </picker>
      <picker mode="time" value="{{serviceTime}}" bindchange="onTimeChange">
        <view class="picker-item">
          <text class="picker-icon">â°</text>
          <text class="picker-value">{{serviceTimeText}}</text>
        </view>
      </picker>
    </view>
    <text class="field-error" wx:if="{{errors.serviceDateTime}}">{{errors.serviceDateTime}}</text>
  </view>

  <!-- æœåŠ¡å†…å®¹åŒº -->
  <view class="content-section" wx:if="{{!quickMode || showAdvancedContent}}">
    <view class="section-header">
      <text class="section-title">æœåŠ¡å†…å®¹</text>
      <text class="section-required" wx:if="{{!quickMode}}">*</text>
      <ui-button 
        text="è¯­éŸ³è¾“å…¥" 
        variant="secondary" 
        size="sm"
        icon="ğŸ¤"
        bindtap="startVoiceInput" />
    </view>
    <textarea class="content-textarea" 
              placeholder="{{contentPlaceholder}}"
              value="{{serviceContent}}"
              bindinput="onContentInput"
              maxlength="{{quickMode ? 200 : 500}}"
              auto-height="{{true}}"></textarea>
    <view class="textarea-footer">
      <text class="char-count">{{serviceContent.length}}/{{quickMode ? 200 : 500}}</text>
      <view class="content-templates" wx:if="{{contentTemplates.length > 0}}">
        <text class="template-label">å¿«é€Ÿæ¨¡æ¿ï¼š</text>
        <view class="template-chips">
          <text class="template-chip" 
                wx:for="{{contentTemplates}}" wx:key="*this"
                bindtap="useTemplate" data-template="{{item}}">{{item}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿå†…å®¹é€‰æ‹© -->
  <view class="quick-content-section" wx:if="{{quickMode && !showAdvancedContent}}">
    <view class="section-header">
      <text class="section-title">æœåŠ¡å†…å®¹</text>
      <ui-button 
        text="è¯¦ç»†å¡«å†™" 
        variant="ghost" 
        size="sm"
        iconRight="ğŸ“"
        bindtap="toggleAdvancedContent" />
    </view>
    <view class="quick-templates">
      <view class="template-item {{quickTemplate === item ? 'selected' : ''}}"
            wx:for="{{quickTemplates}}" wx:key="*this"
            data-template="{{item}}" bindtap="selectQuickTemplate">
        <text class="template-text">{{item}}</text>
        <view class="template-check" wx:if="{{quickTemplate === item}}">âœ“</view>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡åœ°ç‚¹åŒº (è¯¦ç»†æ¨¡å¼) -->
  <view class="location-section" wx:if="{{!quickMode}}">
    <view class="section-header">
      <text class="section-title">æœåŠ¡åœ°ç‚¹</text>
    </view>
    <input class="location-input" 
           placeholder="è¾“å…¥æœåŠ¡åœ°ç‚¹"
           value="{{serviceLocation}}"
           bindinput="onLocationInput" />
    <view class="location-suggestions" wx:if="{{locationSuggestions.length > 0}}">
      <text class="suggestion-item"
            wx:for="{{locationSuggestions}}" wx:key="*this"
            bindtap="selectLocation" data-location="{{item}}">{{item}}</text>
    </view>
  </view>

  <!-- é™„ä»¶ä¸Šä¼ åŒº (è¯¦ç»†æ¨¡å¼) -->
  <view class="attachment-section" wx:if="{{!quickMode}}">
    <view class="section-header">
      <text class="section-title">é™„ä»¶ä¸Šä¼ </text>
      <text class="section-subtitle">æœ€å¤š{{maxImages}}å¼ å›¾ç‰‡ï¼Œå•å¼ â‰¤{{maxImageSize}}MB</text>
    </view>
    <view class="attachment-grid">
      <view class="attachment-item" wx:for="{{attachments}}" wx:key="index">
        <image class="attachment-image" 
               mode="aspectFill" 
               src="{{item.local || item.fileID}}"
               bindtap="previewAttachment" data-index="{{index}}" />
        <view class="attachment-delete" 
              bindtap="removeAttachment" data-index="{{index}}">Ã—</view>
      </view>
      <view class="attachment-add" bindtap="addAttachment" wx:if="{{attachments.length < maxImages}}">
        <text class="add-icon">ğŸ“·</text>
        <text class="add-text">æ·»åŠ å›¾ç‰‡</text>
      </view>
    </view>
    <text class="field-error" wx:if="{{errors.attachments}}">{{errors.attachments}}</text>
  </view>

  <!-- è‡ªåŠ¨ä¿å­˜æç¤º -->
  <view class="auto-save-tip" wx:if="{{autoSaveStatus}}">
    <text class="save-icon">ğŸ’¾</text>
    <text class="save-text">{{autoSaveStatus}}</text>
  </view>
</view>

<!-- åº•éƒ¨æ“ä½œåŒº -->
<view class="bottom-actions" wx:if="{{!loading}}">
  <ui-button 
    text="ä¿å­˜è‰ç¨¿" 
    variant="secondary" 
    size="md"
    icon="ğŸ’¾"
    bindtap="saveDraft" 
    wx:if="{{!quickMode}}" />
  <ui-button 
    text="{{quickMode || isQuickMode ? 'å¿«é€Ÿæäº¤' : 'æäº¤å®¡æ ¸'}}" 
    variant="primary" 
    size="md"
    icon="âœ…"
    loading="{{submitting}}"
    bindtap="onSubmit" />
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-container" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-header">
      <view class="skeleton-nav"></view>
    </view>
    <view class="loading-form">
      <view class="skeleton-section" wx:for="{{[1,2,3,4]}}" wx:key="*this">
        <view class="skeleton-title"></view>
        <view class="skeleton-input"></view>
      </view>
    </view>
  </view>
</view>

<!-- æ‚£è€…é€‰æ‹©å¼¹çª— -->
<view class="patient-modal {{showPatientModal ? 'show' : ''}}" catchtap="hidePatientModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©æœåŠ¡å¯¹è±¡</text>
      <ui-button 
        text="âœ•" 
        variant="ghost" 
        size="sm"
        round="{{true}}"
        bindtap="hidePatientModal" />
    </view>
    <view class="modal-body">
      <view class="patient-search">
        <input class="search-input" 
               placeholder="æœç´¢æ‚£è€…å§“åæˆ–ID"
               value="{{patientSearchText}}"
               bindinput="onPatientSearch" />
      </view>
      <view class="patient-list">
        <view class="patient-option {{item.id === (selectedPatient && selectedPatient.id) ? 'selected' : ''}}"
              wx:for="{{filteredPatients}}" wx:key="id"
              data-patient="{{item}}" bindtap="selectPatientOption">
          <view class="patient-avatar">{{item.initial}}</view>
          <view class="patient-info">
            <text class="patient-name">{{item.displayName}}</text>
            <text class="patient-meta">{{item.ageText}} Â· {{item.condition}}</text>
          </view>
          <view class="patient-check" wx:if="{{item.id === (selectedPatient && selectedPatient.id)}}">âœ“</view>
        </view>
      </view>
    </view>
  </view>
</view>
