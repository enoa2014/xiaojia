
<view class="page">
  <!-- 导航头部区 -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
  <view class="brand">🏠 小家服务中心</view>
  <view class="nav-actions">
    <view class="nav-tool nav-notif" wx:if="{{notifications>0}}" bindtap="wip">
      <text class="nav-icon">🔔</text>
      <view class="nav-badge">{{notifications}}</view>
    </view>
    <text class="nav-tool nav-icon" bindtap="wip">💬</text>
    <text class="nav-tool nav-icon {{isRefreshing?'spin':''}}" bindtap="refreshTap">🔄</text>
    <text class="nav-tool nav-icon" bindtap="openRoleSwitcher">⚙️</text>
  </view>
  </view>

<!-- 用户状态区 -->
<view class="user-status {{theme.userBg}}">
  <view class="user-profile">
    <view class="user-avatar">{{user.avatar || '👩‍💼'}}</view>
    <view class="user-info">
      <view class="name-role-row">
        <text class="user-name">{{user.name}}</text>
        <role-badge roleKey="{{user.roleKey || ''}}" size="sm"></role-badge>
      </view>
      <view class="permissions-row">
        <text class="perm-text" wx:if="{{user.roleKey}}">{{user.permText}}</text>
        <text class="perm-text" wx:elif="{{user.status==='pending'}}">注册已提交，等待审批</text>
        <view class="status-indicator active" wx:if="{{user.roleKey}}">
          <icon type="success" color="#22C55E" size="14" />
          <text>在线</text>
        </view>
      </view>
      
      <!-- 游客模式退出选项 -->
      <view wx:if="{{user.status === 'guest'}}" class="guest-mode-exit">
        <button class="exit-guest-btn" bindtap="exitGuestMode">🚪 退出游客模式</button>
      </view>
      
      <!-- 登录用户登出选项 -->
      <view wx:if="{{user.roleKey}}" class="logout-section">
        <button class="logout-btn" bindtap="onLogout">🚪 登出</button>
      </view>
    </view>
  </view>
  
  <view class="stats-summary">
    <view class="stats-item">
      <text class="stats-number">{{user.todayDone}}</text>
      <text class="stats-label">今日完成</text>
    </view>
    <view class="stats-divider"></view>
    <view class="stats-item">
      <text class="stats-number">{{user.todayTotal}}</text>
      <text class="stats-label">计划任务</text>
    </view>
    <view class="time-display">
      <text class="current-time">{{user.now}}</text>
    </view>
  </view>

<!-- 快速操作区 -->
<view class="quick-actions-section" wx:if="{{!loading}}">
  <view class="section-header">
    <text class="section-title">📌 快速操作</text>
    <role-badge roleKey="{{user.roleKey || ''}}" size="sm"></role-badge>
  </view>
  
  <view class="actions-grid">
    <block wx:for="{{actions}}" wx:key="key" wx:for-index="index">
      <action-card
        title="{{item.title}}"
        desc="{{item.subtitle}}"
        icon="{{item.icon}}"
        disabled="{{item.disabled || false}}"
        loading="{{item.loading || false}}"
        custom-data="{{item}}"
        bindtap="onAction"
        data-key="{{item.key}}"
        wx:if="{{index < 4}}"
        class="{{selectedActionKey===item.key?'selected':''}}">
      </action-card>
    </block>
  </view>
  
  <view class="more-actions" wx:if="{{actions.length > 4}}" bindtap="showAllActions">
    <text class="more-text">查看更多操作</text>
    <text class="more-icon">⬇</text>
  </view>
 </view>
</view>

<!-- 数据总览区 -->
<view class="data-overview-section" wx:if="{{!loading}}">
  <view class="section-header">
    <text class="section-title">📊 本月概况</text>
    <view class="overview-controls">
      <text class="period-text">本月</text>
      <text class="refresh-hint" bindtap="refreshTap">刷新</text>
    </view>
  </view>
  
  <scroll-view class="stats-scroll" 
               scroll-x="true" 
               enable-flex="true"
               show-scrollbar="false">
    <view class="stats-container">
      <block wx:for="{{stats}}" wx:key="key" wx:for-index="index">
        <stat-card 
          value="{{item.value}}"
          label="{{item.label}}{{item.change ? ' (' + item.change + ' 较上期)' : ''}}"
          icon="{{item.icon}}"
          variant="{{index % 4 === 0 ? 'primary' : (index % 4 === 1 ? 'success' : (index % 4 === 2 ? 'warning' : 'info'))}}"
          loading="{{loading}}"
          empty="{{!item.value || item.value === '0'}}"
          class="index-stat-card">
        </stat-card>
      </block>
      
      <!-- 占位卡片确保最后一个卡片有右边距 -->
      <view class="spacer-card"></view>
    </view>
  </scroll-view>
  
  <view class="scroll-indicator">
    <view class="indicator-dots">
      <block wx:for="{{stats}}" wx:key="key" wx:for-index="index">
        <view class="dot {{index < 3 ? 'active' : ''}}" wx:if="{{index < Math.min(stats.length, 6)}}"></view>
      </block>
    </view>
  </view>
</view>

<!-- 任务提醒区 -->
<view class="tasks-section" wx:if="{{!loading}}">
  <view class="section-header">
    <text class="section-title">📋 待办事项</text>
    <view class="task-counter">
      <text class="counter-text">{{tasks.length}}</text>
      <view class="view-all-btn" bindtap="wip">
        <text>查看全部</text>
        <text class="arrow">›</text>
      </view>
    </view>
  </view>
  
  <view class="tasks-list">
    <block wx:for="{{tasks}}" wx:key="id" wx:for-index="index">
      <view class="task-card priority-{{item.color === '#EF4444' ? 'high' : (item.color === '#F59E0B' ? 'medium' : 'normal')}}"
            wx:if="{{index < 3}}">
        <view class="task-main">
          <view class="priority-dot" style="background-color: {{item.color}};"></view>
          <view class="task-content">
            <text class="task-title">{{item.title}}</text>
            <text class="task-desc">{{item.desc}}</text>
          </view>
        </view>
        <view class="task-action">
          <text class="action-icon">›</text>
        </view>
      </view>
    </block>
    
    <empty-state
      wx:if="{{tasks.length === 0}}"
      show="{{true}}"
      icon="✅"
      title="暂无待办事项"
      description=""
      variant="compact">
    </empty-state>
  </view>
</view>

<!-- 最近动态区 -->
<view class="updates-section" wx:if="{{!loading}}">
  <view class="section-header">
    <text class="section-title">🕐 最近动态</text>
    <view class="view-all-btn" bindtap="wip">
      <text>查看全部</text>
      <text class="arrow">›</text>
    </view>
  </view>
  
  <view class="updates-timeline">
    <block wx:for="{{updates}}" wx:key="id" wx:for-index="index">
      <view class="update-entry" wx:if="{{index < 4}}">
        <view class="timeline-dot">
          <view class="dot-inner"></view>
        </view>
        <view class="update-content">
          <text class="update-text">{{item.text}}</text>
          <text class="update-time">{{item.time}}</text>
        </view>
      </view>
    </block>
    
    <empty-state
      wx:if="{{updates.length === 0}}"
      show="{{true}}"
      icon="📰"
      title="暂无动态"
      description=""
      variant="compact">
    </empty-state>
  </view>
</view>

<!-- 底部导航提示卡片（已移除按要求） -->
<!-- 骨架屏 -->
<view wx:if="{{loading}}" class="skeleton">
  <view class="sk-qa">
    <view class="sk-card"></view>
    <view class="sk-card"></view>
    <view class="sk-card"></view>
    <view class="sk-card"></view>
  </view>
  <view class="sk-stats">
    <view class="sk-stat"></view>
    <view class="sk-stat"></view>
    <view class="sk-stat"></view>
  </view>
  <view class="sk-tasks">
    <view class="sk-task"></view>
    <view class="sk-task"></view>
    <view class="sk-task"></view>
  </view>
  </view>
</view>
