<view class="page">
  <!-- å¯¼èˆªå¤´éƒ¨ -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">ğŸ” æƒé™å®¡æ‰¹</view>
    <view class="nav-actions">
      <picker wx:if="{{canView}}" mode="selector" range="{{['å…¨éƒ¨çŠ¶æ€', 'å¾…å®¡æ‰¹', 'å·²æ‰¹å‡†', 'å·²æ‹’ç»']}}" range-key="label" value="0" bindchange="onStatusFilterChange">
        <text class="nav-filter">ç­›é€‰</text>
      </picker>
    </view>
  </view>

  <!-- æƒé™æ£€æŸ¥ -->
  <view wx:if="{{!canView}}" class="no-permission">
    <empty-state
      show="{{true}}"
      icon="ğŸ”’"
      title="æƒé™ä¸è¶³"
      description="æƒé™å®¡æ‰¹åŠŸèƒ½ä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è·å–è®¿é—®æƒé™"
      variant="compact"
      action-text="ç”³è¯·æƒé™"
      bindaction="onRequestPermission">
    </empty-state>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <view class="tab-bar">
      <view class="tab-item {{currentTab === 'pending' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="pending">
        <text class="tab-text">å¾…å®¡æ‰¹</text>
        <view wx:if="{{pendingRequests.length > 0}}" class="tab-badge">{{pendingRequests.length}}</view>
      </view>
      <view class="tab-item {{currentTab === 'processed' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="processed">
        <text class="tab-text">å·²å¤„ç†</text>
      </view>
      <view class="tab-item {{currentTab === 'all' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="all">
        <text class="tab-text">å…¨éƒ¨</text>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <loading-skeleton wx:if="{{loading && (pendingRequests.length === 0 && processedRequests.length === 0)}}" 
                     type="list" count="5"></loading-skeleton>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <error-view wx:elif="{{error}}"
                show="{{true}}"
                error="{{error}}"
                retry-text="é‡è¯•"
                variant="compact"
                bindretry="onRetryLoad">
    </error-view>

    <!-- å¾…å®¡æ‰¹åˆ—è¡¨ -->
    <view wx:elif="{{currentTab === 'pending' || currentTab === 'all'}}" class="requests-section">
      <view wx:if="{{pendingRequests.length > 0}}" class="section-title">
        <text class="title-text">ğŸŸ¡ å¾…å®¡æ‰¹è¯·æ±‚</text>
        <text class="count-badge">{{pendingRequests.length}}</text>
      </view>
      
      <view class="requests-list">
        <block wx:for="{{pendingRequests}}" wx:key="id">
          <view class="request-item pending">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.requesterName.charAt(0)}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.requesterName}}</text>
                  <text class="user-role">{{item.requesterRole}}</text>
                </view>
              </view>
              <view class="request-time">{{formatTime(item.createdAt)}}</view>
            </view>
            
            <view class="request-content">
              <view class="field-info">
                <text class="field-name">ç”³è¯·è®¿é—®ï¼š{{item.fieldDisplayName}}</text>
                <text class="field-target">æ‚£è€…ï¼š{{item.patientName}}</text>
              </view>
              <view wx:if="{{item.reason}}" class="request-reason">
                <text class="reason-label">ç”³è¯·åŸå› ï¼š</text>
                <text class="reason-text">{{item.reason}}</text>
              </view>
            </view>
            
            <view class="request-actions">
              <ui-button ext-class="action-btn approve" variant="primary" size="sm" text="æ‰¹å‡†" bindtap="onApprovalAction" data-request-id="{{item.id}}" data-action="approve"></ui-button>
              <ui-button ext-class="action-btn reject" variant="danger" size="sm" text="æ‹’ç»" bindtap="onApprovalAction" data-request-id="{{item.id}}" data-action="reject"></ui-button>
              <ui-button ext-class="action-btn detail" variant="secondary" size="sm" text="è¯¦æƒ…" bindtap="onViewDetail" data-request-id="{{item.id}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      
      <empty-state wx:if="{{pendingRequests.length === 0 && !loading}}"
                   show="{{true}}"
                   icon="âœ…"
                   title="æ— å¾…å®¡æ‰¹è¯·æ±‚"
                   description="å½“å‰æ²¡æœ‰éœ€è¦å¤„ç†çš„æƒé™ç”³è¯·"
                   variant="compact">
      </empty-state>
    </view>

    <!-- å·²å¤„ç†åˆ—è¡¨ -->
    <view wx:if="{{currentTab === 'processed' || currentTab === 'all'}}" class="requests-section">
      <view wx:if="{{processedRequests.length > 0 && (currentTab === 'all' && pendingRequests.length > 0)}}" class="section-title">
        <text class="title-text">ğŸ“‹ å·²å¤„ç†è¯·æ±‚</text>
      </view>
      
      <view class="requests-list">
        <block wx:for="{{processedRequests}}" wx:key="id">
          <view class="request-item {{item.status}}">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.requesterName.charAt(0)}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.requesterName}}</text>
                  <text class="user-role">{{item.requesterRole}}</text>
                </view>
              </view>
              <view class="status-info">
                <view class="status-badge {{item.status}}">
                  <text class="status-text">{{item.status === 'approved' ? 'å·²æ‰¹å‡†' : 'å·²æ‹’ç»'}}</text>
                </view>
                <text class="processed-time">{{formatTime(item.processedAt)}}</text>
              </view>
            </view>
            
            <view class="request-content">
              <view class="field-info">
                <text class="field-name">{{item.fieldDisplayName}}</text>
                <text class="field-target">{{item.patientName}}</text>
              </view>
              <view wx:if="{{item.processorName}}" class="processor-info">
                <text class="processor-text">å¤„ç†äººï¼š{{item.processorName}}</text>
              </view>
            </view>
            
            <view class="request-actions">
              <ui-button ext-class="action-btn detail" variant="secondary" size="sm" text="è¯¦æƒ…" bindtap="onViewDetail" data-request-id="{{item.id}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      
      <empty-state wx:if="{{processedRequests.length === 0 && currentTab === 'processed' && !loading}}"
                   show="{{true}}"
                   icon="ğŸ“‹"
                   title="æ— å¤„ç†è®°å½•"
                   description="è¿˜æ²¡æœ‰å¤„ç†è¿‡ä»»ä½•æƒé™ç”³è¯·"
                   variant="compact">
      </empty-state>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{hasMore && !loading}}" class="load-more">
      <text class="load-more-text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>
    
    <view wx:elif="{{!hasMore && (pendingRequests.length > 0 || processedRequests.length > 0)}}" class="no-more">
      <text class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</text>
    </view>
  </view>
</view>
