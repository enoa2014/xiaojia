<view class="page">
  <!-- 导航头部 -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">🔐 审批中心</view>
    <view class="category-bar">
      <view class="cat-item {{currentCategory==='permissions'?'active':''}}" bindtap="onCategoryChange" data-cat="permissions">权限申请</view>
      <view class="cat-item {{currentCategory==='users'?'active':''}}" bindtap="onCategoryChange" data-cat="users">用户注册</view>
    </view>
    <view class="nav-actions">
      <picker wx:if="{{canView}}" mode="selector" range="{{['全部状态', '待审批', '已批准', '已拒绝']}}" range-key="label" value="0" bindchange="onStatusFilterChange">
        <text class="nav-filter">筛选</text>
      </picker>
    </view>
  </view>

  <!-- 工具栏（仅管理员可见时展示） -->
  <view class="toolbar" wx:if="{{canView}}">
    <ui-button variant="secondary" text="发起测试注册" bindtap="goTestRegister" />
  </view>

  <!-- 权限检查 -->
  <view wx:if="{{!canView}}" class="no-permission">
    <empty-state
      show="{{true}}"
      icon="🔒"
      title="权限不足"
      description="权限审批功能仅管理员可用，请联系管理员获取访问权限"
      variant="compact"
      action-text="申请权限"
      bindaction="onRequestPermission">
    </empty-state>
  </view>
  <view wx:else>
    <!-- 用户注册审批 -->
    <view wx:if="{{currentCategory==='users'}}" class="requests-section">
      <view class="tab-bar">
        <view class="tab-item {{userRegTab==='pending'?'active':''}}" bindtap="onUserRegTabChange" data-tab="pending">
          <text class="tab-text">待审批</text>
        </view>
        <view class="tab-item {{userRegTab==='processed'?'active':''}}" bindtap="onUserRegTabChange" data-tab="processed">
          <text class="tab-text">已处理</text>
        </view>
      </view>
      <view class="section-title">
        <text class="title-text">🟡 待审批注册</text>
      </view>
      <view class="requests-list" wx:if="{{userRegTab==='pending'}}">
        <block wx:for="{{userRegsPending}}" wx:key="openId">
          <view class="request-item pending">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.initial}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.name || '未填姓名'}}</text>
                  <text class="user-role">申请：{{item.applyRole==='parent'?'亲属':'志愿者'}}</text>
                </view>
              </view>
              <view class="request-time">{{formatTime(item.createdAt)}}</view>
            </view>
            <view class="request-content">
              <view class="field-info">
                <text class="field-name">电话：{{item.phoneMasked || '—'}}</text>
                <text wx:if="{{item.relative}}" class="field-target">亲属：{{item.relative.patientName}}（{{item.relative.relation}}）</text>
              </view>
            </view>
            <view class="request-actions">
              <ui-button ext-class="action-btn approve" variant="primary" size="sm" text="通过" bindtap="onUserApprove" data-open-id="{{item.openId}}"></ui-button>
              <ui-button ext-class="action-btn reject" variant="danger" size="sm" text="拒绝" bindtap="onUserReject" data-open-id="{{item.openId}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      <view class="requests-list" wx:elif="{{userRegTab==='processed'}}">
        <block wx:for="{{userRegsProcessed}}" wx:key="openId">
          <view class="request-item {{item.status}}">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.initial}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.name || '未填姓名'}}</text>
                  <text class="user-role">处理结果：{{item.status==='active'?'已通过':'已拒绝'}}</text>
                </view>
              </view>
              <view class="request-time">{{formatTime(item.updatedAt || item.createdAt)}}</view>
            </view>
          </view>
        </block>
        <empty-state wx:if="{{(!userRegsProcessed || userRegsProcessed.length===0) && !loading}}" show="{{true}}" icon="📋" title="暂无处理记录" variant="compact" />
      </view>
      <empty-state wx:if="{{(!userRegsPending || userRegsPending.length===0) && !loading}}" show="{{true}}" icon="✅" title="无待审批注册" description="暂无待处理注册申请" variant="compact" />
    </view>
    <view wx:elif="{{currentCategory==='permissions'}}">
    <!-- 标签页切换 -->
    <view class="tab-bar">
      <view class="tab-item {{currentTab === 'pending' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="pending">
        <text class="tab-text">待审批</text>
        <view wx:if="{{pendingRequests.length > 0}}" class="tab-badge">{{pendingRequests.length}}</view>
      </view>
      <view class="tab-item {{currentTab === 'processed' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="processed">
        <text class="tab-text">已处理</text>
      </view>
      <view class="tab-item {{currentTab === 'all' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="all">
        <text class="tab-text">全部</text>
      </view>
    </view>
    <loading-skeleton wx:if="{{loading && (pendingRequests.length === 0 && processedRequests.length === 0)}}" 
                     type="list" count="5"></loading-skeleton>
    <error-view wx:elif="{{error}}"
                show="{{true}}"
                error="{{error}}"
                retry-text="重试"
                variant="compact"
                bindretry="onRetryLoad">
    </error-view>
    <view wx:elif="{{currentTab === 'pending' || currentTab === 'all'}}" class="requests-section">
      <view wx:if="{{pendingRequests.length > 0}}" class="section-title">
        <text class="title-text">🟡 待审批请求</text>
        <text class="count-badge">{{pendingRequests.length}}</text>
      </view>
      
      <view class="requests-list">
        <block wx:for="{{pendingRequests}}" wx:key="id">
          <view class="request-item pending">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.requesterInitial}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.requesterName}}</text>
                  <text class="user-role">{{item.requesterRole}}</text>
                </view>
              </view>
              <view class="request-time">{{formatTime(item.createdAt)}}</view>
            </view>
            
            <view class="request-content">
              <view class="field-info">
                <text class="field-name">申请访问：{{item.fieldDisplayName}}</text>
                <text class="field-target">患者：{{item.patientName}}</text>
              </view>
              <view wx:if="{{item.reason}}" class="request-reason">
                <text class="reason-label">申请原因：</text>
                <text class="reason-text">{{item.reason}}</text>
              </view>
            </view>
            
            <view class="request-actions">
              <ui-button ext-class="action-btn approve" variant="primary" size="sm" text="批准" bindtap="onApprovalAction" data-request-id="{{item.id}}" data-action="approve"></ui-button>
              <ui-button ext-class="action-btn reject" variant="danger" size="sm" text="拒绝" bindtap="onApprovalAction" data-request-id="{{item.id}}" data-action="reject"></ui-button>
              <ui-button ext-class="action-btn detail" variant="secondary" size="sm" text="详情" bindtap="onViewDetail" data-request-id="{{item.id}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      
      <empty-state wx:if="{{pendingRequests.length === 0 && !loading}}"
                   show="{{true}}"
                   icon="✅"
                   title="无待审批请求"
                   description="当前没有需要处理的权限申请"
                   variant="compact">
      </empty-state>
    </view>

    <!-- 已处理列表 -->
    <view wx:if="{{currentTab === 'processed' || currentTab === 'all'}}" class="requests-section">
      <view wx:if="{{processedRequests.length > 0 && (currentTab === 'all' && pendingRequests.length > 0)}}" class="section-title">
        <text class="title-text">📋 已处理请求</text>
      </view>
      
      <view class="requests-list">
        <block wx:for="{{processedRequests}}" wx:key="id">
          <view class="request-item {{item.status}}">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.requesterInitial}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.requesterName}}</text>
                  <text class="user-role">{{item.requesterRole}}</text>
                </view>
              </view>
              <view class="status-info">
                <view class="status-badge {{item.status}}">
                  <text class="status-text">{{item.status === 'approved' ? '已批准' : '已拒绝'}}</text>
                </view>
                <text class="processed-time">{{formatTime(item.processedAt)}}</text>
              </view>
            </view>
            
            <view class="request-content">
              <view class="field-info">
                <text class="field-name">{{item.fieldDisplayName}}</text>
                <text class="field-target">{{item.patientName}}</text>
              </view>
              <view wx:if="{{item.processorName}}" class="processor-info">
                <text class="processor-text">处理人：{{item.processorName}}</text>
              </view>
            </view>
            
            <view class="request-actions">
              <ui-button ext-class="action-btn detail" variant="secondary" size="sm" text="详情" bindtap="onViewDetail" data-request-id="{{item.id}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      
      <empty-state wx:if="{{processedRequests.length === 0 && currentTab === 'processed' && !loading}}"
                   show="{{true}}"
                   icon="📋"
                   title="无处理记录"
                   description="还没有处理过任何权限申请"
                   variant="compact">
      </empty-state>
    </view>

    <!-- 加载更多 -->
    <view wx:if="{{hasMore && !loading}}" class="load-more">
      <text class="load-more-text">上拉加载更多</text>
    </view>
    <view wx:elif="{{!hasMore && (pendingRequests.length > 0 || processedRequests.length > 0)}}" class="no-more">
      <text class="no-more-text">已显示全部内容</text>
    </view>
  </view>
</view>
</view>
