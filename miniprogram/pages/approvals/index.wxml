<view class="page">
  <!-- å¯¼èˆªå¤´éƒ¨ -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">ğŸ” å®¡æ‰¹ä¸­å¿ƒ</view>
    <view class="category-bar">
      <view class="cat-item {{currentCategory==='permissions'?'active':''}}" bindtap="onCategoryChange" data-cat="permissions">æƒé™ç”³è¯·</view>
      <view class="cat-item {{currentCategory==='users'?'active':''}}" bindtap="onCategoryChange" data-cat="users">ç”¨æˆ·æ³¨å†Œ</view>
    </view>
    <view class="nav-actions">
      <picker wx:if="{{canView}}" mode="selector" range="{{['å…¨éƒ¨çŠ¶æ€', 'å¾…å®¡æ‰¹', 'å·²æ‰¹å‡†', 'å·²æ‹’ç»']}}" range-key="label" value="0" bindchange="onStatusFilterChange">
        <text class="nav-filter">ç­›é€‰</text>
      </picker>
    </view>
  </view>

  <!-- å·¥å…·æ ï¼ˆä»…ç®¡ç†å‘˜å¯è§æ—¶å±•ç¤ºï¼‰ -->
  <view class="toolbar" wx:if="{{canView}}">
    <ui-button variant="secondary" text="å‘èµ·æµ‹è¯•æ³¨å†Œ" bindtap="goTestRegister" />
  </view>

  <!-- æƒé™æ£€æŸ¥ -->
  <view wx:if="{{!canView}}" class="no-permission">
    <empty-state
      show="{{true}}"
      icon="ğŸ”’"
      title="æƒé™ä¸è¶³"
      description="æƒé™å®¡æ‰¹åŠŸèƒ½ä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è·å–è®¿é—®æƒé™"
      variant="compact"
      action-text="ç”³è¯·æƒé™"
      bindaction="onRequestPermission">
    </empty-state>
  </view>
  <view wx:else>
    <!-- ç”¨æˆ·æ³¨å†Œå®¡æ‰¹ -->
    <view wx:if="{{currentCategory==='users'}}" class="requests-section">
      <view class="tab-bar">
        <view class="tab-item {{userRegTab==='pending'?'active':''}}" bindtap="onUserRegTabChange" data-tab="pending">
          <text class="tab-text">å¾…å®¡æ‰¹</text>
        </view>
        <view class="tab-item {{userRegTab==='processed'?'active':''}}" bindtap="onUserRegTabChange" data-tab="processed">
          <text class="tab-text">å·²å¤„ç†</text>
        </view>
      </view>
      <view class="section-title">
        <text class="title-text">ğŸŸ¡ å¾…å®¡æ‰¹æ³¨å†Œ</text>
      </view>
      <view class="requests-list" wx:if="{{userRegTab==='pending'}}">
        <block wx:for="{{userRegsPending}}" wx:key="openId">
          <view class="request-item pending">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.initial}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.name || 'æœªå¡«å§“å'}}</text>
                  <text class="user-role">ç”³è¯·ï¼š{{item.applyRole==='parent'?'äº²å±':'å¿—æ„¿è€…'}}</text>
                </view>
              </view>
              <view class="request-time">{{formatTime(item.createdAt)}}</view>
            </view>
            <view class="request-content">
              <view class="field-info">
                <text class="field-name">ç”µè¯ï¼š{{item.phoneMasked || 'â€”'}}</text>
                <text wx:if="{{item.relative}}" class="field-target">äº²å±ï¼š{{item.relative.patientName}}ï¼ˆ{{item.relative.relation}}ï¼‰</text>
              </view>
            </view>
            <view class="request-actions">
              <ui-button ext-class="action-btn approve" variant="primary" size="sm" text="é€šè¿‡" bindtap="onUserApprove" data-open-id="{{item.openId}}"></ui-button>
              <ui-button ext-class="action-btn reject" variant="danger" size="sm" text="æ‹’ç»" bindtap="onUserReject" data-open-id="{{item.openId}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      <view class="requests-list" wx:elif="{{userRegTab==='processed'}}">
        <block wx:for="{{userRegsProcessed}}" wx:key="openId">
          <view class="request-item {{item.status}}">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.initial}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.name || 'æœªå¡«å§“å'}}</text>
                  <text class="user-role">å¤„ç†ç»“æœï¼š{{item.status==='active'?'å·²é€šè¿‡':'å·²æ‹’ç»'}}</text>
                </view>
              </view>
              <view class="request-time">{{formatTime(item.updatedAt || item.createdAt)}}</view>
            </view>
          </view>
        </block>
        <empty-state wx:if="{{(!userRegsProcessed || userRegsProcessed.length===0) && !loading}}" show="{{true}}" icon="ğŸ“‹" title="æš‚æ— å¤„ç†è®°å½•" variant="compact" />
      </view>
      <empty-state wx:if="{{(!userRegsPending || userRegsPending.length===0) && !loading}}" show="{{true}}" icon="âœ…" title="æ— å¾…å®¡æ‰¹æ³¨å†Œ" description="æš‚æ— å¾…å¤„ç†æ³¨å†Œç”³è¯·" variant="compact" />
    </view>
    <view wx:elif="{{currentCategory==='permissions'}}">
    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <view class="tab-bar">
      <view class="tab-item {{currentTab === 'pending' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="pending">
        <text class="tab-text">å¾…å®¡æ‰¹</text>
        <view wx:if="{{pendingRequests.length > 0}}" class="tab-badge">{{pendingRequests.length}}</view>
      </view>
      <view class="tab-item {{currentTab === 'processed' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="processed">
        <text class="tab-text">å·²å¤„ç†</text>
      </view>
      <view class="tab-item {{currentTab === 'all' ? 'active' : ''}}" 
            bindtap="onTabChange" data-tab="all">
        <text class="tab-text">å…¨éƒ¨</text>
      </view>
    </view>
    <loading-skeleton wx:if="{{loading && (pendingRequests.length === 0 && processedRequests.length === 0)}}" 
                     type="list" count="5"></loading-skeleton>
    <error-view wx:elif="{{error}}"
                show="{{true}}"
                error="{{error}}"
                retry-text="é‡è¯•"
                variant="compact"
                bindretry="onRetryLoad">
    </error-view>
    <view wx:elif="{{currentTab === 'pending' || currentTab === 'all'}}" class="requests-section">
      <view wx:if="{{pendingRequests.length > 0}}" class="section-title">
        <text class="title-text">ğŸŸ¡ å¾…å®¡æ‰¹è¯·æ±‚</text>
        <text class="count-badge">{{pendingRequests.length}}</text>
      </view>
      
      <view class="requests-list">
        <block wx:for="{{pendingRequests}}" wx:key="id">
          <view class="request-item pending">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.requesterInitial}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.requesterName}}</text>
                  <text class="user-role">{{item.requesterRole}}</text>
                </view>
              </view>
              <view class="request-time">{{formatTime(item.createdAt)}}</view>
            </view>
            
            <view class="request-content">
              <view class="field-info">
                <text class="field-name">ç”³è¯·è®¿é—®ï¼š{{item.fieldDisplayName}}</text>
                <text class="field-target">æ‚£è€…ï¼š{{item.patientName}}</text>
              </view>
              <view wx:if="{{item.reason}}" class="request-reason">
                <text class="reason-label">ç”³è¯·åŸå› ï¼š</text>
                <text class="reason-text">{{item.reason}}</text>
              </view>
            </view>
            
            <view class="request-actions">
              <ui-button ext-class="action-btn approve" variant="primary" size="sm" text="æ‰¹å‡†" bindtap="onApprovalAction" data-request-id="{{item.id}}" data-action="approve"></ui-button>
              <ui-button ext-class="action-btn reject" variant="danger" size="sm" text="æ‹’ç»" bindtap="onApprovalAction" data-request-id="{{item.id}}" data-action="reject"></ui-button>
              <ui-button ext-class="action-btn detail" variant="secondary" size="sm" text="è¯¦æƒ…" bindtap="onViewDetail" data-request-id="{{item.id}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      
      <empty-state wx:if="{{pendingRequests.length === 0 && !loading}}"
                   show="{{true}}"
                   icon="âœ…"
                   title="æ— å¾…å®¡æ‰¹è¯·æ±‚"
                   description="å½“å‰æ²¡æœ‰éœ€è¦å¤„ç†çš„æƒé™ç”³è¯·"
                   variant="compact">
      </empty-state>
    </view>

    <!-- å·²å¤„ç†åˆ—è¡¨ -->
    <view wx:if="{{currentTab === 'processed' || currentTab === 'all'}}" class="requests-section">
      <view wx:if="{{processedRequests.length > 0 && (currentTab === 'all' && pendingRequests.length > 0)}}" class="section-title">
        <text class="title-text">ğŸ“‹ å·²å¤„ç†è¯·æ±‚</text>
      </view>
      
      <view class="requests-list">
        <block wx:for="{{processedRequests}}" wx:key="id">
          <view class="request-item {{item.status}}">
            <view class="request-header">
              <view class="user-info">
                <view class="user-avatar">{{item.requesterInitial}}</view>
                <view class="user-details">
                  <text class="user-name">{{item.requesterName}}</text>
                  <text class="user-role">{{item.requesterRole}}</text>
                </view>
              </view>
              <view class="status-info">
                <view class="status-badge {{item.status}}">
                  <text class="status-text">{{item.status === 'approved' ? 'å·²æ‰¹å‡†' : 'å·²æ‹’ç»'}}</text>
                </view>
                <text class="processed-time">{{formatTime(item.processedAt)}}</text>
              </view>
            </view>
            
            <view class="request-content">
              <view class="field-info">
                <text class="field-name">{{item.fieldDisplayName}}</text>
                <text class="field-target">{{item.patientName}}</text>
              </view>
              <view wx:if="{{item.processorName}}" class="processor-info">
                <text class="processor-text">å¤„ç†äººï¼š{{item.processorName}}</text>
              </view>
            </view>
            
            <view class="request-actions">
              <ui-button ext-class="action-btn detail" variant="secondary" size="sm" text="è¯¦æƒ…" bindtap="onViewDetail" data-request-id="{{item.id}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      
      <empty-state wx:if="{{processedRequests.length === 0 && currentTab === 'processed' && !loading}}"
                   show="{{true}}"
                   icon="ğŸ“‹"
                   title="æ— å¤„ç†è®°å½•"
                   description="è¿˜æ²¡æœ‰å¤„ç†è¿‡ä»»ä½•æƒé™ç”³è¯·"
                   variant="compact">
      </empty-state>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{hasMore && !loading}}" class="load-more">
      <text class="load-more-text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>
    <view wx:elif="{{!hasMore && (pendingRequests.length > 0 || processedRequests.length > 0)}}" class="no-more">
      <text class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</text>
    </view>
  </view>
</view>
</view>
