<view class="page auth-page">
  <view class="nav-header nav-header--green full-bleed">
    <view class="brand">ğŸ” ç™»å½• / æ³¨å†Œ</view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...</text>
  </view>

  <!-- æ³¨å†ŒæˆåŠŸç­‰å¾…å®¡æ‰¹çŠ¶æ€ -->
  <view wx:elif="{{submitted}}" class="submit-result">
    <empty-state
      show="{{true}}"
      icon="â³"
      title="æ³¨å†Œå·²æäº¤ï¼Œç­‰å¾…å®¡æ‰¹"
      description="ç®¡ç†å‘˜ä¼šå°½å¿«å®¡æ ¸æ‚¨çš„æ³¨å†Œç”³è¯·ï¼Œé€šè¿‡åæ‚¨å°†æ”¶åˆ°é€šçŸ¥"
      variant="compact">
    </empty-state>
    <view class="actions">
      <ui-button variant="secondary" text="é‡æ–°æäº¤" bindtap="checkLoginStatus" />
      <ui-button variant="primary" text="è¿”å›é¦–é¡µ" bindtap="goHome" />
    </view>
  </view>

  <!-- ä¸»ç•Œé¢ï¼šè¡¨å•å®¹å™¨ï¼ˆéåŠ è½½ã€éå¾…å®¡æ‰¹ï¼‰ -->
  <view wx:elif="{{!loading && !(hasLogin && userInfo && userInfo.status == 'pending')}}" class="form-container">
    <view wx:if="{{testMode}}" class="test-banner">
      <text>ğŸ§ª æµ‹è¯•æ³¨å†Œæ¨¡å¼ï¼šä¸ä¼šå½±å“å½“å‰ç®¡ç†å‘˜è´¦å·</text>
    </view>
    <!-- Tab åˆ‡æ¢ -->
    <view class="tab-bar">
      <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" 
            bindtap="switchTab" 
            data-tab="0">
        <text class="tab-text">ç™»å½•</text>
      </view>
      <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" 
            bindtap="switchTab" 
            data-tab="1">
        <text class="tab-text">æ³¨å†Œ</text>
      </view>
      <view class="tab-indicator" style="transform: translateX({{currentTab * 100}}%);"></view>
    </view>

    <!-- ç™»å½•é¡µé¢ -->
    <view wx:if="{{currentTab === 0}}" class="form login-form">
      <!-- ç™»å½•æ¨¡å¼åˆ‡æ¢ -->
      <view class="login-mode-switch">
        <view class="mode-item {{loginMode === 'wx' ? 'active' : ''}}" 
              bindtap="switchLoginMode" 
              data-mode="wx">
          <text class="mode-text">ğŸš€ å¾®ä¿¡ç™»å½•</text>
        </view>
        <view class="mode-item {{loginMode === 'password' ? 'active' : ''}}" 
              bindtap="switchLoginMode" 
              data-mode="password">
          <text class="mode-text">ğŸ” å¯†ç ç™»å½•</text>
        </view>
      </view>

      <!-- å¾®ä¿¡ç™»å½•åŒºåŸŸ -->
      <view wx:if="{{loginMode === 'wx'}}" class="wx-login-section">
        <view class="login-intro">
          <view class="intro-icon">ğŸ‘‹</view>
          <view class="intro-content">
            <text class="intro-title">æ¬¢è¿æ¥åˆ°å°å®¶æœåŠ¡ç®¡ç†ä¸­å¿ƒ</text>
            <text class="intro-desc">ä½¿ç”¨å¾®ä¿¡è´¦å·ç™»å½•ï¼Œäº«å—ä¾¿æ·çš„æœåŠ¡ç®¡ç†ä½“éªŒ</text>
          </view>
        </view>

        <view class="login-features">
          <view class="feature-item">
            <text class="feature-icon">ğŸ”</text>
            <text class="feature-text">å®‰å…¨å¯é çš„å¾®ä¿¡ç™»å½•</text>
          </view>
          <view class="feature-item">
            <text class="feature-icon">ğŸ“±</text>
            <text class="feature-text">ä¸€é”®æˆæƒï¼Œæ— éœ€å¯†ç </text>
          </view>
          <view class="feature-item">
            <text class="feature-icon">âš¡</text>
            <text class="feature-text">å¿«é€Ÿè®¿é—®ä¸ªäººä¿¡æ¯</text>
          </view>
        </view>

        <view class="submit-actions">
          <ui-button variant="primary" text="ğŸš€ å¾®ä¿¡ç™»å½•" bindtap="wxLogin" fullWidth="{{true}}" />
        </view>

        <view class="login-tip">
          <text class="tip-text">ç‚¹å‡»åå°†æ£€æŸ¥æ‚¨çš„ç™»å½•çŠ¶æ€ï¼Œé¦–æ¬¡ä½¿ç”¨è¯·å®Œæˆæ³¨å†Œæµç¨‹</text>
        </view>
      </view>

      <!-- ç”¨æˆ·åå¯†ç ç™»å½•åŒºåŸŸ -->
      <view wx:elif="{{loginMode === 'password'}}" class="password-login-section">
        <view class="login-intro">
          <view class="intro-icon">ğŸ”</view>
          <view class="intro-content">
            <text class="intro-title">ä¼ ç»Ÿç™»å½•æ–¹å¼</text>
            <text class="intro-desc">ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç ç™»å½•ç³»ç»Ÿ</text>
          </view>
        </view>

        <view class="login-form-fields">
          <view class="form-item">
            <text class="label">æ˜µç§°/å§“å *</text>
            <input class="input" placeholder="è¯·è¾“å…¥æ˜µç§°æˆ–å§“å" 
                   value="{{loginForm.username}}" 
                   bindinput="onLoginInput" 
                   data-field="username" />
            <text class="error" wx:if="{{loginErrors.username}}">{{loginErrors.username}}</text>
          </view>

          <view class="form-item">
            <text class="label">å¯†ç  *</text>
            <input class="input" type="password" placeholder="è¯·è¾“å…¥å¯†ç " 
                   value="{{loginForm.password}}" 
                   bindinput="onLoginInput" 
                   data-field="password" />
            <text class="error" wx:if="{{loginErrors.password}}">{{loginErrors.password}}</text>
          </view>
        </view>

        <!-- é»˜è®¤è´¦å·æç¤º -->
        <view class="default-account-hint">
          <text class="hint-icon">ğŸ’¡</text>
          <view class="hint-content">
            <text class="hint-title">é»˜è®¤ç®¡ç†å‘˜è´¦å·</text>
            <text class="hint-desc" wx:if="{{flags.devBackdoorEnabled}}">ç”¨æˆ·å: admin ã€å¯†ç : 123456ï¼ˆå¼€å‘æ¨¡å¼ï¼‰</text>
          </view>
        </view>

        <view class="submit-actions">
          <ui-button variant="primary" text="ç™»å½•" bindtap="passwordLogin" fullWidth="{{true}}" />
        </view>
      </view>
    </view>

    <!-- æ³¨å†Œè¡¨å• -->
    <view wx:if="{{currentTab === 1}}" class="form register-form">
      <view wx:if="{{userInfo}}" class="user-info-card">
        <image class="user-avatar" src="{{userInfo.avatarUrl}}" />
        <view class="user-details">
          <text class="user-name">{{userInfo.nickName}}</text>
          <text class="user-status">å¾®ä¿¡ç”¨æˆ·å·²æˆæƒ</text>
        </view>
      </view>

      <view wx:else class="auth-required">
        <view class="auth-hint">
          <text class="auth-icon">ğŸ”‘</text>
          <text class="auth-text">è¯·å…ˆé€šè¿‡å¾®ä¿¡ç™»å½•è·å–ç”¨æˆ·ä¿¡æ¯</text>
        </view>
        <ui-button variant="secondary" text="è¿”å›ç™»å½•" bindtap="switchTab" data-tab="0" />
      </view>

      <view wx:if="{{userInfo}}" class="register-fields">
        <view class="form-item">
          <text class="label">æ˜µç§°</text>
          <input class="input" placeholder="å¦‚ï¼šxxxå¦ˆå¦ˆï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨å§“åï¼‰" 
                 value="{{registerForm.nickname}}" 
                 bindinput="onRegisterInput" 
                 data-field="nickname" />
          <text class="error" wx:if="{{registerErrors.nickname}}">{{registerErrors.nickname}}</text>
        </view>

        <view class="form-item">
          <text class="label">ç™»å½•å¯†ç *</text>
          <input class="input" type="password" placeholder="è¯·è®¾ç½®ç™»å½•å¯†ç " 
                 value="{{registerForm.password}}" 
                 bindinput="onRegisterInput" 
                 data-field="password" />
          <text class="error" wx:if="{{registerErrors.password}}">{{registerErrors.password}}</text>
        </view>

        <view class="form-item">
          <text class="label">çœŸå®å§“å*</text>
          <input class="input" placeholder="è¯·è¾“å…¥çœŸå®å§“å" 
                 value="{{registerForm.name}}" 
                 bindinput="onRegisterInput" 
                 data-field="name" />
          <text class="error" wx:if="{{registerErrors.name}}">{{registerErrors.name}}</text>
        </view>

        <view class="form-item">
          <text class="label">è”ç³»ç”µè¯*</text>
          <input class="input" type="number" placeholder="11ä½æ‰‹æœºå·" 
                 value="{{registerForm.phone}}" 
                 bindinput="onRegisterInput" 
                 data-field="phone" />
          <text class="error" wx:if="{{registerErrors.phone}}">{{registerErrors.phone}}</text>
        </view>

        <view class="form-item">
          <text class="label">èº«ä»½è¯å·*</text>
          <input class="input" placeholder="18ä½èº«ä»½è¯å·" 
                 value="{{registerForm.id_card}}" 
                 bindinput="onRegisterInput" 
                 data-field="id_card" />
          <text class="error" wx:if="{{registerErrors.id_card}}">{{registerErrors.id_card}}</text>
        </view>

        <view class="form-item">
          <text class="label">ç”³è¯·èº«ä»½*</text>
          <picker mode="selector" range="{{roleOptions}}" value="{{roleIndex}}" bindchange="onRoleChange">
            <view class="picker-value">{{ roleOptions[roleIndex] }}</view>
          </picker>
          <text class="error" wx:if="{{registerErrors.applyRole}}">{{registerErrors.applyRole}}</text>
        </view>

        <view wx:if="{{registerForm.applyRole==='parent'}}" class="relative-section">
          <view class="section-title">å®¶å±ä¿¡æ¯</view>
          <view class="form-item">
            <text class="label">æ‚£è€…å§“å*</text>
            <input class="input" placeholder="è¯·è¾“å…¥æ‚£è€…å§“å" 
                   value="{{registerForm.relative.patientName}}" 
                   bindinput="onRelativeInput" 
                   data-field="patientName" />
            <text class="error" wx:if="{{registerErrors['relative.patientName']}}">{{registerErrors['relative.patientName']}}</text>
          </view>
          <view class="form-item">
            <text class="label">å…³ç³»*</text>
            <picker mode="selector" range="{{relationOptions}}" value="{{relationIndex}}" bindchange="onRelationChange">
              <view class="picker-value">{{ relationOptions[relationIndex] }}</view>
            </picker>
            <text class="error" wx:if="{{registerErrors['relative.relation']}}">{{registerErrors['relative.relation']}}</text>
          </view>
          <view class="form-item">
            <text class="label">æ‚£è€…èº«ä»½è¯å·*</text>
            <input class="input" placeholder="18ä½èº«ä»½è¯å·" 
                   value="{{registerForm.relative.patientIdCard}}" 
                   bindinput="onRelativeInput" 
                   data-field="patientIdCard" />
            <text class="error" wx:if="{{registerErrors['relative.patientIdCard']}}">{{registerErrors['relative.patientIdCard']}}</text>
          </view>
        </view>

        <view class="submit-actions">
          <ui-button variant="primary" text="æäº¤æ³¨å†Œç”³è¯·" bindtap="onRegisterSubmit" fullWidth="{{true}}" />
        </view>
      </view>
    </view>
  </view>

  <!-- å·²ç™»å½•ä½†æœªå®¡æ‰¹é€šè¿‡çš„çŠ¶æ€ -->
  <view wx:elif="{{hasLogin && userInfo && userInfo.status == 'pending'}}" class="pending-status">
    <empty-state
      show="{{true}}"
      icon="â³"
      title="ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹"
      description="æ‚¨çš„æ³¨å†Œç”³è¯·æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…"
      variant="compact">
    </empty-state>
    <view class="actions">
      <ui-button variant="secondary" text="åˆ·æ–°çŠ¶æ€" bindtap="checkLoginStatus" />
      <ui-button variant="primary" text="è¿”å›é¦–é¡µ" bindtap="goHome" />
    </view>
  </view>

  <view wx:else class="fallback-container">
    <view class="fallback-content">
      <text class="fallback-icon">ğŸŒ€</text>
      <text class="fallback-title">æ­£åœ¨å¤„ç†...</text>
      <text class="fallback-desc">å¦‚é•¿æ—¶é—´æ— å“åº”ï¼Œè¯·è¿”å›é¦–é¡µé‡è¯•</text>
      <button class="fallback-btn" bindtap="goHome">è¿”å›é¦–é¡µ</button>
    </view>
  </view>

  
</view>
