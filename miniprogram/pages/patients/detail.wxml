<!-- éª¨æ¶å± -->
<loading-skeleton 
  id="loading-skeleton"
  type="detail" 
  show="{{showSkeleton}}" 
  animation="shimmer"
  wx:if="{{showSkeleton}}" />

<view class="detail-page" wx:if="{{!loading}}">
  <!-- å¯¼èˆªå¤´éƒ¨åŒº -->
  <view class="nav-header {{theme.headerBg}}">
    <view class="nav-left" bindtap="navigateBack">
      <text class="nav-icon">â†</text>
      <view class="nav-title">ğŸ“‹ æ‚£è€…æ¡£æ¡ˆ</view>
    </view>
    <view class="nav-actions">
      <view class="nav-tool" bindtap="toggleStar">
        <text class="nav-icon {{starred ? 'active' : ''}}">{{starred ? 'â˜…' : 'â˜†'}}</text>
      </view>
      <view class="nav-tool" bindtap="shareProfile" wx:if="{{canShare}}">
        <text class="nav-icon">ğŸ“¤</text>
      </view>
      <view class="nav-tool" bindtap="showMore">
        <text class="nav-icon">â‹¯</text>
      </view>
    </view>
  </view>

  <!-- æ‚£è€…å¤´éƒ¨ä¿¡æ¯åŒº -->
  <view class="patient-header">
    <view class="patient-main">
      <view class="patient-avatar">
        <text class="avatar-text">{{patient.initial}}</text>
      </view>
      <view class="patient-info">
        <view class="patient-name-line">
          <text class="patient-name">{{patient.displayName}}</text>
          <view class="age-gender">
            <text class="age">{{patient.ageText}}</text>
            <text class="gender" wx:if="{{patient.gender}}">{{patient.gender}}</text>
          </view>
          <text class="birthday-tag" wx:if="{{patient.birthdaySoon}}">ç”Ÿæ—¥</text>
          <view class="count-badge" wx:if="{{admissionCount > 0}}">{{admissionCount}}æ¬¡</view>
        </view>
        <view class="patient-condition">
          <text class="condition-tag">{{patient.mainDiagnosis || 'å¾…ç¡®è¯Š'}}</text>
        </view>
        <!-- å½“å‰ç”¨æˆ·è§’è‰²å¾½ç« ï¼ˆå±•ç¤ºå‹ï¼‰ -->
        <view>
          <role-badge roleKey="{{role}}" size="sm"></role-badge>
        </view>
        <view class="patient-location">
          <text class="location-icon">ğŸ“</text>
          <text class="location-text">{{patient.bedInfo || 'æœªåˆ†é…åºŠä½'}}</text>
          <text class="stay-duration" wx:if="{{patient.stayDuration}}">Â· {{patient.stayDuration}}</text>
        </view>
      </view>
    </view>
    
    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
    <view class="quick-actions">
      <button class="quick-btn primary" bindtap="requestPermissions" wx:if="{{showPermissionButton}}">
        <text class="btn-icon">ğŸ”’</text>
        <text class="btn-text">ç”³è¯·æƒé™</text>
      </button>
      <button class="quick-btn" bindtap="toCreateService">
        <text class="btn-icon">â¤ï¸</text>
        <text class="btn-text">æœåŠ¡è®°å½•</text>
      </button>
      <button class="quick-btn" wx:if="{{role==='parent'}}" bindtap="onUploadPatientPhoto">
        <text class="btn-icon">ğŸ–¼ï¸</text>
        <text class="btn-text">ä¸Šä¼ ç…§ç‰‡</text>
      </button>
    </view>
  </view>

  <!-- æƒé™çŠ¶æ€æç¤ºåŒº -->
  <view class="permission-status {{permissionStatus.type}}" wx:if="{{permissionStatus.show}}">
    <view class="status-content">
      <text class="status-icon">{{permissionStatus.icon}}</text>
      <view class="status-text">
        <text class="status-title">{{permissionStatus.title}}</text>
        <text class="status-desc">{{permissionStatus.desc}}</text>
      </view>
    </view>
    <view class="status-action" wx:if="{{permissionStatus.action}}">
      <button class="status-btn" bindtap="{{permissionStatus.action}}">{{permissionStatus.actionText}}</button>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-area">
    <!-- åŸºç¡€ä¿¡æ¯å¡ç‰‡ -->
    <view class="info-card">
      <view class="card-header">
        <text class="card-title">ğŸ“‹ åŸºç¡€ä¿¡æ¯</text>
        <text class="card-subtitle">{{patientBasicStats}}</text>
        <button class="header-btn" wx:if="{{role==='parent'}}" bindtap="toBasicEdit">ç¼–è¾‘</button>
      </view>
      <view class="card-content">
        <view class="info-grid">
          <view class="info-item" wx:for="{{basicInfoItems}}" wx:key="key">
            <view class="item-label">{{item.label}}</view>
            <view class="item-value {{item.masked ? 'masked' : ''}}">
              <text>{{item.value}}</text>
              <button class="apply-btn mini" wx:if="{{item.needPermission}}" 
                      data-field="{{item.key}}" 
                      bindtap="applyFieldPermission">ç”³è¯·æŸ¥çœ‹</button>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŒ»ç–—ä¿¡æ¯å¡ç‰‡ -->
    <view class="info-card">
      <view class="card-header">
        <text class="card-title">ğŸ¥ åŒ»ç–—ä¿¡æ¯</text>
        <button class="header-btn" wx:if="{{canViewMedical}}" bindtap="showMedicalDetail">è¯¦ç»†</button>
      </view>
      <view class="card-content">
        <view class="medical-overview">
          <view class="diagnosis-section">
            <text class="diagnosis-main">{{patient.hospitalDiagnosis || 'å¾…ç¡®è¯Š'}}</text>
            <text class="diagnosis-date" wx:if="{{patient.diagnosisDate}}">ç¡®è¯Šäº {{patient.diagnosisDate}}</text>
          </view>
          <view class="treatment-section" wx:if="{{patient.treatmentInfo}}">
            <text class="treatment-status">{{patient.treatmentInfo}}</text>
            <text class="treatment-hospital">{{patient.hospital}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å…¥ä½å†å²å¡ç‰‡ -->
    <view class="info-card">
      <view class="card-header">
        <text class="card-title">ğŸ  å…¥ä½å†å²</text>
        <view class="sort-switch">
          <button class="sort-btn" catchtap="toggleTenancySort">{{ tenancySortOrder === 'asc' ? 'å‡åº â†‘' : 'é™åº â†“' }}</button>
        </view>
      </view>
      <view class="card-content">
        <scroll-view class="timeline-scroll" scroll-y wx:if="{{tenancyTimeline.length > 0}}">
          <view class="timeline-item" wx:for="{{tenancyTimeline}}" wx:key="id" wx:for-index="index">
            <view class="timeline-dot {{item.status}}"></view>
            <view class="timeline-content">
              <view class="timeline-date">{{item.dateRange}}</view>
              <view class="timeline-info">
                <text class="timeline-room">{{item.roomInfo}}</text>
                <text class="timeline-status">{{item.statusText}}</text>
              </view>
              <view class="timeline-subsidy" wx:if="{{item.subsidyInfo}}">
                <text>è¡¥åŠ©ï¼š{{item.subsidyInfo}}</text>
              </view>
            </view>
          </view>
        </scroll-view>
        <empty-state
          wx:else
          show="{{true}}"
          icon="ğŸ "
          title="æš‚æ— å…¥ä½è®°å½•"
          description=""
          variant="compact">
        </empty-state>
      </view>
    </view>

    <!-- æœåŠ¡è®°å½•å¡ç‰‡ -->
    <view class="info-card">
      <view class="card-header">
        <text class="card-title">â¤ï¸ æœåŠ¡è®°å½•</text>
        <view class="header-stats">
          <text class="stats-text">æœ¬æœˆ{{currentMonthServices}}æ¬¡</text>
          <button class="header-btn" bindtap="showServiceDetail">æŸ¥çœ‹å…¨éƒ¨</button>
        </view>
      </view>
      <view class="card-content">
        <view class="service-list" wx:if="{{recentServices.length > 0}}">
          <view class="service-item" wx:for="{{recentServices}}" wx:key="id">
            <view class="service-main">
              <view class="service-type">
                <text class="type-icon">{{item.typeIcon}}</text>
                <text class="type-name">{{item.typeName}}</text>
              </view>
              <view class="service-meta">
                <text class="service-date">{{item.dateText}}</text>
                <text class="service-volunteer">{{item.volunteerName}}</text>
              </view>
            </view>
            <view class="service-status">
              <text class="status-badge {{item.statusClass}}">{{item.statusText}}</text>
            </view>
          </view>
        </view>
        <empty-state
          wx:else
          show="{{true}}"
          icon="â¤ï¸"
          title="æš‚æ— æœåŠ¡è®°å½•"
          description=""
          action-text="æ·»åŠ é¦–ä¸ªæœåŠ¡è®°å½•"
          action-icon="âœ¨"
          variant="compact"
          bindaction="onEmptyServiceAction">
        </empty-state>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions">
    <button class="action-btn secondary" wx:if="{{canEdit}}" bindtap="toEdit">
      <text class="btn-icon">âœï¸</text>
      <text>ç¼–è¾‘æ¡£æ¡ˆ</text>
    </button>
    <button class="action-btn secondary" wx:if="{{canManage && !inResidence}}" bindtap="toCreateTenancy">
      <text class="btn-icon">ğŸ </text>
      <text>åŠç†å…¥ä½</text>
    </button>
    <button class="action-btn secondary" wx:if="{{canManage && inResidence}}" bindtap="toCheckout">
      <text class="btn-icon">ğŸ“</text>
      <text>åŠç†å‡ºé™¢</text>
    </button>
    <button class="action-btn primary" bindtap="toCreateService">
      <text class="btn-icon">â¤ï¸</text>
      <text>æ–°å¢æœåŠ¡</text>
    </button>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-container" wx:if="{{loading}}">
  <view class="loading-header">
    <view class="skeleton-nav"></view>
    <view class="skeleton-patient-header">
      <view class="skeleton-avatar"></view>
      <view class="skeleton-info">
        <view class="skeleton-line long"></view>
        <view class="skeleton-line medium"></view>
        <view class="skeleton-line short"></view>
      </view>
    </view>
  </view>
  <view class="loading-content">
    <view class="skeleton-card" wx:for="{{[1,2,3]}}" wx:key="*this">
      <view class="skeleton-card-header">
        <view class="skeleton-line medium"></view>
        <view class="skeleton-line short"></view>
      </view>
      <view class="skeleton-card-content">
        <view class="skeleton-line" wx:for="{{[1,2,3,4]}}" wx:key="*this"></view>
      </view>
    </view>
  </view>
</view>

<!-- é”™è¯¯çŠ¶æ€ -->
<view class="error-container" wx:if="{{error && !loading}}">
  <view class="error-content">
    <text class="error-icon">ğŸ˜”</text>
    <text class="error-title">åŠ è½½å¤±è´¥</text>
    <text class="error-message">{{error.message || 'æ— æ³•è·å–æ‚£è€…ä¿¡æ¯'}}</text>
    <button class="error-retry" bindtap="retryLoad">é‡æ–°åŠ è½½</button>
  </view>
</view>

<!-- æƒé™ç”³è¯·å¼¹çª— -->
<view class="permission-modal {{showPermissionModal ? 'show' : ''}}" catchtap="hidePermissionModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç”³è¯·æŸ¥çœ‹æƒé™</text>
      <button class="modal-close" bindtap="hidePermissionModal">âœ•</button>
    </view>
    <view class="modal-body">
      <view class="permission-fields">
        <text class="fields-title">é€‰æ‹©éœ€è¦æŸ¥çœ‹çš„ä¿¡æ¯ï¼š</text>
        <view class="field-list">
          <view class="field-item" wx:for="{{availableFields}}" wx:key="key">
            <checkbox class="field-checkbox" 
                      value="{{item.key}}" 
                      checked="{{item.selected}}"
                      bindchange="togglePermissionField"/>
            <text class="field-label">{{item.label}}</text>
            <text class="field-desc">{{item.desc}}</text>
          </view>
        </view>
      </view>
      <view class="permission-reason">
        <text class="reason-title">ç”³è¯·ç†ç”±ï¼š</text>
        <textarea class="reason-input" 
                  placeholder="è¯·è¯´æ˜æŸ¥çœ‹è¿™äº›ä¿¡æ¯çš„å…·ä½“ç”¨é€”..."
                  value="{{permissionReason}}"
                  bindinput="onReasonInput"
                  maxlength="200"></textarea>
        <text class="reason-count">{{permissionReason.length}}/200</text>
      </view>
      <view class="permission-duration">
        <text class="duration-title">ç”³è¯·æ—¶é•¿ï¼š</text>
        <view class="duration-options">
          <view class="duration-item {{item.active ? 'active' : ''}}" 
                wx:for="{{durationOptions}}" 
                wx:key="value"
                data-value="{{item.value}}"
                bindtap="selectDuration">
            <text class="duration-text">{{item.text}}</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn secondary" bindtap="hidePermissionModal">å–æ¶ˆ</button>
      <button class="modal-btn primary" bindtap="submitPermissionRequest">æäº¤ç”³è¯·</button>
    </view>
  </view>
</view>
