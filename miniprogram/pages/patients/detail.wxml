<!-- 骨架屏 -->
<loading-skeleton 
  id="loading-skeleton"
  type="detail" 
  show="{{showSkeleton}}" 
  animation="shimmer"
  wx:if="{{showSkeleton}}" />

<view class="detail-page" wx:if="{{!loading}}">
  <!-- 导航头部区 -->
  <view class="nav-header {{theme.headerBg}}">
    <view class="nav-left" bindtap="navigateBack">
      <text class="nav-icon">←</text>
      <view class="nav-title">📋 患者档案</view>
    </view>
    <view class="nav-actions">
      <view class="nav-tool" bindtap="toggleStar">
        <text class="nav-icon {{starred ? 'active' : ''}}">{{starred ? '★' : '☆'}}</text>
      </view>
      <view class="nav-tool" bindtap="shareProfile" wx:if="{{canShare}}">
        <text class="nav-icon">📤</text>
      </view>
      <view class="nav-tool" bindtap="showMore">
        <text class="nav-icon">⋯</text>
      </view>
    </view>
  </view>

  <!-- 患者头部信息区 -->
  <view class="patient-header">
    <view class="patient-main">
      <view class="patient-avatar">
        <text class="avatar-text">{{patient.initial}}</text>
      </view>
      <view class="patient-info">
        <view class="patient-name-line">
          <text class="patient-name">{{patient.displayName}}</text>
          <view class="age-gender">
            <text class="age">{{patient.ageText}}</text>
            <text class="gender" wx:if="{{patient.gender}}">{{patient.gender}}</text>
          </view>
          <text class="birthday-tag" wx:if="{{patient.birthdaySoon}}">生日</text>
          <view class="count-badge" wx:if="{{admissionCount > 0}}">{{admissionCount}}次</view>
        </view>
        <view class="patient-condition">
          <text class="condition-tag">{{patient.mainDiagnosis || '待确诊'}}</text>
        </view>
        <!-- 当前用户角色徽章（展示型） -->
        <view>
          <role-badge roleKey="{{role}}" size="sm"></role-badge>
        </view>
        <view class="patient-location">
          <text class="location-icon">📍</text>
          <text class="location-text">{{patient.bedInfo || '未分配床位'}}</text>
          <text class="stay-duration" wx:if="{{patient.stayDuration}}">· {{patient.stayDuration}}</text>
        </view>
      </view>
    </view>
    
    <!-- 快速操作按钮 -->
    <view class="quick-actions">
      <button class="quick-btn primary" bindtap="requestPermissions" wx:if="{{showPermissionButton}}">
        <text class="btn-icon">🔒</text>
        <text class="btn-text">申请权限</text>
      </button>
      <button class="quick-btn" bindtap="toCreateService">
        <text class="btn-icon">❤️</text>
        <text class="btn-text">服务记录</text>
      </button>
      <button class="quick-btn" wx:if="{{role==='parent'}}" bindtap="onUploadPatientPhoto">
        <text class="btn-icon">🖼️</text>
        <text class="btn-text">上传照片</text>
      </button>
    </view>
  </view>

  <!-- 权限状态提示区 -->
  <view class="permission-status {{permissionStatus.type}}" wx:if="{{permissionStatus.show}}">
    <view class="status-content">
      <text class="status-icon">{{permissionStatus.icon}}</text>
      <view class="status-text">
        <text class="status-title">{{permissionStatus.title}}</text>
        <text class="status-desc">{{permissionStatus.desc}}</text>
      </view>
    </view>
    <view class="status-action" wx:if="{{permissionStatus.action}}">
      <button class="status-btn" bindtap="{{permissionStatus.action}}">{{permissionStatus.actionText}}</button>
    </view>
  </view>

  <!-- 内容区域 -->
  <view class="content-area">
    <!-- 基础信息卡片 -->
    <view class="info-card">
      <view class="card-header">
        <text class="card-title">📋 基础信息</text>
        <text class="card-subtitle">{{patientBasicStats}}</text>
        <button class="header-btn" wx:if="{{role==='parent'}}" bindtap="toBasicEdit">编辑</button>
      </view>
      <view class="card-content">
        <view class="info-grid">
          <view class="info-item" wx:for="{{basicInfoItems}}" wx:key="key">
            <view class="item-label">{{item.label}}</view>
            <view class="item-value {{item.masked ? 'masked' : ''}}">
              <text>{{item.value}}</text>
              <button class="apply-btn mini" wx:if="{{item.needPermission}}" 
                      data-field="{{item.key}}" 
                      bindtap="applyFieldPermission">申请查看</button>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 医疗信息卡片 -->
    <view class="info-card">
      <view class="card-header">
        <text class="card-title">🏥 医疗信息</text>
        <button class="header-btn" wx:if="{{canViewMedical}}" bindtap="showMedicalDetail">详细</button>
      </view>
      <view class="card-content">
        <view class="medical-overview">
          <view class="diagnosis-section">
            <text class="diagnosis-main">{{patient.hospitalDiagnosis || '待确诊'}}</text>
            <text class="diagnosis-date" wx:if="{{patient.diagnosisDate}}">确诊于 {{patient.diagnosisDate}}</text>
          </view>
          <view class="treatment-section" wx:if="{{patient.treatmentInfo}}">
            <text class="treatment-status">{{patient.treatmentInfo}}</text>
            <text class="treatment-hospital">{{patient.hospital}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 入住历史卡片 -->
    <view class="info-card">
      <view class="card-header">
        <text class="card-title">🏠 入住历史</text>
        <view class="sort-switch">
          <button class="sort-btn" catchtap="toggleTenancySort">{{ tenancySortOrder === 'asc' ? '升序 ↑' : '降序 ↓' }}</button>
        </view>
      </view>
      <view class="card-content">
        <scroll-view class="timeline-scroll" scroll-y wx:if="{{tenancyTimeline.length > 0}}">
          <view class="timeline-item" wx:for="{{tenancyTimeline}}" wx:key="id" wx:for-index="index">
            <view class="timeline-dot {{item.status}}"></view>
            <view class="timeline-content">
              <view class="timeline-date">{{item.dateRange}}</view>
              <view class="timeline-info">
                <text class="timeline-room">{{item.roomInfo}}</text>
                <text class="timeline-status">{{item.statusText}}</text>
              </view>
              <view class="timeline-subsidy" wx:if="{{item.subsidyInfo}}">
                <text>补助：{{item.subsidyInfo}}</text>
              </view>
            </view>
          </view>
        </scroll-view>
        <empty-state
          wx:else
          show="{{true}}"
          icon="🏠"
          title="暂无入住记录"
          description=""
          variant="compact">
        </empty-state>
      </view>
    </view>

    <!-- 服务记录卡片 -->
    <view class="info-card">
      <view class="card-header">
        <text class="card-title">❤️ 服务记录</text>
        <view class="header-stats">
          <text class="stats-text">本月{{currentMonthServices}}次</text>
          <button class="header-btn" bindtap="showServiceDetail">查看全部</button>
        </view>
      </view>
      <view class="card-content">
        <view class="service-list" wx:if="{{recentServices.length > 0}}">
          <view class="service-item" wx:for="{{recentServices}}" wx:key="id">
            <view class="service-main">
              <view class="service-type">
                <text class="type-icon">{{item.typeIcon}}</text>
                <text class="type-name">{{item.typeName}}</text>
              </view>
              <view class="service-meta">
                <text class="service-date">{{item.dateText}}</text>
                <text class="service-volunteer">{{item.volunteerName}}</text>
              </view>
            </view>
            <view class="service-status">
              <text class="status-badge {{item.statusClass}}">{{item.statusText}}</text>
            </view>
          </view>
        </view>
        <empty-state
          wx:else
          show="{{true}}"
          icon="❤️"
          title="暂无服务记录"
          description=""
          action-text="添加首个服务记录"
          action-icon="✨"
          variant="compact"
          bindaction="onEmptyServiceAction">
        </empty-state>
      </view>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-actions">
    <button class="action-btn secondary" wx:if="{{canEdit}}" bindtap="toEdit">
      <text class="btn-icon">✏️</text>
      <text>编辑档案</text>
    </button>
    <button class="action-btn secondary" wx:if="{{canManage && !inResidence}}" bindtap="toCreateTenancy">
      <text class="btn-icon">🏠</text>
      <text>办理入住</text>
    </button>
    <button class="action-btn secondary" wx:if="{{canManage && inResidence}}" bindtap="toCheckout">
      <text class="btn-icon">📝</text>
      <text>办理出院</text>
    </button>
    <button class="action-btn primary" bindtap="toCreateService">
      <text class="btn-icon">❤️</text>
      <text>新增服务</text>
    </button>
  </view>
</view>

<!-- 加载状态 -->
<view class="loading-container" wx:if="{{loading}}">
  <view class="loading-header">
    <view class="skeleton-nav"></view>
    <view class="skeleton-patient-header">
      <view class="skeleton-avatar"></view>
      <view class="skeleton-info">
        <view class="skeleton-line long"></view>
        <view class="skeleton-line medium"></view>
        <view class="skeleton-line short"></view>
      </view>
    </view>
  </view>
  <view class="loading-content">
    <view class="skeleton-card" wx:for="{{[1,2,3]}}" wx:key="*this">
      <view class="skeleton-card-header">
        <view class="skeleton-line medium"></view>
        <view class="skeleton-line short"></view>
      </view>
      <view class="skeleton-card-content">
        <view class="skeleton-line" wx:for="{{[1,2,3,4]}}" wx:key="*this"></view>
      </view>
    </view>
  </view>
</view>

<!-- 错误状态 -->
<view class="error-container" wx:if="{{error && !loading}}">
  <view class="error-content">
    <text class="error-icon">😔</text>
    <text class="error-title">加载失败</text>
    <text class="error-message">{{error.message || '无法获取患者信息'}}</text>
    <button class="error-retry" bindtap="retryLoad">重新加载</button>
  </view>
</view>

<!-- 权限申请弹窗 -->
<view class="permission-modal {{showPermissionModal ? 'show' : ''}}" catchtap="hidePermissionModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">申请查看权限</text>
      <button class="modal-close" bindtap="hidePermissionModal">✕</button>
    </view>
    <view class="modal-body">
      <view class="permission-fields">
        <text class="fields-title">选择需要查看的信息：</text>
        <view class="field-list">
          <view class="field-item" wx:for="{{availableFields}}" wx:key="key">
            <checkbox class="field-checkbox" 
                      value="{{item.key}}" 
                      checked="{{item.selected}}"
                      bindchange="togglePermissionField"/>
            <text class="field-label">{{item.label}}</text>
            <text class="field-desc">{{item.desc}}</text>
          </view>
        </view>
      </view>
      <view class="permission-reason">
        <text class="reason-title">申请理由：</text>
        <textarea class="reason-input" 
                  placeholder="请说明查看这些信息的具体用途..."
                  value="{{permissionReason}}"
                  bindinput="onReasonInput"
                  maxlength="200"></textarea>
        <text class="reason-count">{{permissionReason.length}}/200</text>
      </view>
      <view class="permission-duration">
        <text class="duration-title">申请时长：</text>
        <view class="duration-options">
          <view class="duration-item {{item.active ? 'active' : ''}}" 
                wx:for="{{durationOptions}}" 
                wx:key="value"
                data-value="{{item.value}}"
                bindtap="selectDuration">
            <text class="duration-text">{{item.text}}</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn secondary" bindtap="hidePermissionModal">取消</button>
      <button class="modal-btn primary" bindtap="submitPermissionRequest">提交申请</button>
    </view>
  </view>
</view>
