<view class="page">
  <!-- å¯¼èˆªå¤´éƒ¨åŒº -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">ğŸ“‹ æ‚£è€…æ¡£æ¡ˆ</view>
    <view class="nav-actions">
      <view class="nav-tool nav-search" bindtap="focusSearch">
        <text class="nav-icon">ğŸ”</text>
      </view>
      <view class="nav-tool nav-stats" bindtap="showStats">
        <text class="nav-icon">ğŸ“Š</text>
      </view>
    </view>
  </view>

  <!-- ä¼˜åŒ–æœç´¢åŒºåŸŸ -->
  <view class="search-section">
    <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
    <view class="stats-overview" wx:if="{{!keyword}}">
      <view class="overview-item primary">
        <text class="overview-number">{{allList.length || 0}}</text>
        <text class="overview-label">æ€»æ¡£æ¡ˆ</text>
      </view>
      <view class="overview-item">
        <text class="overview-number">{{inhouseList.length || 0}}</text>
        <text class="overview-label">åœ¨ä½</text>
      </view>
      <view class="overview-item">
        <text class="overview-number">{{starredList.length || 0}}</text>
        <text class="overview-label">é‡ç‚¹å…³æ³¨</text>
      </view>
      <view class="overview-item">
        <text class="overview-number">{{getNewAdmissionCount()}}</text>
        <text class="overview-label">æ–°å…¥ä½</text>
      </view>
    </view>
    
    <!-- æœç´¢è¾“å…¥æ¡† -->
    <view class="search-container">
      <view class="search-bar {{keyword ? 'active' : ''}}">
        <text class="search-icon">ğŸ”</text>
        <input 
          id="searchInput"
          class="search-input" 
          placeholder="æœç´¢æ‚£è€…å§“åæˆ–èº«ä»½è¯å4ä½" 
          value="{{keyword}}" 
          bindinput="onInput" 
          confirm-type="search" 
          bindconfirm="performSearchConfirm"
        />
        <button class="clear-btn" wx:if="{{keyword}}" catchtap="clearSearch">
          <text class="clear-icon">âœ•</text>
        </button>
      </view>
      <button class="filter-btn {{activeFilterCount > 0 ? 'active' : ''}}" bindtap="toggleAdvancedFilter">
        <text class="filter-icon">ğŸ·ï¸</text>
        <text class="filter-count" wx:if="{{activeFilterCount > 0}}">{{activeFilterCount}}</text>
      </button>
    </view>
    
    <!-- ä¼˜åŒ–é«˜çº§ç­›é€‰é¢æ¿ -->
    <view class="advanced-filter {{showAdvancedFilter ? 'show' : ''}}">
      <view class="filter-header">
        <text class="filter-title">é«˜çº§ç­›é€‰</text>
        <button class="close-filter" catchtap="toggleAdvancedFilter">âœ•</button>
      </view>
      
      <view class="filter-section">
        <text class="filter-label">ğŸ“ å…¥ä½çŠ¶æ€</text>
        <view class="filter-tags">
          <block wx:for="{{statusFilters}}" wx:key="key">
            <view class="filter-tag {{item.active ? 'active' : ''}}" 
                  data-key="{{item.key}}" 
                  bindtap="toggleStatusFilter">
              <text class="tag-text">{{item.text}}</text>
              <text class="tag-icon" wx:if="{{item.active}}">âœ“</text>
            </view>
          </block>
        </view>
      </view>
      
      <view class="filter-section">
        <text class="filter-label">ğŸ‘¶ å¹´é¾„æ®µ</text>
        <view class="filter-tags">
          <block wx:for="{{ageFilters}}" wx:key="key">
            <view class="filter-tag {{item.active ? 'active' : ''}}" 
                  data-key="{{item.key}}" 
                  bindtap="toggleAgeFilter">
              <text class="tag-text">{{item.text}}</text>
              <text class="tag-icon" wx:if="{{item.active}}">âœ“</text>
            </view>
          </block>
        </view>
      </view>
      
      <view class="filter-section">
        <text class="filter-label">ğŸ“… å»ºæ¡£æ—¶é—´</text>
        <view class="date-range">
          <picker mode="date" value="{{fromDate}}" bindchange="setFromDate">
            <view class="date-picker {{fromDate ? 'selected' : ''}}">
              <text class="date-icon">ğŸ“…</text>
              <text class="date-text">{{fromDate || 'å¼€å§‹æ—¥æœŸ'}}</text>
            </view>
          </picker>
          <text class="date-separator">â€”</text>
          <picker mode="date" value="{{toDate}}" bindchange="setToDate">
            <view class="date-picker {{toDate ? 'selected' : ''}}">
              <text class="date-icon">ğŸ“…</text>
              <text class="date-text">{{toDate || 'ç»“æŸæ—¥æœŸ'}}</text>
            </view>
          </picker>
        </view>
      </view>
      
      <view class="filter-actions">
        <button class="reset-btn" bindtap="resetFilters">
          <text class="action-icon">ğŸ”„</text>
          <text class="action-text">é‡ç½®</text>
        </button>
        <button class="apply-btn" bindtap="applyFilters">
          <text class="action-icon">âœ“</text>
          <text class="action-text">åº”ç”¨ç­›é€‰ {{activeFilterCount > 0 ? '(' + activeFilterCount + ')' : ''}}</text>
        </button>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿç­›é€‰æ ‡ç­¾ -->
  <view class="quick-filters">
    <block wx:for="{{quickTabs}}" wx:key="key">
      <view class="quick-filter {{item.key===activeQuickFilter?'active':''}}" 
            data-key="{{item.key}}" 
            bindtap="setQuickFilter">
        <text class="filter-emoji">{{item.emoji}}</text>
        <text class="filter-name">{{item.text}}</text>
        <text class="filter-count" wx:if="{{item.count !== undefined}}">({{item.count}})</text>
      </view>
    </block>
  </view>

  <!-- ä¼˜å…ˆå…³æ³¨ç»„ -->
  <view class="priority-section" wx:if="{{starredList.length > 0}}">
    <view class="section-header priority">
      <text class="section-icon">â­</text>
      <text class="section-title">ä¼˜å…ˆå…³æ³¨</text>
      <text class="section-count">({{starredList.length}})</text>
      <button class="expand-btn" bindtap="toggleStarredExpand">
        {{starredExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}
      </button>
    </view>
    <view class="patient-list" wx:if="{{starredExpanded}}">
      <block wx:for="{{starredList}}" wx:key="_id">
        <view class="patient-item priority-item" bindtap="toDetail" data-id="{{item._id}}">
          <view class="patient-avatar priority-avatar">{{item.initial}}</view>
          <view class="patient-info">
            <view class="patient-name-line">
              <text class="patient-name">{{item.maskedName}}</text>
              <text class="patient-age" wx:if="{{item.ageText}}"> Â· {{item.ageText}}</text>
              <text class="priority-badge">é‡ç‚¹å…³æ³¨</text>
            </view>
            <view class="patient-details">
              <text class="bed-info">{{item.bedInfo || 'æš‚æ— åºŠä½ä¿¡æ¯'}}</text>
              <text class="admission-info">å…¥ä½ {{item.admissionDays}}å¤©</text>
            </view>
            <view class="patient-condition">
              <text class="condition-tag main">{{item.mainDiagnosis || 'å¾…ç¡®è¯Š'}}</text>
              <text class="status-tag {{item.statusClass}}">{{item.statusText}}</text>
            </view>
            <view class="recent-activity">
              <text class="activity-icon">â¤ï¸</text>
              <text class="activity-text">{{item.recentService || 'æš‚æ— æœåŠ¡è®°å½•'}}</text>
            </view>
          </view>
          <view class="patient-actions-mini">
            <button class="mini-btn contact" catchtap="contactFamily" data-id="{{item._id}}">ğŸ“</button>
            <button class="mini-btn service" catchtap="toService" data-id="{{item._id}}">â¤ï¸</button>
            <button class="mini-btn star active" catchtap="toggleStar" data-id="{{item._id}}">â˜…</button>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- éª¨æ¶å± -->
  <loading-skeleton 
    id="loading-skeleton"
    type="list" 
    count="5" 
    show="{{showSkeleton}}" 
    animation="shimmer"
    wx:if="{{showSkeleton}}" />

  <!-- å½“å‰åœ¨ä½æ‚£è€…ç»„ -->
  <view class="inhouse-section" wx:if="{{inhouseList.length > 0}}">
    <view class="section-header inhouse">
      <text class="section-icon">ğŸ </text>
      <text class="section-title">å½“å‰åœ¨ä½</text>
      <text class="section-subtitle">- {{currentBuilding}}</text>
      <text class="section-count">({{inhouseList.length}})</text>
      <button class="building-switch" bindtap="switchBuilding">åˆ‡æ¢æ¥¼æ ‹</button>
    </view>
    <view class="patient-list">
      <block wx:for="{{inhouseList}}" wx:key="_id">
        <view class="patient-item" bindtap="toDetail" data-id="{{item._id}}">
          <view class="patient-avatar">{{item.initial}}</view>
          <view class="patient-info">
            <view class="patient-name-line">
              <text class="patient-name">{{item.maskedName}}</text>
              <text class="patient-age" wx:if="{{item.ageText}}"> Â· {{item.ageText}}</text>
              <text class="new-badge" wx:if="{{item.isNewAdmission}}">æ–°å…¥ä½</text>
            </view>
            <view class="patient-details">
              <text class="bed-info">{{item.bedInfo}}</text>
              <text class="admission-info">å…¥ä½ {{item.admissionDays}}å¤©</text>
              <text class="subsidy-info" wx:if="{{item.subsidyAmount}}">è¡¥åŠ© Â¥{{item.subsidyAmount}}/æœˆ</text>
            </view>
            <view class="patient-condition">
              <text class="condition-tag main">{{item.mainDiagnosis}}</text>
              <text class="treatment-tag">{{item.treatmentStatus}}</text>
            </view>
          </view>
          <view class="patient-actions-mini">
            <button class="mini-btn edit" catchtap="editPatient" data-id="{{item._id}}">âœï¸</button>
            <button class="mini-btn service" catchtap="toService" data-id="{{item._id}}">â¤ï¸</button>
            <button class="mini-btn star {{starred[item._id] ? 'active' : ''}}" catchtap="toggleStar" data-id="{{item._id}}">{{starred[item._id] ? 'â˜…' : 'â˜†'}}</button>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- å…¨éƒ¨æ‚£è€…å…œåº•åˆ†ç»„ï¼ˆæ— çŠ¶æ€åˆ†ç»„æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="all-section" wx:if="{{!showSearchResults && inhouseList.length === 0 && historyList.length === 0 && allList.length > 0}}">
    <view class="section-header">
      <text class="section-icon">ğŸ“‹</text>
      <text class="section-title">å…¨éƒ¨</text>
      <text class="section-count">({{allList.length}})</text>
    </view>
    <view class="patient-list">
      <block wx:for="{{allList}}" wx:key="_id">
        <view class="patient-item" bindtap="toDetail" data-id="{{item._id}}">
          <view class="patient-avatar">{{item.initial}}</view>
          <view class="patient-info">
            <view class="patient-name-line">
              <text class="patient-name">{{item.maskedName}}</text>
              <text class="patient-age" wx:if="{{item.ageText}}"> Â· {{item.ageText}}</text>
            </view>
            <view class="patient-details">
              <text class="bed-info">{{item.bedInfo || 'â€”'}}</text>
              <text class="admission-info" wx:if="{{item.admissionDays}}">å…¥ä½ {{item.admissionDays}}å¤©</text>
            </view>
          </view>
          <view class="patient-actions-mini">
            <button class="mini-btn service" catchtap="toService" data-id="{{item._id}}">â¤ï¸</button>
            <button class="mini-btn star {{starred[item._id] ? 'active' : ''}}" catchtap="toggleStar" data-id="{{item._id}}">{{starred[item._id] ? 'â˜…' : 'â˜†'}}</button>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- å†å²æ¡£æ¡ˆç»„ -->
  <view class="history-section" wx:if="{{historyList.length > 0}}">
    <view class="section-header history">
      <text class="section-icon">ğŸ“š</text>
      <text class="section-title">å†å²æ¡£æ¡ˆ</text>
      <text class="section-count">(å·²å‡ºé™¢)</text>
      <button class="expand-btn" bindtap="toggleHistoryExpand">
        {{historyExpanded ? 'æ”¶èµ·' : 'æŸ¥çœ‹æ›´å¤š'}}
      </button>
    </view>
    <view class="patient-list compact" wx:if="{{historyExpanded}}">
      <block wx:for="{{historyList}}" wx:key="_id">
        <view class="patient-item compact" bindtap="toDetail" data-id="{{item._id}}">
          <view class="patient-avatar history">{{item.initial}}</view>
          <view class="patient-info">
            <text class="patient-name">{{item.maskedName}} Â· {{item.ageText}}</text>
            <text class="discharge-info">{{item.dischargeInfo}}</text>
          </view>
          <text class="arrow">ã€‰</text>
        </view>
      </block>
      <view class="load-more" wx:if="{{hasMoreHistory}}" bindtap="loadMoreHistory">
        <text class="load-more-text">åŠ è½½æ›´å¤šå†å²æ¡£æ¡ˆ...</text>
      </view>
    </view>
  </view>

  <!-- å…¨éƒ¨æœç´¢ç»“æœ -->
  <view class="search-results" wx:if="{{showSearchResults}}">
    <view class="section-header search">
      <text class="section-icon">ğŸ¯</text>
      <text class="section-title">æœç´¢ç»“æœ</text>
      <text class="section-count">({{searchResultCount}})</text>
    </view>
    <view class="patient-list">
      <block wx:for="{{searchResults}}" wx:key="_id">
        <view class="patient-item" bindtap="toDetail" data-id="{{item._id}}">
          <view class="patient-avatar">{{item.initial}}</view>
          <view class="patient-info">
            <view class="patient-name-line">
              <text class="patient-name highlight">{{item.highlightedName}}</text>
              <text class="patient-age" wx:if="{{item.ageText}}"> Â· {{item.ageText}}</text>
              <text class="match-type">{{item.matchType}}</text>
            </view>
            <view class="patient-details">
              <text class="bed-info">{{item.bedInfo || 'å·²å‡ºé™¢'}}</text>
              <text class="match-context">{{item.matchContext}}</text>
            </view>
          </view>
          <text class="arrow">ã€‰</text>
        </view>
      </block>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <empty-state
    wx:if="{{!loading && showEmptyState}}"
    show="{{true}}"
    icon="ğŸ“‹"
    title="{{emptyTitle}}"
    description="{{emptySubtitle}}"
    action-text="{{emptyActionText}}"
    action-icon="âœ¨"
    action-disabled="{{!showEmptyAction}}"
    bindaction="onEmptyAction">
  </empty-state>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-section" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨åŠ è½½æ¡£æ¡ˆæ•°æ®...</text>
  </view>

  <!-- æµ®åŠ¨æ–°å»ºæŒ‰é’® -->
  <view class="floating-fab" bindtap="toNew">
    <text class="fab-icon">â•</text>
  </view>
  
  <!-- å¿«é€Ÿæ“ä½œé¢æ¿ -->
  <view class="quick-actions-panel {{showQuickActions ? 'show' : ''}}" catchtap="hideQuickActions">
    <view class="quick-actions-content" catchtap="stopPropagation">
      <view class="quick-action" bindtap="bulkExport">
        <text class="action-icon">ğŸ“„</text>
        <text class="action-text">æ‰¹é‡å¯¼å‡º</text>
      </view>
      <view class="quick-action" bindtap="bulkMessage">
        <text class="action-icon">ğŸ’¬</text>
        <text class="action-text">ç¾¤å‘æ¶ˆæ¯</text>
      </view>
      <view class="quick-action" bindtap="showStatistics">
        <text class="action-icon">ğŸ“Š</text>
        <text class="action-text">ç»Ÿè®¡åˆ†æ</text>
      </view>
    </view>
  </view>
</view>
