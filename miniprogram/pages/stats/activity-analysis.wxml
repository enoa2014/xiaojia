<view class="page">
  <!-- å¯¼èˆªå¤´éƒ¨ -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">ğŸ¯ æ´»åŠ¨å‚ä¸åˆ†æ</view>
    <view class="nav-actions">
      <text bindtap="onRefresh" class="nav-refresh">ğŸ”„</text>
    </view>
  </view>

  <!-- æƒé™æ£€æŸ¥ -->
  <view wx:if="{{!canView}}" class="no-permission">
    <empty-state
      show="{{true}}"
      icon="ğŸ”’"
      title="æƒé™ä¸è¶³"
      description="æ´»åŠ¨å‚ä¸åˆ†æä»…ç®¡ç†å‘˜å’Œç¤¾å·¥å¯è§"
      variant="compact">
    </empty-state>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- æ—¶é—´é€‰æ‹©å™¨ -->
    <view class="time-selector">
      <view class="time-tabs">
        <text bindtap="onTimeRangeChange" data-range="month" class="time-tab {{timeRange==='month'?'active':''}}">æœ¬æœˆ</text>
        <text bindtap="onTimeRangeChange" data-range="quarter" class="time-tab {{timeRange==='quarter'?'active':''}}">æœ¬å­£</text>
      </view>
      
      <!-- æœˆä»½é€‰æ‹© -->
      <picker wx:if="{{timeRange==='month'}}" mode="date" fields="month" value="{{selectedMonth}}" bindchange="onMonthChange">
        <view class="custom-date">{{selectedMonth}} ã€‰</view>
      </picker>
      
      <!-- å­£åº¦é€‰æ‹© -->
      <picker wx:if="{{timeRange==='quarter'}}" mode="selector" value="{{selectedQuarter}}" bindchange="onQuarterChange">
        <view class="custom-date">{{selectedQuarter}} ã€‰</view>
      </picker>
    </view>

    <!-- æ ¸å¿ƒæŒ‡æ ‡æ¦‚è§ˆ -->
    <view class="summary-section">
      <view class="section-title">ğŸª æ´»åŠ¨æ¦‚å†µ</view>
      <view class="summary-grid">
        <stat-card 
          value="{{summary.totalActivities}}" 
          label="æ€»æ´»åŠ¨æ•°" 
          icon="ğŸª"
          variant="primary"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.totalParticipants}}" 
          label="æ€»å‚ä¸äººæ¬¡" 
          icon="ğŸ‘¥"
          variant="success"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.avgParticipationRate}}%" 
          label="å¹³å‡å‚ä¸ç‡" 
          icon="ğŸ“ˆ"
          variant="warning"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.mostPopularActivity}}" 
          label="çƒ­é—¨æ´»åŠ¨" 
          icon="ğŸ”¥"
          variant="info"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
      </view>
    </view>

    <!-- å‚ä¸è¶‹åŠ¿ -->
    <chart-container 
      title="å‚ä¸äººæ•°è¶‹åŠ¿"
      loading="{{loading}}"
      empty="{{participationTrend.length===0}}"
      error="{{error}}"
      height="300"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{participationTrend.length > 0}}" class="trend-chart">
          <view class="trend-line-container">
            <view class="trend-line-body">
              <block wx:for="{{participationTrend}}" wx:key="date">
                <view class="trend-point" style="bottom: {{item.percentage}}%">
                  <view class="point-dot"></view>
                  <view class="point-label">{{item.date}}</view>
                  <view class="point-value">{{item.participants}}</view>
                </view>
              </block>
            </view>
          </view>
        </view>
      </view>
    </chart-container>

    <!-- æ´»åŠ¨ç±»å‹åˆ†å¸ƒ -->
    <chart-container 
      title="æ´»åŠ¨ç±»å‹åˆ†å¸ƒ"
      loading="{{loading}}"
      empty="{{activitiesByType.length===0}}"
      error="{{error}}"
      height="320"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{activitiesByType.length > 0}}" class="type-distribution">
          <block wx:for="{{activitiesByType}}" wx:key="type">
            <view class="type-item">
              <view class="type-header">
                <view class="type-icon" style="background-color: {{item.color}}">{{item.icon}}</view>
                <view class="type-info">
                  <text class="type-name">{{item.type}}</text>
                  <text class="type-count">{{item.count}} æ¬¡æ´»åŠ¨</text>
                </view>
              </view>
              <view class="type-progress">
                <view class="progress-bar">
                  <view class="progress-fill" style="width: {{item.percentage}}%; background-color: {{item.color}}"></view>
                </view>
                <text class="progress-text">{{item.percentage}}%</text>
              </view>
            </view>
          </block>
        </view>
      </view>
    </chart-container>

    <!-- å‚ä¸è€…å¹´é¾„åˆ†å¸ƒ -->
    <chart-container 
      title="å‚ä¸è€…å¹´é¾„åˆ†å¸ƒ"
      loading="{{loading}}"
      empty="{{participantsByAge.length===0}}"
      error="{{error}}"
      height="280"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{participantsByAge.length > 0}}" class="age-chart">
          <view class="age-bars">
            <block wx:for="{{participantsByAge}}" wx:key="ageRange">
              <view class="age-bar-item">
                <view class="age-bar" style="height: {{item.percentage}}%">
                  <view class="age-bar-fill"></view>
                  <text class="age-bar-value">{{item.count}}</text>
                </view>
                <view class="age-label">{{item.ageRange}}</view>
              </view>
            </block>
          </view>
        </view>
      </view>
    </chart-container>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <error-view
      wx:if="{{error}}"
      show="{{true}}"
      error="{{error}}"
      retry-text="é‡è¯•"
      variant="compact"
      bindretry="onRefresh">
    </error-view>
  </view>
</view>