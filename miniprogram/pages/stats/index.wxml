<view class="page">
  <!-- å¯¼èˆªå¤´éƒ¨ -->
  <view class="nav-header">
    <view class="brand">ğŸ“Š æ•°æ®ç»Ÿè®¡</view>
    <view class="nav-actions">
      <text wx:if="{{notifications>0}}" class="nav-notif">{{notifications}}</text>
      <text bindtap="onRefresh" class="nav-refresh">ğŸ”„</text>
      <text wx:if="{{canView}}" bindtap="onExport" class="nav-export">ğŸ“¤</text>
    </view>
  </view>

  <!-- ç”¨æˆ·çŠ¶æ€åŒº -->
  <view class="user-status">
    <view class="status-left">
      <text class="role-badge role-{{dashRole}}">{{dashRole === 'admin' ? 'ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜' : dashRole === 'social_worker' ? 'ğŸ‘©â€ğŸ’¼ ç¤¾å·¥' : 'ğŸ‘¤ ç”¨æˆ·'}}</text>
      <text class="perm-status">{{permText || 'æƒé™æ­£å¸¸ âœ…'}}</text>
    </view>
    <view class="status-right">
      <text class="time-info">{{currentTime}}</text>
    </view>
  </view>

  <!-- æ—¶é—´ç»´åº¦é€‰æ‹©å™¨ -->
  <view class="time-selector">
    <view class="time-tabs">
      <text bindtap="onTapDim" data-index="0" class="time-tab {{dimIndex===0?'active':''}}">ä»Šå¤©</text>
      <text bindtap="onTapDim" data-index="1" class="time-tab {{dimIndex===1?'active':''}}">æœ¬å‘¨</text>
      <text bindtap="onTapDim" data-index="2" class="time-tab {{dimIndex===2?'active':''}}">æœ¬æœˆ</text>
      <text bindtap="onTapDim" data-index="3" class="time-tab {{dimIndex===3?'active':''}}">æœ¬å¹´</text>
    </view>
    <picker wx:if="{{dimIndex>=2}}" mode="date" fields="{{dimIndex===2?'month':'year'}}" value="{{dimIndex===2?month:year}}" bindchange="{{dimIndex===2?'onMonthChange':'onYearChange'}}">
      <view class="custom-date">{{dimIndex===2?month:year}} ã€‰</view>
    </picker>
  </view>

  <view wx:if="{{!canView}}" class="no-perm">æ— æƒé™æŸ¥çœ‹ç»Ÿè®¡ï¼ˆä»…ç®¡ç†å‘˜/ç¤¾å·¥å¯è§ï¼‰ã€‚</view>

  <!-- KPI å…³é”®æŒ‡æ ‡ -->
  <view wx:if="{{canView}}" class="kpi-section">
    <view class="section-title">ğŸ¯ å…³é”®æŒ‡æ ‡æ¦‚è§ˆ</view>
    <scroll-view class="kpi-scroll" scroll-x="true" enhanced="true" show-scrollbar="false">
      <view class="kpi-container">
        <block wx:for="{{dashItems}}" wx:key="label">
          <view class="kpi-card gradient-{{index % 4}}">
            <view class="kpi-header">
              <text class="kpi-icon">{{item.icon}}</text>
              <view class="kpi-trend {{item.trend}}">
                <text class="trend-icon">{{item.trend === 'up' ? 'â†—' : item.trend === 'down' ? 'â†˜' : 'â†’'}}</text>
                <text class="trend-text">{{item.change || '+0%'}}</text>
              </view>
            </view>
            <view class="kpi-title">{{item.label}}</view>
            <view class="kpi-value">{{item.value}}</view>
            <view class="kpi-subtitle">{{item.subtitle || 'è¾ƒä¸ŠæœŸ'}}</view>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <!-- æ•°æ®åˆ†æåŒºåŸŸ -->
  <view wx:if="{{canView && !loading}}" class="analysis-section">
    <!-- å¿«é€Ÿç»Ÿè®¡ -->
    <view class="quick-stats">
      <view class="section-title">ğŸ“ˆ {{scopes[scopeIndex].label}}è¶‹åŠ¿åˆ†æ</view>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-label">æ€»è®¡</text>
          <text class="stat-value">{{total}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å‡å€¼</text>
          <text class="stat-value">{{avg}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å³°å€¼</text>
          <text class="stat-value">{{maxValue}}</text>
          <text class="stat-date">{{maxDate}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">ä½è°·</text>
          <text class="stat-value">{{minValue}}</text>
          <text class="stat-date">{{minDate}}</text>
        </view>
      </view>
    </view>

    <!-- è¶‹åŠ¿å›¾è¡¨ -->
    <view wx:if="{{items.length>0}}" class="chart-container">
      <view class="chart-header">
        <text class="chart-title">æ•°æ®è¶‹åŠ¿å›¾</text>
        <view class="chart-controls">
          <block wx:for="{{scopes}}" wx:key="key">
            <text bindtap="onTapScope" data-index="{{index}}" class="scope-tag {{scopeIndex===index?'active':''}}">{{item.label}}</text>
          </block>
        </view>
      </view>
      <view class="chart-body">
        <block wx:for="{{items}}" wx:key="date">
          <view class="chart-bar">
            <view class="bar-label">{{item.date}}</view>
            <view class="bar-track">
              <view class="bar-fill" style="height: {{item.perc}}%">
                <text class="bar-value">{{item.value}}</text>
              </view>
            </view>
          </view>
        </block>
      </view>
    </view>

    <view wx:if="{{items.length===0}}" class="empty-chart">
      <text class="empty-icon">ğŸ“Š</text>
      <text class="empty-text">æš‚æ— {{scopes[scopeIndex].label}}æ•°æ®</text>
      <text class="empty-hint">é€‰æ‹©å…¶ä»–æ—¶é—´èŒƒå›´è¯•è¯•</text>
    </view>
  </view>

  <!-- é”™è¯¯å’ŒåŠ è½½çŠ¶æ€ -->
  <view wx:if="{{error}}" class="error-state">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{error}}</text>
    <button class="error-retry" bindtap="onRefresh">é‡è¯•</button>
  </view>

  <view wx:if="{{loading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸“é¡¹åˆ†æå…¥å£ -->
  <view wx:if="{{canView}}" class="action-section">
    <view class="section-title">âš¡ ä¸“é¡¹åˆ†æ</view>
    <view class="action-grid">
      <view class="action-card" bindtap="onGo" data-url="/pages/services/index">
        <text class="action-icon">ğŸ“ˆ</text>
        <text class="action-title">æœåŠ¡æ•ˆæœåˆ†æ</text>
        <text class="action-desc">æœåŠ¡è´¨é‡è¯„ä¼°ä¸è¶‹åŠ¿</text>
      </view>
      <view class="action-card" bindtap="onGo" data-url="/pages/patients/index">
        <text class="action-icon">ğŸ </text>
        <text class="action-title">å…¥ä½æƒ…å†µåˆ†æ</text>
        <text class="action-desc">åºŠä½ä½¿ç”¨ç‡ä¸å‘¨è½¬</text>
      </view>
      <view class="action-card" bindtap="onGo" data-url="/pages/activities/index">
        <text class="action-icon">ğŸ¯</text>
        <text class="action-title">æ´»åŠ¨å‚ä¸åˆ†æ</text>
        <text class="action-desc">æ´»åŠ¨æ•ˆæœä¸æ»¡æ„åº¦</text>
      </view>
      <view class="action-card" bindtap="onGo" data-url="/pages/exports/index">
        <text class="action-icon">ğŸ“„</text>
        <text class="action-title">æŠ¥è¡¨å¯¼å‡º</text>
        <text class="action-desc">è‡ªå®šä¹‰æŠ¥è¡¨ç”Ÿæˆ</text>
      </view>
    </view>
  </view>

  <!-- æƒé™ç®¡ç†å…¥å£ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
  <view wx:if="{{canView && dashRole==='admin'}}" class="admin-section">
    <view class="section-title">ğŸ›¡ï¸ ç®¡ç†åŠŸèƒ½</view>
    <view class="admin-grid">
      <view class="admin-card" bindtap="onGo" data-url="/pages/permissions/apply">
        <text class="admin-icon">ğŸ”</text>
        <text class="admin-title">æƒé™å®¡æ‰¹</text>
        <text wx:if="{{pendingPermissions>0}}" class="admin-badge">{{pendingPermissions}}</text>
      </view>
      <view class="admin-card" bindtap="onGo" data-url="/pages/audits/index">
        <text class="admin-icon">ğŸ”</text>
        <text class="admin-title">å®¡è®¡æ—¥å¿—</text>
      </view>
    </view>
  </view>

  <view class="footer-hint">ä»…ç®¡ç†å‘˜/ç¤¾å·¥å¯è§ç»Ÿè®¡æ•°æ®</view>
</view>

