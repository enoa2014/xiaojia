<view class="page">
  <!-- å¯¼èˆªå¤´éƒ¨ -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">ğŸ“ˆ æœåŠ¡æ•ˆæœåˆ†æ</view>
    <view class="nav-actions">
      <text bindtap="onRefresh" class="nav-refresh">ğŸ”„</text>
    </view>
  </view>

  <!-- æƒé™æ£€æŸ¥ -->
  <view wx:if="{{!canView}}" class="no-permission">
    <empty-state
      show="{{true}}"
      icon="ğŸ”’"
      title="æƒé™ä¸è¶³"
      description="æœåŠ¡æ•ˆæœåˆ†æä»…ç®¡ç†å‘˜å’Œç¤¾å·¥å¯è§"
      variant="compact">
    </empty-state>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- æ—¶é—´é€‰æ‹©å™¨ -->
    <view class="time-selector">
      <view class="time-tabs">
        <text bindtap="onTimeRangeChange" data-range="week" class="time-tab {{timeRange==='week'?'active':''}}">æœ¬å‘¨</text>
        <text bindtap="onTimeRangeChange" data-range="month" class="time-tab {{timeRange==='month'?'active':''}}">æœ¬æœˆ</text>
        <text bindtap="onTimeRangeChange" data-range="quarter" class="time-tab {{timeRange==='quarter'?'active':''}}">æœ¬å­£</text>
      </view>
      
      <!-- æœˆä»½é€‰æ‹© -->
      <picker wx:if="{{timeRange==='month'}}" mode="date" fields="month" value="{{selectedMonth}}" bindchange="onMonthChange">
        <view class="custom-date">{{selectedMonth}} ã€‰</view>
      </picker>
      
      <!-- å­£åº¦é€‰æ‹© -->
      <picker wx:if="{{timeRange==='quarter'}}" mode="selector" value="{{selectedQuarter}}" bindchange="onQuarterChange">
        <view class="custom-date">{{selectedQuarter}} ã€‰</view>
      </picker>
    </view>

    <!-- æ ¸å¿ƒæŒ‡æ ‡æ¦‚è§ˆ -->
    <view class="summary-section">
      <view class="section-title">ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡</view>
      <view class="summary-grid">
        <stat-card 
          value="{{summary.totalServices}}" 
          label="æ€»æœåŠ¡é‡" 
          icon="ğŸ“‹"
          variant="primary"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.completedServices}}" 
          label="å®ŒæˆæœåŠ¡é‡" 
          icon="âœ…"
          variant="success"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.avgRating}}" 
          label="å¹³å‡è¯„åˆ†" 
          icon="â­"
          variant="warning"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.mostPopularType}}" 
          label="çƒ­é—¨æœåŠ¡" 
          icon="ğŸ”¥"
          variant="info"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
      </view>
    </view>

    <!-- æœåŠ¡ç±»å‹åˆ†å¸ƒ -->
    <chart-container 
      title="æœåŠ¡ç±»å‹åˆ†å¸ƒ"
      loading="{{loading}}"
      empty="{{servicesByType.length===0}}"
      error="{{error}}"
      height="320"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{servicesByType.length > 0}}" class="pie-chart-container">
          <block wx:for="{{servicesByType}}" wx:key="type">
            <view class="pie-item">
              <view class="pie-legend">
                <view class="pie-color" style="background-color: {{item.color}}"></view>
                <text class="pie-label">{{item.type}}</text>
              </view>
              <text class="pie-value">{{item.count}}</text>
              <text class="pie-percent">{{item.percentage}}%</text>
            </view>
          </block>
        </view>
      </view>
    </chart-container>

    <!-- å·¥ä½œäººå‘˜æ•ˆèƒ½ -->
    <chart-container 
      title="å·¥ä½œäººå‘˜æ•ˆèƒ½"
      loading="{{loading}}"
      empty="{{servicesByWorker.length===0}}"
      error="{{error}}"
      height="280"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{servicesByWorker.length > 0}}" class="bar-chart-horizontal">
          <block wx:for="{{servicesByWorker}}" wx:key="workerId">
            <view class="bar-item">
              <view class="bar-label">{{item.workerName}}</view>
              <view class="bar-container">
                <view class="bar-fill" style="width: {{item.percentage}}%; background: {{item.color}}"></view>
                <text class="bar-value">{{item.count}}</text>
              </view>
            </view>
          </block>
        </view>
      </view>
    </chart-container>

    <!-- è¯„åˆ†è¶‹åŠ¿ -->
    <chart-container 
      title="æœåŠ¡è¯„åˆ†è¶‹åŠ¿"
      loading="{{loading}}"
      empty="{{ratingTrend.length===0}}"
      error="{{error}}"
      height="280"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{ratingTrend.length > 0}}" class="line-chart">
          <view class="line-chart-body">
            <block wx:for="{{ratingTrend}}" wx:key="date">
              <view class="line-point">
                <view class="point-marker" style="bottom: {{item.percentage}}%"></view>
                <view class="point-label">{{item.date}}</view>
                <view class="point-value">{{item.rating}}</view>
              </view>
            </block>
          </view>
        </view>
      </view>
    </chart-container>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <error-view
      wx:if="{{error}}"
      show="{{true}}"
      error="{{error}}"
      retry-text="é‡è¯•"
      variant="compact"
      bindretry="onRefresh">
    </error-view>
  </view>
</view>