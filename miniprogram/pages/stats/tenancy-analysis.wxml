<view class="page">
  <!-- å¯¼èˆªå¤´éƒ¨ -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">ğŸ  å…¥ä½æƒ…å†µåˆ†æ</view>
    <view class="nav-actions">
      <text bindtap="onRefresh" class="nav-refresh">ğŸ”„</text>
    </view>
  </view>

  <!-- æƒé™æ£€æŸ¥ -->
  <view wx:if="{{!canView}}" class="no-permission">
    <empty-state
      show="{{true}}"
      icon="ğŸ”’"
      title="æƒé™ä¸è¶³"
      description="å…¥ä½æƒ…å†µåˆ†æä»…ç®¡ç†å‘˜å’Œç¤¾å·¥å¯è§"
      variant="compact">
    </empty-state>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- æ—¶é—´é€‰æ‹©å™¨ -->
    <view class="time-selector">
      <view class="time-tabs">
        <text bindtap="onTimeRangeChange" data-range="month" class="time-tab {{timeRange==='month'?'active':''}}">æœ¬æœˆ</text>
        <text bindtap="onTimeRangeChange" data-range="year" class="time-tab {{timeRange==='year'?'active':''}}">æœ¬å¹´</text>
      </view>
      
      <!-- æœˆä»½é€‰æ‹© -->
      <picker wx:if="{{timeRange==='month'}}" mode="date" fields="month" value="{{selectedMonth}}" bindchange="onMonthChange">
        <view class="custom-date">{{selectedMonth}} ã€‰</view>
      </picker>
      
      <!-- å¹´ä»½é€‰æ‹© -->
      <picker wx:if="{{timeRange==='year'}}" mode="date" fields="year" value="{{selectedYear}}" bindchange="onYearChange">
        <view class="custom-date">{{selectedYear}} ã€‰</view>
      </picker>
    </view>

    <!-- æ ¸å¿ƒæŒ‡æ ‡æ¦‚è§ˆ -->
    <view class="summary-section">
      <view class="section-title">ğŸ¨ å…¥ä½æ¦‚å†µ</view>
      <view class="summary-grid">
        <stat-card 
          value="{{summary.totalBeds}}" 
          label="æ€»åºŠä½æ•°" 
          icon="ğŸ›ï¸"
          variant="primary"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.occupiedBeds}}" 
          label="å·²å ç”¨åºŠä½" 
          icon="ğŸ‘¤"
          variant="success"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.occupancyRate}}%" 
          label="å…¥ä½ç‡" 
          icon="ğŸ“Š"
          variant="warning"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
        <stat-card 
          value="{{summary.avgStayDuration}}å¤©" 
          label="å¹³å‡å…¥ä½æ—¶é•¿" 
          icon="â°"
          variant="info"
          loading="{{loading}}"
          class="summary-card">
        </stat-card>
      </view>
    </view>

    <!-- å…¥ä½ç‡è¶‹åŠ¿ -->
    <chart-container 
      title="å…¥ä½ç‡è¶‹åŠ¿"
      loading="{{loading}}"
      empty="{{occupancyTrend.length===0}}"
      error="{{error}}"
      height="300"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{occupancyTrend.length > 0}}" class="trend-chart">
          <view class="trend-chart-body">
            <block wx:for="{{occupancyTrend}}" wx:key="date">
              <view class="trend-bar">
                <view class="bar-fill" style="height: {{item.percentage}}%" data-value="{{item.rate}}%"></view>
                <view class="bar-label">{{item.date}}</view>
              </view>
            </block>
          </view>
        </view>
      </view>
    </chart-container>

    <!-- æˆ¿é—´åˆ©ç”¨ç‡ -->
    <chart-container 
      title="æˆ¿é—´åˆ©ç”¨ç‡åˆ†å¸ƒ"
      loading="{{loading}}"
      empty="{{roomUtilization.length===0}}"
      error="{{error}}"
      height="320"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{roomUtilization.length > 0}}" class="room-grid">
          <block wx:for="{{roomUtilization}}" wx:key="roomId">
            <view class="room-item {{item.status}}">
              <view class="room-number">{{item.roomNumber}}</view>
              <view class="room-status">
                <text class="status-text">{{item.statusText}}</text>
                <text class="utilization-rate">{{item.utilizationRate}}%</text>
              </view>
            </view>
          </block>
        </view>
      </view>
    </chart-container>

    <!-- å…¥ä½æ—¶é•¿åˆ†å¸ƒ -->
    <chart-container 
      title="å…¥ä½æ—¶é•¿åˆ†å¸ƒ"
      loading="{{loading}}"
      empty="{{stayDurationDist.length===0}}"
      error="{{error}}"
      height="280"
      bindretry="onRefresh">
      
      <view class="chart-content">
        <view wx:if="{{stayDurationDist.length > 0}}" class="duration-chart">
          <block wx:for="{{stayDurationDist}}" wx:key="range">
            <view class="duration-item">
              <view class="duration-range">{{item.range}}</view>
              <view class="duration-bar">
                <view class="duration-fill" style="width: {{item.percentage}}%"></view>
                <text class="duration-count">{{item.count}}äºº</text>
              </view>
            </view>
          </block>
        </view>
      </view>
    </chart-container>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <error-view
      wx:if="{{error}}"
      show="{{true}}"
      error="{{error}}"
      retry-text="é‡è¯•"
      variant="compact"
      bindretry="onRefresh">
    </error-view>
  </view>
</view>