<view class="page">
  <!-- å¯¼èˆªå¤´éƒ¨ -->
  <view class="nav-header {{theme.headerBg}} full-bleed">
    <view class="brand">ğŸ“¤ å¯¼å‡ºä¸­å¿ƒ</view>
    <view class="nav-actions">
      <text wx:if="{{selectedTemplate}}" bindtap="onResetSelection" class="nav-reset">â†©ï¸</text>
    </view>
  </view>

  <!-- æƒé™æ£€æŸ¥ -->
  <view wx:if="{{!canView}}" class="no-permission">
    <empty-state
      show="{{true}}"
      icon="ğŸ”’"
      title="æƒé™ä¸è¶³"
      description="å¯¼å‡ºåŠŸèƒ½ä»…ç®¡ç†å‘˜å’Œç¤¾å·¥å¯ç”¨"
      variant="compact">
    </empty-state>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- æ¨¡æ¿é€‰æ‹©é˜¶æ®µ -->
    <view wx:if="{{!selectedTemplate}}" class="template-selection">
      <view class="section-title">ğŸ“‹ é€‰æ‹©å¯¼å‡ºæ¨¡æ¿</view>
      <view class="templates-grid">
        <block wx:for="{{templates}}" wx:key="id">
          <view class="template-card" bindtap="onSelectTemplate" data-id="{{item.id}}">
            <view class="template-icon">{{item.icon}}</view>
            <view class="template-info">
              <text class="template-name">{{item.name}}</text>
              <text class="template-desc">{{item.description}}</text>
            </view>
            <view class="template-arrow">ã€‰</view>
          </view>
        </block>
      </view>
    </view>

    <!-- å‚æ•°é…ç½®é˜¶æ®µ -->
    <view wx:if="{{selectedTemplate}}" class="export-config">
      <!-- é€‰ä¸­æ¨¡æ¿ä¿¡æ¯ -->
      <view class="selected-template">
        <view class="template-header">
          <view class="template-icon large">{{selectedTemplate.icon}}</view>
          <view class="template-details">
            <text class="template-name">{{selectedTemplate.name}}</text>
            <text class="template-desc">{{selectedTemplate.description}}</text>
          </view>
        </view>
      </view>

      <!-- å‚æ•°è¡¨å• -->
      <view class="params-form">
        <view class="section-title">âš™ï¸ å¯¼å‡ºå‚æ•°</view>
        
        <!-- æœˆä»½å‚æ•° -->
        <view wx:if="{{selectedTemplate.params.indexOf('month') > -1}}" class="form-field">
          <text class="field-label">é€‰æ‹©æœˆä»½</text>
          <picker mode="date" fields="month" value="{{formData.month}}" bindchange="onMonthChange">
            <view class="picker-input">
              <text class="picker-text">{{formData.month || 'è¯·é€‰æ‹©æœˆä»½'}}</text>
              <text class="picker-arrow">ã€‰</text>
            </view>
          </picker>
        </view>

        <!-- å­£åº¦å‚æ•° -->
        <view wx:if="{{selectedTemplate.params.indexOf('quarter') > -1}}" class="form-field">
          <text class="field-label">é€‰æ‹©å­£åº¦</text>
          <picker mode="selector" range="{{['2024-Q1', '2024-Q2', '2024-Q3', '2024-Q4', '2025-Q1', '2025-Q2', '2025-Q3', '2025-Q4']}}" value="0" bindchange="onQuarterChange">
            <view class="picker-input">
              <text class="picker-text">{{formData.quarter || 'è¯·é€‰æ‹©å­£åº¦'}}</text>
              <text class="picker-arrow">ã€‰</text>
            </view>
          </picker>
        </view>

        <!-- æ—¥æœŸèŒƒå›´å‚æ•° -->
        <view wx:if="{{selectedTemplate.params.indexOf('dateRange') > -1}}" class="form-field">
          <text class="field-label">æ—¥æœŸèŒƒå›´</text>
          <view class="date-range">
            <picker mode="date" value="{{formData.dateRange.start}}" bindchange="onStartDateChange">
              <view class="date-picker">
                <text class="date-text">{{formData.dateRange.start || 'å¼€å§‹æ—¥æœŸ'}}</text>
              </view>
            </picker>
            <text class="date-separator">è‡³</text>
            <picker mode="date" value="{{formData.dateRange.end}}" bindchange="onEndDateChange">
              <view class="date-picker">
                <text class="date-text">{{formData.dateRange.end || 'ç»“æŸæ—¥æœŸ'}}</text>
              </view>
            </picker>
          </view>
        </view>
      </view>

      <!-- åˆ›å»ºæŒ‰é’® -->
      <view class="action-section">
        <ui-button 
          ext-class="create-btn"
          variant="primary"
          size="md"
          loading="{{loading}}"
          text="{{loading ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºå¯¼å‡ºä»»åŠ¡'}}"
          bindtap="onCreateExport"></ui-button>
      </view>

      <!-- å½“å‰ä»»åŠ¡çŠ¶æ€ -->
      <view wx:if="{{currentTask.id}}" class="current-task">
        <view class="section-title">ğŸ”„ å½“å‰ä»»åŠ¡</view>
        <view class="task-card">
          <view class="task-info">
            <text class="task-id">ä»»åŠ¡ID: {{currentTask.id}}</text>
            <view class="task-status {{currentTask.status}}">
              <text class="status-text">{{currentTask.status === 'pending' ? 'ç­‰å¾…å¤„ç†' : currentTask.status === 'running' ? 'æ­£åœ¨å¤„ç†' : currentTask.status === 'done' ? 'å·²å®Œæˆ' : currentTask.status === 'failed' ? 'å¤±è´¥' : currentTask.status}}</text>
            </view>
          </view>
          
          <!-- è¿›åº¦æ¡ -->
          <view wx:if="{{currentTask.status === 'running'}}" class="progress-section">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{currentTask.progress}}%"></view>
            </view>
            <text class="progress-text">{{currentTask.progress}}%</text>
          </view>
          
          <!-- ä¸‹è½½é“¾æ¥ -->
          <view wx:if="{{currentTask.downloadUrl}}" class="download-section">
            <ui-button variant="secondary" size="sm" text="å¤åˆ¶ä¸‹è½½é“¾æ¥" bindtap="onDownload" data-url="{{currentTask.downloadUrl}}"></ui-button>
          </view>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="task-actions">
            <ui-button variant="secondary" size="sm" text="åˆ·æ–°çŠ¶æ€" bindtap="onCheckTask"></ui-button>
          </view>
        </view>
      </view>

      <!-- é”™è¯¯çŠ¶æ€ -->
      <error-view
        wx:if="{{error}}"
        show="{{true}}"
        error="{{error}}"
        retry-text="é‡è¯•"
        variant="compact"
        bindretry="onCreateExport">
      </error-view>
    </view>

    <!-- å¯¼å‡ºå†å² -->
    <view class="export-history">
      <view class="section-title">ğŸ“œ å¯¼å‡ºå†å²</view>
      
      <loading-skeleton wx:if="{{loading && exportHistory.length === 0}}" type="list" count="3"></loading-skeleton>
      
      <view wx:elif="{{exportHistory.length > 0}}" class="history-list">
        <block wx:for="{{exportHistory}}" wx:key="id">
          <view class="history-item">
            <view class="history-icon">{{item.templateIcon || 'ğŸ“„'}}</view>
            <view class="history-info">
              <text class="history-name">{{item.templateName}}</text>
              <text class="history-time">{{item.createdAt}}</text>
              <view class="history-meta">
                <text class="history-creator">{{item.createdBy}}</text>
                <text class="history-status {{item.status}}">{{item.statusText}}</text>
              </view>
            </view>
            <view class="history-actions">
              <ui-button wx:if="{{item.downloadUrl}}" variant="secondary" size="sm" text="ä¸‹è½½" bindtap="onDownload" data-url="{{item.downloadUrl}}"></ui-button>
            </view>
          </view>
        </block>
      </view>
      
      <empty-state
        wx:else
        show="{{true}}"
        icon="ğŸ“œ"
        title="æš‚æ— å¯¼å‡ºè®°å½•"
        description="è¿˜æ²¡æœ‰åˆ›å»ºè¿‡å¯¼å‡ºä»»åŠ¡"
        variant="compact">
      </empty-state>
    </view>
  </view>
</view>
